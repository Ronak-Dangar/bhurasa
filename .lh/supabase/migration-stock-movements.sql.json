{
    "sourceFile": "supabase/migration-stock-movements.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763368599982,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763368599982,
            "name": "Commit-0",
            "content": "-- Migration: Audit Trail Implementation\r\n-- Creates stock_movements ledger table with automatic trigger\r\n-- This enables full audit trail for all inventory changes\r\n\r\n-- 1. Create the new table for the audit trail\r\nCREATE TABLE IF NOT EXISTS public.stock_movements (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  item_id UUID NOT NULL REFERENCES public.inventory_items(id) ON DELETE CASCADE,\r\n  quantity_change NUMERIC NOT NULL,\r\n  reason TEXT, -- e.g., \"Production: Batch 24\", \"Bottling Run #123\", \"Order #1005\"\r\n  created_at TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n\r\n-- 2. Create the function that the trigger will run\r\nCREATE OR REPLACE FUNCTION public.handle_stock_movement()\r\nRETURNS TRIGGER AS $$\r\nBEGIN\r\n  -- Update the stock_level in the inventory_items table\r\n  UPDATE public.inventory_items\r\n  SET stock_level = stock_level + NEW.quantity_change,\r\n      updated_at = NOW()\r\n  WHERE id = NEW.item_id;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\n-- 3. Drop the trigger if it already exists (to prevent errors)\r\nDROP TRIGGER IF EXISTS on_stock_movement ON public.stock_movements;\r\n\r\n-- 4. Create the trigger that runs the function after an insert\r\nCREATE TRIGGER on_stock_movement\r\nAFTER INSERT ON public.stock_movements\r\nFOR EACH ROW\r\nEXECUTE FUNCTION public.handle_stock_movement();\r\n\r\n-- 5. Enable RLS on the new table\r\nALTER TABLE public.stock_movements ENABLE ROW LEVEL SECURITY;\r\n\r\n-- 6. Add RLS Policies (allow all for super admins)\r\nCREATE POLICY \"Allow full access to super admins\"\r\nON public.stock_movements\r\nFOR ALL\r\nUSING (\r\n  exists (\r\n    select 1 from public.profiles\r\n    where profiles.id = auth.uid() and profiles.role = 'super_admin'\r\n  )\r\n);\r\n\r\n-- 7. Create index for performance on common queries\r\nCREATE INDEX IF NOT EXISTS idx_stock_movements_item_id ON public.stock_movements(item_id);\r\nCREATE INDEX IF NOT EXISTS idx_stock_movements_created_at ON public.stock_movements(created_at DESC);\r\n\r\n-- Note: This migration is idempotent and safe to run multiple times\r\n"
        }
    ]
}