{
    "sourceFile": "supabase/fix-profiles-rls.sql",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763290624034,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763290624034,
            "name": "Commit-0",
            "content": "-- Fix infinite recursion in profiles RLS policies\r\n-- The issue is that the admin policy checks profiles table while querying profiles\r\n\r\n-- First, drop the problematic policies\r\nDROP POLICY IF EXISTS \"profiles self\" ON public.profiles;\r\nDROP POLICY IF EXISTS \"profiles admin\" ON public.profiles;\r\n\r\n-- Create fixed policies that don't cause recursion\r\n-- Policy 1: Users can always read their own profile\r\nCREATE POLICY \"profiles_select_own\"\r\n  ON public.profiles\r\n  FOR SELECT\r\n  USING (auth.uid() = id);\r\n\r\n-- Policy 2: Service role can do everything (this is what middleware uses)\r\n-- No need for a separate admin policy since service role bypasses RLS anyway\r\n\r\n-- Optional: If you want users to update their own profile\r\nCREATE POLICY \"profiles_update_own\"\r\n  ON public.profiles\r\n  FOR UPDATE\r\n  USING (auth.uid() = id)\r\n  WITH CHECK (auth.uid() = id);\r\n\r\n-- Optional: Allow inserts for new users (if using triggers)\r\nCREATE POLICY \"profiles_insert_own\"\r\n  ON public.profiles\r\n  FOR INSERT\r\n  WITH CHECK (auth.uid() = id);\r\n"
        }
    ]
}