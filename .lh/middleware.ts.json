{
    "sourceFile": "middleware.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 5,
            "patches": [
                {
                    "date": 1763151132660,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763151636711,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,109 @@\n+import { createServerClient } from \"@supabase/ssr\";\r\n+import { NextResponse, type NextRequest } from \"next/server\";\r\n+\r\n+export async function middleware(request: NextRequest) {\r\n+  let supabaseResponse = NextResponse.next({\r\n+    request,\r\n+  });\r\n+\r\n+  // Create client with anon key for auth check\r\n+  const supabase = createServerClient(\r\n+    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n+    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n+    {\r\n+      cookies: {\r\n+        getAll() {\r\n+          return request.cookies.getAll();\r\n+        },\r\n+        setAll(cookiesToSet) {\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            request.cookies.set(name, value)\r\n+          );\r\n+          supabaseResponse = NextResponse.next({\r\n+            request,\r\n+          });\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            supabaseResponse.cookies.set(name, value, options)\r\n+          );\r\n+        },\r\n+      },\r\n+    }\r\n+  );\r\n+\r\n+  // Create service role client for profile lookup (bypasses RLS)\r\n+  const supabaseAdmin = createServerClient(\r\n+    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n+    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n+    {\r\n+      cookies: {\r\n+        getAll() {\r\n+          return request.cookies.getAll();\r\n+        },\r\n+        setAll(cookiesToSet) {\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            request.cookies.set(name, value)\r\n+          );\r\n+        },\r\n+      },\r\n+    }\r\n+  );\r\n+\r\n+  // Get user session\r\n+  const {\r\n+    data: { user },\r\n+  } = await supabase.auth.getUser();\r\n+\r\n+  // Allow access to login page without authentication\r\n+  if (request.nextUrl.pathname === \"/login\") {\r\n+    // If user is already logged in, redirect to home\r\n+    if (user) {\r\n+      return NextResponse.redirect(new URL(\"/\", request.url));\r\n+    }\r\n+    return supabaseResponse;\r\n+  }\r\n+\r\n+  // Protect all other routes - require authentication\r\n+  if (!user) {\r\n+    return NextResponse.redirect(new URL(\"/login\", request.url));\r\n+  }\r\n+\r\n+  // Fetch user role from profiles table using service role to bypass RLS\r\n+  const { data: profile, error } = await supabaseAdmin\r\n+    .from(\"profiles\")\r\n+    .select(\"role\")\r\n+    .eq(\"id\", user.id)\r\n+    .single();\r\n+\r\n+  // Default to delivery_agent if profile doesn't exist or has no role\r\n+  // In production, you should create profiles for all users manually\r\n+  const userRole = profile?.role || \"delivery_agent\";\r\n+\r\n+  // Role-based access control\r\n+  const path = request.nextUrl.pathname;\r\n+\r\n+  // Admin-only routes: /, /finance, /production, /inventory, /orders\r\n+  const adminRoutes = [\"/\", \"/finance\", \"/production\", \"/inventory\", \"/orders\"];\r\n+  const isAdminRoute = adminRoutes.some(\r\n+    (route) => path === route || path.startsWith(`${route}/`)\r\n+  );\r\n+\r\n+  if (isAdminRoute && userRole !== \"super_admin\") {\r\n+    // Redirect delivery agents to their dashboard\r\n+    return NextResponse.redirect(new URL(\"/delivery\", request.url));\r\n+  }\r\n+\r\n+  return supabaseResponse;\r\n+}\r\n+\r\n+export const config = {\r\n+  matcher: [\r\n+    /*\r\n+     * Match all request paths except for the ones starting with:\r\n+     * - _next/static (static files)\r\n+     * - _next/image (image optimization files)\r\n+     * - favicon.ico (favicon file)\r\n+     * - public folder\r\n+     */\r\n+    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n+  ],\r\n+};\r\n"
                },
                {
                    "date": 1763289836649,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,8 +76,9 @@\n \r\n   // Default to delivery_agent if profile doesn't exist or has no role\r\n   // In production, you should create profiles for all users manually\r\n   const userRole = profile?.role || \"delivery_agent\";\r\n+  const\r\n \r\n   // Role-based access control\r\n   const path = request.nextUrl.pathname;\r\n \r\n@@ -106,92 +107,4 @@\n      */\r\n     \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n   ],\r\n };\r\n-import { createServerClient } from \"@supabase/ssr\";\r\n-import { NextResponse, type NextRequest } from \"next/server\";\r\n-\r\n-export async function middleware(request: NextRequest) {\r\n-  let supabaseResponse = NextResponse.next({\r\n-    request,\r\n-  });\r\n-\r\n-  const supabase = createServerClient(\r\n-    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n-    {\r\n-      cookies: {\r\n-        getAll() {\r\n-          return request.cookies.getAll();\r\n-        },\r\n-        setAll(cookiesToSet) {\r\n-          cookiesToSet.forEach(({ name, value, options }) =>\r\n-            request.cookies.set(name, value)\r\n-          );\r\n-          supabaseResponse = NextResponse.next({\r\n-            request,\r\n-          });\r\n-          cookiesToSet.forEach(({ name, value, options }) =>\r\n-            supabaseResponse.cookies.set(name, value, options)\r\n-          );\r\n-        },\r\n-      },\r\n-    }\r\n-  );\r\n-\r\n-  // Get user session\r\n-  const {\r\n-    data: { user },\r\n-  } = await supabase.auth.getUser();\r\n-\r\n-  // Allow access to login page without authentication\r\n-  if (request.nextUrl.pathname === \"/login\") {\r\n-    // If user is already logged in, redirect to home\r\n-    if (user) {\r\n-      return NextResponse.redirect(new URL(\"/\", request.url));\r\n-    }\r\n-    return supabaseResponse;\r\n-  }\r\n-\r\n-  // Protect all other routes - require authentication\r\n-  if (!user) {\r\n-    return NextResponse.redirect(new URL(\"/login\", request.url));\r\n-  }\r\n-\r\n-  // Fetch user role from profiles table\r\n-  const { data: profile } = await supabase\r\n-    .from(\"profiles\")\r\n-    .select(\"role\")\r\n-    .eq(\"id\", user.id)\r\n-    .single();\r\n-\r\n-  const userRole = profile?.role || \"delivery_agent\";\r\n-\r\n-  // Role-based access control\r\n-  const path = request.nextUrl.pathname;\r\n-\r\n-  // Admin-only routes: /, /finance, /production, /inventory, /orders\r\n-  const adminRoutes = [\"/\", \"/finance\", \"/production\", \"/inventory\", \"/orders\"];\r\n-  const isAdminRoute = adminRoutes.some(\r\n-    (route) => path === route || path.startsWith(`${route}/`)\r\n-  );\r\n-\r\n-  if (isAdminRoute && userRole !== \"super_admin\") {\r\n-    // Redirect delivery agents to their dashboard\r\n-    return NextResponse.redirect(new URL(\"/delivery\", request.url));\r\n-  }\r\n-\r\n-  return supabaseResponse;\r\n-}\r\n-\r\n-export const config = {\r\n-  matcher: [\r\n-    /*\r\n-     * Match all request paths except for the ones starting with:\r\n-     * - _next/static (static files)\r\n-     * - _next/image (image optimization files)\r\n-     * - favicon.ico (favicon file)\r\n-     * - public folder\r\n-     */\r\n-    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n-  ],\r\n-};\r\n"
                },
                {
                    "date": 1763289846431,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -0,0 +1,110 @@\n+import { createServerClient } from \"@supabase/ssr\";\r\n+import { NextResponse, type NextRequest } from \"next/server\";\r\n+\r\n+export async function middleware(request: NextRequest) {\r\n+  let supabaseResponse = NextResponse.next({\r\n+    request,\r\n+  });\r\n+\r\n+  // Create client with anon key for auth check\r\n+  const supabase = createServerClient(\r\n+    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n+    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n+    {\r\n+      cookies: {\r\n+        getAll() {\r\n+          return request.cookies.getAll();\r\n+        },\r\n+        setAll(cookiesToSet) {\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            request.cookies.set(name, value)\r\n+          );\r\n+          supabaseResponse = NextResponse.next({\r\n+            request,\r\n+          });\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            supabaseResponse.cookies.set(name, value, options)\r\n+          );\r\n+        },\r\n+      },\r\n+    }\r\n+  );\r\n+\r\n+  // Create service role client for profile lookup (bypasses RLS)\r\n+  const supabaseAdmin = createServerClient(\r\n+    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n+    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n+    {\r\n+      cookies: {\r\n+        getAll() {\r\n+          return request.cookies.getAll();\r\n+        },\r\n+        setAll(cookiesToSet) {\r\n+          cookiesToSet.forEach(({ name, value, options }) =>\r\n+            request.cookies.set(name, value)\r\n+          );\r\n+        },\r\n+      },\r\n+    }\r\n+  );\r\n+\r\n+  // Get user session\r\n+  const {\r\n+    data: { user },\r\n+  } = await supabase.auth.getUser();\r\n+\r\n+  // Allow access to login page without authentication\r\n+  if (request.nextUrl.pathname === \"/login\") {\r\n+    // If user is already logged in, redirect to home\r\n+    if (user) {\r\n+      return NextResponse.redirect(new URL(\"/\", request.url));\r\n+    }\r\n+    return supabaseResponse;\r\n+  }\r\n+\r\n+  // Protect all other routes - require authentication\r\n+  if (!user) {\r\n+    return NextResponse.redirect(new URL(\"/login\", request.url));\r\n+  }\r\n+\r\n+  // Fetch user role from profiles table using service role to bypass RLS\r\n+  const { data: profile, error } = await supabaseAdmin\r\n+    .from(\"profiles\")\r\n+    .select(\"role\")\r\n+    .eq(\"id\", user.id)\r\n+    .single();\r\n+\r\n+  // Default to delivery_agent if profile doesn't exist or has no role\r\n+  // In production, you should create profiles for all users manually\r\n+  const userRole = profile?.role || \"delivery_agent\";\r\n+  console.log\r\n+\r\n+  // Role-based access control\r\n+  const path = request.nextUrl.pathname;\r\n+\r\n+  // Admin-only routes: /, /finance, /production, /inventory, /orders\r\n+  const adminRoutes = [\"/\", \"/finance\", \"/production\", \"/inventory\", \"/orders\"];\r\n+  const isAdminRoute = adminRoutes.some(\r\n+    (route) => path === route || path.startsWith(`${route}/`)\r\n+  );\r\n+\r\n+  if (isAdminRoute && userRole !== \"super_admin\") {\r\n+    // Redirect delivery agents to their dashboard\r\n+    return NextResponse.redirect(new URL(\"/delivery\", request.url));\r\n+  }\r\n+\r\n+  return supabaseResponse;\r\n+}\r\n+\r\n+export const config = {\r\n+  matcher: [\r\n+    /*\r\n+     * Match all request paths except for the ones starting with:\r\n+     * - _next/static (static files)\r\n+     * - _next/image (image optimization files)\r\n+     * - favicon.ico (favicon file)\r\n+     * - public folder\r\n+     */\r\n+    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n+  ],\r\n+};\r\n"
                },
                {
                    "date": 1763290204061,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -76,9 +76,8 @@\n \r\n   // Default to delivery_agent if profile doesn't exist or has no role\r\n   // In production, you should create profiles for all users manually\r\n   const userRole = profile?.role || \"delivery_agent\";\r\n-  console.log\r\n \r\n   // Role-based access control\r\n   const path = request.nextUrl.pathname;\r\n \r\n@@ -107,114 +106,4 @@\n      */\r\n     \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n   ],\r\n };\r\n-import { createServerClient } from \"@supabase/ssr\";\r\n-import { NextResponse, type NextRequest } from \"next/server\";\r\n-\r\n-export async function middleware(request: NextRequest) {\r\n-  let supabaseResponse = NextResponse.next({\r\n-    request,\r\n-  });\r\n-\r\n-  // Create client with anon key for auth check\r\n-  const supabase = createServerClient(\r\n-    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n-    {\r\n-      cookies: {\r\n-        getAll() {\r\n-          return request.cookies.getAll();\r\n-        },\r\n-        setAll(cookiesToSet) {\r\n-          cookiesToSet.forEach(({ name, value, options }) =>\r\n-            request.cookies.set(name, value)\r\n-          );\r\n-          supabaseResponse = NextResponse.next({\r\n-            request,\r\n-          });\r\n-          cookiesToSet.forEach(({ name, value, options }) =>\r\n-            supabaseResponse.cookies.set(name, value, options)\r\n-          );\r\n-        },\r\n-      },\r\n-    }\r\n-  );\r\n-\r\n-  // Create service role client for profile lookup (bypasses RLS)\r\n-  const supabaseAdmin = createServerClient(\r\n-    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n-    process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n-    {\r\n-      cookies: {\r\n-        getAll() {\r\n-          return request.cookies.getAll();\r\n-        },\r\n-        setAll(cookiesToSet) {\r\n-          cookiesToSet.forEach(({ name, value, options }) =>\r\n-            request.cookies.set(name, value)\r\n-          );\r\n-        },\r\n-      },\r\n-    }\r\n-  );\r\n-\r\n-  // Get user session\r\n-  const {\r\n-    data: { user },\r\n-  } = await supabase.auth.getUser();\r\n-\r\n-  // Allow access to login page without authentication\r\n-  if (request.nextUrl.pathname === \"/login\") {\r\n-    // If user is already logged in, redirect to home\r\n-    if (user) {\r\n-      return NextResponse.redirect(new URL(\"/\", request.url));\r\n-    }\r\n-    return supabaseResponse;\r\n-  }\r\n-\r\n-  // Protect all other routes - require authentication\r\n-  if (!user) {\r\n-    return NextResponse.redirect(new URL(\"/login\", request.url));\r\n-  }\r\n-\r\n-  // Fetch user role from profiles table using service role to bypass RLS\r\n-  const { data: profile, error } = await supabaseAdmin\r\n-    .from(\"profiles\")\r\n-    .select(\"role\")\r\n-    .eq(\"id\", user.id)\r\n-    .single();\r\n-\r\n-  // Default to delivery_agent if profile doesn't exist or has no role\r\n-  // In production, you should create profiles for all users manually\r\n-  const userRole = profile?.role || \"delivery_agent\";\r\n-  const\r\n-\r\n-  // Role-based access control\r\n-  const path = request.nextUrl.pathname;\r\n-\r\n-  // Admin-only routes: /, /finance, /production, /inventory, /orders\r\n-  const adminRoutes = [\"/\", \"/finance\", \"/production\", \"/inventory\", \"/orders\"];\r\n-  const isAdminRoute = adminRoutes.some(\r\n-    (route) => path === route || path.startsWith(`${route}/`)\r\n-  );\r\n-\r\n-  if (isAdminRoute && userRole !== \"super_admin\") {\r\n-    // Redirect delivery agents to their dashboard\r\n-    return NextResponse.redirect(new URL(\"/delivery\", request.url));\r\n-  }\r\n-\r\n-  return supabaseResponse;\r\n-}\r\n-\r\n-export const config = {\r\n-  matcher: [\r\n-    /*\r\n-     * Match all request paths except for the ones starting with:\r\n-     * - _next/static (static files)\r\n-     * - _next/image (image optimization files)\r\n-     * - favicon.ico (favicon file)\r\n-     * - public folder\r\n-     */\r\n-    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n-  ],\r\n-};\r\n"
                },
                {
                    "date": 1763290209791,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -75,9 +75,8 @@\n   .single();\r\n \r\n console.log(\"profile\", profile, \"error\", error, \"status\", status);\r\n \r\n-\r\n   // Default to delivery_agent if profile doesn't exist or has no role\r\n   // In production, you should create profiles for all users manually\r\n   const userRole = profile?.role || \"delivery_agent\";\r\n \r\n"
                }
            ],
            "date": 1763151132660,
            "name": "Commit-0",
            "content": "import { createServerClient } from \"@supabase/ssr\";\r\nimport { NextResponse, type NextRequest } from \"next/server\";\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  let supabaseResponse = NextResponse.next({\r\n    request,\r\n  });\r\n\r\n  const supabase = createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return request.cookies.getAll();\r\n        },\r\n        setAll(cookiesToSet) {\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            request.cookies.set(name, value)\r\n          );\r\n          supabaseResponse = NextResponse.next({\r\n            request,\r\n          });\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            supabaseResponse.cookies.set(name, value, options)\r\n          );\r\n        },\r\n      },\r\n    }\r\n  );\r\n\r\n  // Get user session\r\n  const {\r\n    data: { user },\r\n  } = await supabase.auth.getUser();\r\n\r\n  // Allow access to login page without authentication\r\n  if (request.nextUrl.pathname === \"/login\") {\r\n    // If user is already logged in, redirect to home\r\n    if (user) {\r\n      return NextResponse.redirect(new URL(\"/\", request.url));\r\n    }\r\n    return supabaseResponse;\r\n  }\r\n\r\n  // Protect all other routes - require authentication\r\n  if (!user) {\r\n    return NextResponse.redirect(new URL(\"/login\", request.url));\r\n  }\r\n\r\n  // Fetch user role from profiles table\r\n  const { data: profile } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"role\")\r\n    .eq(\"id\", user.id)\r\n    .single();\r\n\r\n  const userRole = profile?.role || \"delivery_agent\";\r\n\r\n  // Role-based access control\r\n  const path = request.nextUrl.pathname;\r\n\r\n  // Admin-only routes: /, /finance, /production, /inventory, /orders\r\n  const adminRoutes = [\"/\", \"/finance\", \"/production\", \"/inventory\", \"/orders\"];\r\n  const isAdminRoute = adminRoutes.some(\r\n    (route) => path === route || path.startsWith(`${route}/`)\r\n  );\r\n\r\n  if (isAdminRoute && userRole !== \"super_admin\") {\r\n    // Redirect delivery agents to their dashboard\r\n    return NextResponse.redirect(new URL(\"/delivery\", request.url));\r\n  }\r\n\r\n  return supabaseResponse;\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except for the ones starting with:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     * - public folder\r\n     */\r\n    \"/((?!_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n  ],\r\n};\r\n"
        }
    ]
}