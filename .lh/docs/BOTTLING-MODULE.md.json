{
    "sourceFile": "docs/BOTTLING-MODULE.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763364745315,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763364745315,
            "name": "Commit-0",
            "content": "# Bottling Module Documentation\r\n\r\n## Executive Summary\r\n\r\nThe Bottling Module is a **standalone, independent process** that solves the \"partial batch problem\" by decoupling packaging from production. This enables commingled bulk oil inventory and flexible multi-SKU packaging in single runs.\r\n\r\n## Problem Statement\r\n\r\n**Old Model (Bottling as Phase 3 of Production):**\r\n- âŒ Each production batch had to be bottled entirely\r\n- âŒ Couldn't mix SKUs in one bottling operation\r\n- âŒ Batch-specific bottling created inventory tracking complexity\r\n- âŒ \"Partial batch\" problem: What if you only need 30L but batch has 100L?\r\n\r\n**New Model (Decoupled Bottling):**\r\n- âœ… All bulk oil goes into one commingled inventory pool\r\n- âœ… Bottle any quantity in any SKU mix (1L, 5L, 15L)\r\n- âœ… Not tied to specific production batches\r\n- âœ… Production ends cleanly at \"bulk oil produced\"\r\n\r\n## Architecture\r\n\r\n### Process Flow\r\n\r\n```\r\nProduction Workflow:\r\nGroundnuts â†’ [Dehusking] â†’ Peanuts â†’ [Pressing] â†’ Bulk Oil âœ“ COMPLETE\r\n                                                      â†“\r\n                                           (Commingled Inventory)\r\n                                                      â†“\r\nBottling Workflow:\r\nBulk Oil â†’ [Bottling Run] â†’ Multiple Finished SKUs (1L/5L/15L)\r\n```\r\n\r\n### Key Concepts\r\n\r\n**1. Commingled Bulk Oil**\r\n- All production batches contribute to a single \"Bulk Oil\" inventory item\r\n- Batch traceability ends at bulk oil stage\r\n- Simplifies inventory management\r\n\r\n**2. Multi-SKU Bottling Runs**\r\n- One operation can package multiple SKU types\r\n- Example: 50Ã—1L + 10Ã—5L + 2Ã—15L in a single run\r\n- Flexible quantities based on demand\r\n\r\n**3. Decoupled Operations**\r\n- Production module: `/production` (Dehusking â†’ Pressing â†’ Completed)\r\n- Bottling module: `/bottling` (Bulk Oil â†’ Finished Goods)\r\n- Independent navigation and workflows\r\n\r\n## User Interface\r\n\r\n### Page: `/bottling`\r\n\r\n**Layout:**\r\n```\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚ Bottling Module                             â”‚\r\nâ”‚ Convert bulk oil into finished goods        â”‚\r\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\r\nâ”‚                                             â”‚\r\nâ”‚ â”Œâ”€ Start New Bottling Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚\r\nâ”‚ â”‚                                          â”‚â”‚\r\nâ”‚ â”‚ Bottling Lines:                [+ Add]  â”‚â”‚\r\nâ”‚ â”‚                                          â”‚â”‚\r\nâ”‚ â”‚ 1. [1L Bottle â–¼] [50____] = 50 L  [ðŸ—‘] â”‚â”‚\r\nâ”‚ â”‚ 2. [5L Tin    â–¼] [10____] = 50 L  [ðŸ—‘] â”‚â”‚\r\nâ”‚ â”‚ 3. [15L Tin   â–¼] [2_____] = 30 L  [ðŸ—‘] â”‚â”‚\r\nâ”‚ â”‚                                          â”‚â”‚\r\nâ”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚\r\nâ”‚ â”‚ â”‚ Total Bulk Oil Required: 130.0 L   â”‚ â”‚â”‚\r\nâ”‚ â”‚ â”‚ Will be deducted from inventory    â”‚ â”‚â”‚\r\nâ”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚\r\nâ”‚ â”‚                                          â”‚â”‚\r\nâ”‚ â”‚           [Start Bottling Run]          â”‚â”‚\r\nâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n```\r\n\r\n**Features:**\r\n- **Repeater Field**: Add/remove bottling lines dynamically\r\n- **SKU Dropdown**: Select from 1L Bottle, 5L Tin, 15L Tin\r\n- **Quantity Input**: Number of units to bottle\r\n- **Auto Calculation**: Shows liters per line (SKU size Ã— quantity)\r\n- **Total Summary**: Real-time total bulk oil required\r\n- **Validation**: Minimum 1 line, all quantities > 0\r\n- **Success Message**: Shows total liters consumed after completion\r\n\r\n## ERP Transaction Logic\r\n\r\n### Server Action: `createBottlingRun()`\r\n\r\n**File:** `app/actions/bottling.ts`\r\n\r\n**Algorithm:**\r\n```typescript\r\n1. Parse bottling lines from form data\r\n2. Fetch all inventory items\r\n3. Initialize total_liters_consumed = 0\r\n\r\n4. For each bottling line:\r\n   a. Calculate liters: parseFloat(sku.split('L')[0]) Ã— quantity\r\n   b. Add to total_liters_consumed\r\n   c. Find empty container inventory item (fuzzy match)\r\n   d. Find finished good inventory item (fuzzy match)\r\n   e. Validate sufficient empty containers\r\n   f. Queue update: Decrement empty containers by quantity\r\n   g. Queue update: Increment finished goods by quantity\r\n\r\n5. Validate sufficient bulk oil (stock_level >= total_liters_consumed)\r\n\r\n6. Execute all queued container updates\r\n\r\n7. Final transaction: Decrement bulk oil by total_liters_consumed\r\n\r\n8. Revalidate paths: /inventory, /bottling\r\n\r\n9. Return success with message: \"Consumed X.X L of bulk oil\"\r\n```\r\n\r\n### Inventory Item Mapping\r\n\r\n**Fuzzy Matching Logic:**\r\n```typescript\r\nconst findItem = (name: string) =>\r\n  inventoryItems.find((item: any) =>\r\n    item.item_name.toLowerCase().includes(name.toLowerCase())\r\n  );\r\n```\r\n\r\n**SKU â†’ Inventory Items:**\r\n| SKU | Empty Container Search | Finished Good Search |\r\n|-----|----------------------|---------------------|\r\n| 1L Bottle | \"1l bottle\" / \"empty 1l\" | \"1l bottle oil\" / \"finished 1l\" |\r\n| 5L Tin | \"5l tin\" / \"empty 5l\" | \"5l tin oil\" / \"finished 5l\" |\r\n| 15L Tin | \"15l tin\" / \"empty 15l\" | \"15l tin oil\" / \"finished 15l\" |\r\n\r\n### Transaction Example\r\n\r\n**Bottling Run:**\r\n- 50 Ã— 1L Bottle\r\n- 10 Ã— 5L Tin\r\n- 2 Ã— 15L Tin\r\n\r\n**Inventory Updates:**\r\n```\r\nBefore:\r\n- Bulk Oil: 500 L\r\n- Empty 1L Bottle: 300 units\r\n- Empty 5L Tin: 100 units\r\n- Empty 15L Tin: 50 units\r\n- Finished 1L Oil: 100 units\r\n- Finished 5L Oil: 20 units\r\n- Finished 15L Oil: 10 units\r\n\r\nCalculations:\r\n- Line 1: 50 Ã— 1L = 50 L\r\n- Line 2: 10 Ã— 5L = 50 L\r\n- Line 3: 2 Ã— 15L = 30 L\r\n- Total: 130 L\r\n\r\nAfter:\r\n- Bulk Oil: 370 L (-130)\r\n- Empty 1L Bottle: 250 units (-50)\r\n- Empty 5L Tin: 90 units (-10)\r\n- Empty 15L Tin: 48 units (-2)\r\n- Finished 1L Oil: 150 units (+50)\r\n- Finished 5L Oil: 30 units (+10)\r\n- Finished 15L Oil: 12 units (+2)\r\n```\r\n\r\n## Error Handling\r\n\r\n### Validation Checks\r\n\r\n**1. Empty Lines Check**\r\n```typescript\r\nif (!lines || lines.length === 0) {\r\n  return { success: false, error: \"No bottling lines provided\" };\r\n}\r\n```\r\n\r\n**2. Invalid Quantity Check**\r\n```typescript\r\nconst hasInvalidQuantity = lines.some((line) => line.quantity <= 0);\r\nif (hasInvalidQuantity) {\r\n  return { success: false, error: \"All quantities must be greater than 0\" };\r\n}\r\n```\r\n\r\n**3. Inventory Item Not Found**\r\n```typescript\r\nif (!bulkOil) {\r\n  return { success: false, error: \"Bulk oil inventory item not found\" };\r\n}\r\nif (!emptyContainer) {\r\n  return { success: false, error: `Empty container not found for ${sku}` };\r\n}\r\n```\r\n\r\n**4. Insufficient Stock**\r\n```typescript\r\nif (emptyContainer.stock_level < line.quantity) {\r\n  return {\r\n    success: false,\r\n    error: `Insufficient empty containers for ${sku}. \r\n            Available: ${emptyContainer.stock_level}, \r\n            Required: ${line.quantity}`\r\n  };\r\n}\r\n\r\nif (bulkOil.stock_level < totalLitersConsumed) {\r\n  return {\r\n    success: false,\r\n    error: `Insufficient bulk oil. \r\n            Available: ${bulkOil.stock_level}L, \r\n            Required: ${totalLitersConsumed}L`\r\n  };\r\n}\r\n```\r\n\r\n### User-Facing Error Messages\r\n\r\n**Example 1: Not Enough Bulk Oil**\r\n```\r\nâŒ Insufficient bulk oil. Available: 85.5L, Required: 130.0L\r\n```\r\n\r\n**Example 2: Not Enough Empty Containers**\r\n```\r\nâŒ Insufficient empty containers for 5L Tin. Available: 8, Required: 10\r\n```\r\n\r\n**Example 3: Success**\r\n```\r\nâœ… Bottling run completed! Consumed 130.0L of bulk oil.\r\n```\r\n\r\n## Code Implementation\r\n\r\n### Client Component\r\n\r\n**File:** `app/bottling/page.tsx`\r\n\r\n**Key State:**\r\n```typescript\r\ntype BottlingLine = {\r\n  id: number;\r\n  sku: string;\r\n  quantity: number;\r\n};\r\n\r\nconst [lines, setLines] = useState<BottlingLine[]>([\r\n  { id: 1, sku: \"1L Bottle\", quantity: 0 },\r\n]);\r\nconst [nextId, setNextId] = useState(2);\r\n```\r\n\r\n**Key Functions:**\r\n```typescript\r\n// Add new line\r\nconst addLine = () => {\r\n  setLines([...lines, { id: nextId, sku: \"1L Bottle\", quantity: 0 }]);\r\n  setNextId(nextId + 1);\r\n};\r\n\r\n// Remove line (minimum 1 enforced)\r\nconst removeLine = (id: number) => {\r\n  if (lines.length > 1) {\r\n    setLines(lines.filter((line) => line.id !== id));\r\n  }\r\n};\r\n\r\n// Update line field\r\nconst updateLine = (id: number, field: \"sku\" | \"quantity\", value: any) => {\r\n  setLines(lines.map((line) =>\r\n    line.id === id ? { ...line, [field]: value } : line\r\n  ));\r\n};\r\n\r\n// Calculate total liters\r\nconst calculateTotalLiters = () => {\r\n  return lines.reduce((total, line) => {\r\n    const litersPerUnit = parseFloat(line.sku.split(\"L\")[0]) || 0;\r\n    return total + litersPerUnit * line.quantity;\r\n  }, 0);\r\n};\r\n```\r\n\r\n### Server Action\r\n\r\n**File:** `app/actions/bottling.ts`\r\n\r\n**Full Implementation:**\r\n```typescript\r\nexport async function createBottlingRun(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  try {\r\n    const linesJson = formData.get(\"bottling_lines\") as string;\r\n    const lines: BottlingLine[] = JSON.parse(linesJson);\r\n\r\n    // Get inventory items\r\n    const { data: inventoryItems } = await supabase\r\n      .from(\"inventory_items\")\r\n      .select(\"id, item_name, stock_level\");\r\n\r\n    const findItem = (name: string) =>\r\n      inventoryItems.find((item: any) =>\r\n        item.item_name.toLowerCase().includes(name.toLowerCase())\r\n      );\r\n\r\n    const bulkOil = findItem(\"bulk oil\") || findItem(\"oil\");\r\n    let totalLitersConsumed = 0;\r\n    const updates: { itemId: string; delta: number }[] = [];\r\n\r\n    // Process each line\r\n    for (const line of lines) {\r\n      const litersPerUnit = parseFloat(line.sku.split(\"L\")[0]) || 0;\r\n      totalLitersConsumed += litersPerUnit * line.quantity;\r\n\r\n      // Find inventory items based on SKU\r\n      let emptyContainer, finishedGood;\r\n      if (line.sku === \"1L Bottle\") {\r\n        emptyContainer = findItem(\"1l bottle\");\r\n        finishedGood = findItem(\"1l bottle oil\");\r\n      } else if (line.sku === \"5L Tin\") {\r\n        emptyContainer = findItem(\"5l tin\");\r\n        finishedGood = findItem(\"5l tin oil\");\r\n      } else if (line.sku === \"15L Tin\") {\r\n        emptyContainer = findItem(\"15l tin\");\r\n        finishedGood = findItem(\"15l tin oil\");\r\n      }\r\n\r\n      // Validate and queue updates\r\n      if (emptyContainer.stock_level < line.quantity) {\r\n        return { success: false, error: `Insufficient ${line.sku}` };\r\n      }\r\n\r\n      updates.push({ itemId: emptyContainer.id, delta: -line.quantity });\r\n      updates.push({ itemId: finishedGood.id, delta: line.quantity });\r\n    }\r\n\r\n    // Validate bulk oil\r\n    if (bulkOil.stock_level < totalLitersConsumed) {\r\n      return { success: false, error: \"Insufficient bulk oil\" };\r\n    }\r\n\r\n    // Execute updates\r\n    for (const update of updates) {\r\n      const item = inventoryItems.find((i) => i.id === update.itemId);\r\n      await supabase\r\n        .from(\"inventory_items\")\r\n        .update({ stock_level: item.stock_level + update.delta })\r\n        .eq(\"id\", update.itemId);\r\n    }\r\n\r\n    // Final: Decrement bulk oil\r\n    await supabase\r\n      .from(\"inventory_items\")\r\n      .update({ stock_level: bulkOil.stock_level - totalLitersConsumed })\r\n      .eq(\"id\", bulkOil.id);\r\n\r\n    revalidatePath(\"/inventory\");\r\n    revalidatePath(\"/bottling\");\r\n\r\n    return {\r\n      success: true,\r\n      message: `Consumed ${totalLitersConsumed.toFixed(1)}L of bulk oil.`,\r\n    };\r\n  } catch (error: any) {\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n```\r\n\r\n## Testing Guide\r\n\r\n### Test Case 1: Basic Single-SKU Run\r\n**Steps:**\r\n1. Navigate to `/bottling`\r\n2. Leave default 1L Bottle selected\r\n3. Enter quantity: 50\r\n4. Verify total shows: 50.0 L\r\n5. Click \"Start Bottling Run\"\r\n6. Verify success message\r\n7. Check `/inventory`: Bulk Oil -50L, Empty 1L -50, Finished 1L +50\r\n\r\n### Test Case 2: Multi-SKU Run\r\n**Steps:**\r\n1. Navigate to `/bottling`\r\n2. Line 1: 1L Bottle, qty 30 (= 30L)\r\n3. Click \"Add Line\"\r\n4. Line 2: 5L Tin, qty 10 (= 50L)\r\n5. Click \"Add Line\"\r\n6. Line 3: 15L Tin, qty 3 (= 45L)\r\n7. Verify total shows: 125.0 L\r\n8. Submit and verify inventory updates\r\n\r\n### Test Case 3: Insufficient Bulk Oil Error\r\n**Steps:**\r\n1. Check bulk oil inventory (e.g., 50L available)\r\n2. Try to bottle 100L total\r\n3. Verify error: \"Insufficient bulk oil. Available: 50L, Required: 100L\"\r\n4. Adjust quantities to fit within 50L\r\n5. Retry and succeed\r\n\r\n### Test Case 4: Insufficient Empty Containers Error\r\n**Steps:**\r\n1. Check empty 5L tin inventory (e.g., 5 available)\r\n2. Try to bottle 10 Ã— 5L Tin\r\n3. Verify error: \"Insufficient empty containers for 5L Tin. Available: 5, Required: 10\"\r\n4. Reduce quantity to 5 or less\r\n5. Retry and succeed\r\n\r\n### Test Case 5: Remove Line Functionality\r\n**Steps:**\r\n1. Add 3 lines\r\n2. Click remove on line 2 - verify it's removed\r\n3. Try to remove when only 1 line left\r\n4. Verify remove button is disabled (minimum 1 line enforced)\r\n\r\n### Test Case 6: Real-time Total Calculation\r\n**Steps:**\r\n1. Add line: 1L Bottle, qty 0 - total should be 0.0 L\r\n2. Change qty to 10 - total should update to 10.0 L\r\n3. Change SKU to 5L Tin - total should update to 50.0 L\r\n4. Add another line - total should accumulate correctly\r\n\r\n## Migration Guide\r\n\r\n### Database Migration\r\n\r\n**Run this SQL:**\r\n```sql\r\n-- See: supabase/migration-remove-bottled-units.sql\r\n\r\nALTER TABLE public.production_batches\r\nDROP COLUMN IF EXISTS bottled_units;\r\n\r\nALTER TABLE public.production_batches\r\nDROP CONSTRAINT IF EXISTS production_batches_phase_check;\r\n\r\nALTER TABLE public.production_batches\r\nADD CONSTRAINT production_batches_phase_check \r\nCHECK (phase IN ('dehusking', 'pressing', 'completed'));\r\n\r\nUPDATE public.production_batches\r\nSET phase = 'completed'\r\nWHERE phase = 'bottling';\r\n```\r\n\r\n### Code Changes Applied\r\n\r\n**Modified Files:**\r\n- `app/production/page.tsx` - 3 columns: Dehusking | Pressing | Completed\r\n- `components/production/workflow-form.tsx` - Removed BottlingForm component\r\n- `app/actions/production.ts` - Removed bottling phase logic, pressing now sets 'completed'\r\n\r\n**New Files:**\r\n- `app/bottling/page.tsx` - Bottling run UI\r\n- `app/actions/bottling.ts` - Server action for bottling runs\r\n\r\n**Updated Files:**\r\n- `components/layout/nav-links.tsx` - Added \"Bottling\" link\r\n- `supabase/schema.sql` - Updated production_batches table\r\n- `docs/PRODUCTION-WORKFLOW.md` - Comprehensive documentation\r\n- `docs/BOTTLING-MODULE.md` - This file\r\n\r\n### Inventory Setup Required\r\n\r\n**Ensure these inventory items exist:**\r\n\r\n**Raw Materials:**\r\n- Groundnuts\r\n- Peanuts (intermediate)\r\n\r\n**Bulk:**\r\n- Bulk Oil (intermediate)\r\n\r\n**Packaging:**\r\n- Empty 1L Bottle (or \"1l bottle\")\r\n- Empty 5L Tin (or \"5l tin\")\r\n- Empty 15L Tin (or \"15l tin\")\r\n\r\n**Finished Goods:**\r\n- 1L Bottle Oil (or \"finished 1l\")\r\n- 5L Tin Oil (or \"finished 5l\")\r\n- 15L Tin Oil (or \"finished 15l\")\r\n\r\n**Byproducts:**\r\n- Oilcake\r\n- Husk\r\n\r\n## Best Practices\r\n\r\n### 1. Inventory Planning\r\n- Monitor bulk oil levels before starting bottling runs\r\n- Ensure adequate empty container stock for planned SKUs\r\n- Consider order backlog when deciding SKU mix\r\n\r\n### 2. SKU Selection\r\n- Use 1L bottles for retail customers\r\n- Use 5L tins for small restaurants/cafes\r\n- Use 15L tins for bulk institutional orders\r\n\r\n### 3. Workflow Sequence\r\n```\r\nDaily Routine:\r\n1. Complete any pending production batches (/production)\r\n2. Review bulk oil inventory (/inventory)\r\n3. Check order backlog and forecast demand\r\n4. Plan bottling run SKU mix based on forecast\r\n5. Execute bottling run (/bottling)\r\n6. Verify finished goods inventory updated\r\n7. Fulfill orders as needed\r\n```\r\n\r\n### 4. Error Recovery\r\n- If bottling run fails, check error message details\r\n- Verify inventory levels match expectations\r\n- Re-run with adjusted quantities if needed\r\n- All transactions are atomic - partial failures won't corrupt data\r\n\r\n## Future Enhancements\r\n\r\n1. **Bottling History Table**\r\n   - Track all historical bottling runs\r\n   - Timestamp, SKU mix, total liters consumed\r\n   - User who initiated the run\r\n\r\n2. **Label Integration**\r\n   - Automatically decrement label inventory during runs\r\n   - Match label count to total units bottled\r\n\r\n3. **Batch Traceability (Optional)**\r\n   - Link finished goods back to source production batches\r\n   - QR code generation for traceability\r\n\r\n4. **Smart Recommendations**\r\n   - Analyze order backlog\r\n   - Suggest optimal SKU mix\r\n   - Alert when bulk oil is low relative to pending orders\r\n\r\n5. **Quality Control Checkpoints**\r\n   - Pre-run QC: Check oil quality metrics\r\n   - Mid-run: Sample testing\r\n   - Post-run: Final QC before marking complete\r\n\r\n6. **Multi-user Support**\r\n   - Role-based access (bottling operator vs. super admin)\r\n   - Approval workflows for large runs\r\n   - Audit log of who ran what when\r\n\r\n## Related Documentation\r\n\r\n- [Production Workflow](./PRODUCTION-WORKFLOW.md) - Dehusking & Pressing phases\r\n- [Inventory Implementation](./INVENTORY-IMPLEMENTATION.md) - Stock management\r\n- [ERP Bridge](./ERP-BRIDGE.md) - Finance-Inventory integration\r\n- [Quick Start Guide](./QUICK-START-GUIDE.md) - Overall system overview\r\n- [Database Schema](../supabase/schema.sql) - Complete schema reference\r\n"
        }
    ]
}