{
    "sourceFile": "docs/ERP-BRIDGE.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763363343213,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763363343213,
            "name": "Commit-0",
            "content": "# Finance-to-Inventory ERP Bridge\r\n\r\n## Overview\r\nFully automated integration between Finance and Inventory modules using **Weighted Average Cost (WAC)** accounting method. When procurement expenses are logged, inventory stock and cost automatically update.\r\n\r\n## The Problem We Solved\r\n\r\n### Before (Manual Two-Step Process)\r\n```\r\nUser buys 1000 kg groundnuts for â‚¹80,000\r\n    â†“\r\nStep 1: Go to /finance â†’ Log expense (â‚¹80,000)\r\n    â†“\r\nStep 2: Go to /inventory â†’ New Stock Movement (+1000 kg)\r\n    â†“\r\nâŒ Two separate forms\r\nâŒ No cost tracking in inventory\r\nâŒ Prone to errors/omissions\r\n```\r\n\r\n### After (Automated ERP Bridge)\r\n```\r\nUser buys 1000 kg groundnuts for â‚¹80,000\r\n    â†“\r\nSingle Form: /finance â†’ Add Expense\r\n  - Category: Purchase Groundnuts\r\n  - Amount: â‚¹80,000\r\n  - Item: Groundnuts (dropdown)\r\n  - Quantity: 1000 kg\r\n    â†“\r\nâœ… Expense logged in Finance\r\nâœ… Stock updated: 1500 â†’ 2500 kg\r\nâœ… Avg cost updated: â‚¹78 â†’ â‚¹78.8/kg (WAC)\r\nâœ… COGS recalculates automatically\r\n```\r\n\r\n## Weighted Average Cost (WAC) Explained\r\n\r\n### Why WAC?\r\nWhen you purchase the same item at different prices over time, WAC calculates a **fair average cost** that represents the true inventory value.\r\n\r\n### The Formula\r\n```\r\nnew_avg_cost = (current_inventory_value + new_purchase_amount) / (current_stock + new_quantity)\r\n```\r\n\r\n### Real Example\r\n\r\n**Scenario:** You currently have 1500 kg of groundnuts bought at â‚¹78/kg. You purchase 1000 kg more for â‚¹80,000.\r\n\r\n**Step 1: Current State**\r\n```\r\nCurrent Stock: 1500 kg\r\nCurrent Avg Cost: â‚¹78/kg\r\nCurrent Value: 1500 Ã— 78 = â‚¹117,000\r\n```\r\n\r\n**Step 2: New Purchase**\r\n```\r\nPurchased Quantity: 1000 kg\r\nPurchase Amount: â‚¹80,000\r\nPurchase Price: â‚¹80,000 Ã· 1000 = â‚¹80/kg\r\n```\r\n\r\n**Step 3: WAC Calculation**\r\n```\r\nNew Stock = 1500 + 1000 = 2500 kg\r\nNew Total Value = â‚¹117,000 + â‚¹80,000 = â‚¹197,000\r\nNew Avg Cost = â‚¹197,000 Ã· 2500 = â‚¹78.8/kg\r\n```\r\n\r\n**Result:**\r\n- âœ… Inventory: 2500 kg @ â‚¹78.8/kg = â‚¹197,000\r\n- âœ… Accurately reflects blended cost\r\n- âœ… Finance COGS calculations now use â‚¹78.8/kg\r\n\r\n## Implementation Details\r\n\r\n### Task 1: Dynamic Expense Form\r\n\r\n**File:** `components/finance/add-expense-form.tsx`\r\n\r\n**Changes:**\r\n1. Added `procurement` flag to expense categories\r\n2. Conditional rendering based on selected category\r\n3. Inventory item dropdown (fetched from API)\r\n4. Quantity input field\r\n\r\n**Code:**\r\n```typescript\r\nconst expenseCategories = [\r\n  { value: \"purchase_groundnuts\", label: \"Purchase Groundnuts\", procurement: true },\r\n  { value: \"transport\", label: \"Transport\", procurement: false },\r\n  // ... other categories\r\n];\r\n\r\nconst isProcurement = expenseCategories.find(c => c.value === selectedCategory)?.procurement;\r\n\r\n{isProcurement && (\r\n  <div className=\"rounded-lg border border-emerald-200 bg-emerald-50/60 p-4\">\r\n    <h4>ðŸ“¦ Inventory Update (ERP Bridge)</h4>\r\n    <select name=\"inventory_item_id\" required>\r\n      {inventoryItems.map(item => (\r\n        <option value={item.id}>\r\n          {item.item_name} (Current: {item.stock_level} {item.unit})\r\n        </option>\r\n      ))}\r\n    </select>\r\n    <input type=\"number\" name=\"procurement_quantity\" required />\r\n  </div>\r\n)}\r\n```\r\n\r\n### Task 2: API Route for Inventory Items\r\n\r\n**File:** `app/api/inventory-items/route.ts`\r\n\r\nSimple GET endpoint to fetch inventory items for the dropdown:\r\n\r\n```typescript\r\nexport async function GET() {\r\n  const { data: items } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"id, item_name, stock_level, unit, avg_cost\")\r\n    .order(\"item_name\", { ascending: true });\r\n\r\n  return NextResponse.json({ items: items ?? [] });\r\n}\r\n```\r\n\r\n### Task 3: WAC Server Action\r\n\r\n**File:** `app/actions/finance.ts`\r\n\r\n**Function:** `updateInventoryFromPurchase()`\r\n\r\n```typescript\r\nasync function updateInventoryFromPurchase(\r\n  itemId: string,\r\n  quantity: number,\r\n  purchaseAmount: number\r\n) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  // Step 1: Fetch current state\r\n  const { data: item } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"stock_level, avg_cost, item_name\")\r\n    .eq(\"id\", itemId)\r\n    .single();\r\n\r\n  const currentStock = item.stock_level;\r\n  const currentAvgCost = item.avg_cost;\r\n\r\n  // Step 2: Calculate new values\r\n  const newStock = currentStock + quantity;\r\n  const currentValue = currentStock * currentAvgCost;\r\n  const newTotalValue = currentValue + purchaseAmount;\r\n  const newAvgCost = newStock > 0 ? newTotalValue / newStock : 0;\r\n\r\n  // Step 3: Update inventory\r\n  await supabase\r\n    .from(\"inventory_items\")\r\n    .update({\r\n      stock_level: newStock,\r\n      avg_cost: newAvgCost,\r\n    })\r\n    .eq(\"id\", itemId);\r\n\r\n  return {\r\n    itemName: item.item_name,\r\n    oldStock: currentStock,\r\n    newStock,\r\n    oldAvgCost: currentAvgCost,\r\n    newAvgCost,\r\n  };\r\n}\r\n```\r\n\r\n**Enhanced `addExpense()` Action:**\r\n```typescript\r\nexport async function addExpense(formData: FormData) {\r\n  // Extract form data\r\n  const inventoryItemId = formData.get(\"inventory_item_id\") as string | null;\r\n  const procurementQuantity = formData.get(\"procurement_quantity\")\r\n    ? parseFloat(formData.get(\"procurement_quantity\") as string)\r\n    : null;\r\n\r\n  // Step 1: Insert expense\r\n  await supabase.from(\"expenses\").insert([expense]);\r\n\r\n  // Step 2: ERP Bridge - Update inventory if procurement\r\n  let inventoryUpdate = null;\r\n  if (inventoryItemId && procurementQuantity > 0) {\r\n    inventoryUpdate = await updateInventoryFromPurchase(\r\n      inventoryItemId,\r\n      procurementQuantity,\r\n      amount\r\n    );\r\n  }\r\n\r\n  // Step 3: Revalidate both pages\r\n  revalidatePath(\"/finance\");\r\n  revalidatePath(\"/inventory\");\r\n\r\n  return {\r\n    success: true,\r\n    message: inventoryUpdate\r\n      ? `Inventory updated: ${inventoryUpdate.itemName} ${inventoryUpdate.oldStock} â†’ ${inventoryUpdate.newStock}`\r\n      : \"Expense logged successfully\",\r\n  };\r\n}\r\n```\r\n\r\n## User Workflow\r\n\r\n### End-to-End Example: Groundnut Procurement\r\n\r\n**Scenario:** Purchase 1000 kg groundnuts from Gowda Farms for â‚¹80,000.\r\n\r\n**Steps:**\r\n1. Navigate to `/finance`\r\n2. Click **\"+ Log New Expense\"**\r\n3. Fill form:\r\n   - **Date:** 2025-11-17\r\n   - **Amount:** â‚¹80,000\r\n   - **Category:** Purchase Groundnuts\r\n   - *(Inventory section auto-appears)*\r\n   - **Inventory Item:** Groundnuts (Current: 1500 kg)\r\n   - **Quantity Purchased:** 1000\r\n   - **Status:** Paid\r\n   - **Notes:** \"Invoice #GF-2025-045 from Gowda Farms\"\r\n4. Click **\"Add Expense\"**\r\n5. System shows confirmation:\r\n   ```\r\n   âœ… Inventory updated: Groundnuts 1500 â†’ 2500 kg\r\n   âœ… Avg cost: â‚¹78.00 â†’ â‚¹78.80\r\n   ```\r\n\r\n**Verification:**\r\n- Check `/finance` â†’ Expense ledger shows â‚¹80,000 purchase\r\n- Check `/inventory` â†’ Groundnuts stock: 2500 kg @ â‚¹78.80/kg\r\n- Check `/finance` â†’ COGS now uses new â‚¹78.80 base cost\r\n\r\n## Impact on Other Modules\r\n\r\n### Finance Module\r\n- **Expenses:** Unchanged (still logs expense)\r\n- **COGS:** Automatically uses updated `avg_cost` from inventory\r\n- **Profitability:** More accurate with real-time cost tracking\r\n\r\n### Inventory Module\r\n- **Stock Level:** Updates instantly\r\n- **Avg Cost:** Recalculates via WAC\r\n- **Valuation:** Total inventory value reflects true cost\r\n\r\n### Production Module\r\n- **COGS Input:** Uses updated groundnut cost\r\n- **Bulk Oil Cost:** Recalculates with new procurement prices\r\n- **Margin Analysis:** Reflects current market prices\r\n\r\n## Data Flow Diagram\r\n\r\n```\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   User: Finance Expense Form           â”‚\r\nâ”‚   - Category: Purchase Groundnuts      â”‚\r\nâ”‚   - Amount: â‚¹80,000                     â”‚\r\nâ”‚   - Item: Groundnuts                    â”‚\r\nâ”‚   - Quantity: 1000 kg                   â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n               â”‚\r\n               â–¼\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   Server Action: addExpense()           â”‚\r\nâ”‚   1. Insert into expenses table         â”‚\r\nâ”‚   2. Call updateInventoryFromPurchase() â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n               â”‚\r\n               â–¼\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   WAC Calculation Logic                 â”‚\r\nâ”‚   - Fetch current: 1500 kg @ â‚¹78        â”‚\r\nâ”‚   - Calculate: (117k + 80k) / 2500      â”‚\r\nâ”‚   - Result: 2500 kg @ â‚¹78.8             â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n               â”‚\r\n               â–¼\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   Database Updates                      â”‚\r\nâ”‚   - expenses.insert()                   â”‚\r\nâ”‚   - inventory_items.update()            â”‚\r\nâ”‚     â€¢ stock_level = 2500                â”‚\r\nâ”‚     â€¢ avg_cost = 78.8                   â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n               â”‚\r\n               â–¼\r\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\r\nâ”‚   Revalidation                          â”‚\r\nâ”‚   - /finance page refreshes             â”‚\r\nâ”‚   - /inventory page refreshes           â”‚\r\nâ”‚   - COGS recalculates                   â”‚\r\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\r\n```\r\n\r\n## Edge Cases Handled\r\n\r\n### 1. First Purchase (Zero Stock)\r\n```\r\nCurrent: 0 kg @ â‚¹0/kg\r\nPurchase: 500 kg for â‚¹40,000\r\nResult: 500 kg @ â‚¹80/kg (purchase price becomes avg cost)\r\n```\r\n\r\n### 2. Negative Stock Prevention\r\n- WAC calculation requires `newStock > 0`\r\n- Division by zero protection\r\n\r\n### 3. Transaction Safety\r\n- If expense insert succeeds but inventory update fails, error message returned\r\n- User can retry inventory update via manual Stock Movement\r\n\r\n### 4. Non-Procurement Expenses\r\n- Transport, labor, utilities â†’ No inventory fields shown\r\n- Normal expense flow (no ERP bridge triggered)\r\n\r\n## Testing Checklist\r\n\r\n- [ ] Log non-procurement expense (transport) - no inventory fields\r\n- [ ] Log procurement expense (groundnuts) - inventory section appears\r\n- [ ] Verify dropdown shows all inventory items with current stock\r\n- [ ] Submit with valid data - confirm success message shows oldâ†’new values\r\n- [ ] Check `/inventory` - verify stock level increased\r\n- [ ] Check `/inventory` - verify avg_cost updated with WAC\r\n- [ ] Log second purchase at different price - verify WAC recalculates\r\n- [ ] Check `/finance` COGS - verify uses new avg_cost\r\n- [ ] Complete production batch - verify COGS uses latest groundnut cost\r\n\r\n## Advanced: Multi-Item Procurement\r\n\r\n**Future Enhancement:** Support purchasing multiple items in one expense:\r\n\r\n```typescript\r\n// Form allows adding multiple line items\r\nitems: [\r\n  { id: \"groundnuts-id\", quantity: 1000, amount: 80000 },\r\n  { id: \"bottles-id\", quantity: 500, amount: 7500 }\r\n]\r\n\r\n// Loop through and apply WAC to each\r\nfor (const item of items) {\r\n  await updateInventoryFromPurchase(item.id, item.quantity, item.amount);\r\n}\r\n```\r\n\r\n## Files Modified/Created\r\n\r\n**Created:**\r\n- `app/api/inventory-items/route.ts` - Inventory dropdown API\r\n\r\n**Modified:**\r\n- `components/finance/add-expense-form.tsx` - Conditional inventory fields\r\n- `app/actions/finance.ts` - WAC calculation logic\r\n- `docs/FINANCE-WORKFLOW.md` - Updated with ERP bridge section\r\n\r\n## Related Documentation\r\n- [Finance Module Workflow](./FINANCE-WORKFLOW.md) - Main finance documentation\r\n- [Inventory Implementation](./INVENTORY-IMPLEMENTATION.md) - Inventory module details\r\n- [Production Workflow](./PRODUCTION-WORKFLOW.md) - How production affects COGS\r\n"
        }
    ]
}