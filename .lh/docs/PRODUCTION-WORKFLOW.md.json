{
    "sourceFile": "docs/PRODUCTION-WORKFLOW.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763361124619,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763363559156,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,28 +14,27 @@\n ### Database Schema\r\n ```sql\r\n CREATE TABLE production_batches (\r\n   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n-  batch_id TEXT UNIQUE NOT NULL,\r\n-  farmer_name TEXT NOT NULL,\r\n+  batch_code TEXT UNIQUE NOT NULL,\r\n+  farmer_name TEXT,\r\n   phase TEXT DEFAULT 'dehusking',\r\n-  pressed_on DATE NOT NULL,\r\n+  batch_date DATE NOT NULL,\r\n   \r\n   -- Phase 1: Dehusking\r\n-  input_groundnuts NUMERIC,\r\n-  dehusked_peanuts NUMERIC,\r\n+  input_groundnuts_kg NUMERIC,\r\n+  output_peanuts_kg NUMERIC,\r\n   \r\n   -- Phase 2: Pressing\r\n-  pressing_oil NUMERIC,\r\n-  pressing_cake NUMERIC,\r\n-  pressing_husk NUMERIC,\r\n+  output_oil_liters NUMERIC,\r\n+  output_oilcake_kg NUMERIC,\r\n+  output_husk_kg NUMERIC,\r\n   \r\n   -- Phase 3: Bottling\r\n-  bottling_1l INT,\r\n-  bottling_5l INT,\r\n-  bottling_15l INT,\r\n-  bottling_labels INT,\r\n+  bottled_units INT,\r\n   \r\n+  -- General\r\n+  notes TEXT,\r\n   created_at TIMESTAMPTZ DEFAULT NOW()\r\n );\r\n ```\r\n \r\n@@ -50,90 +49,138 @@\n ### 2. Start New Batch Dialog\r\n Component: `components/production/start-batch-dialog.tsx`\r\n \r\n Simple form to initiate a new batch:\r\n-- Batch ID (auto-suggested: `BATCH-{timestamp}`)\r\n+- Batch Code (auto-suggested: `BATCH-{timestamp}`)\r\n - Farmer name\r\n-- Pressing date\r\n-- Input groundnuts (kg)\r\n+- Batch date\r\n \r\n-Creates batch with `phase='dehusking'` default.\r\n+Creates batch with `phase='dehusking'` default. Input groundnuts are entered in the dehusking phase form.\r\n \r\n ### 3. Phased Update Modal\r\n Component: `components/production/workflow-form.tsx`\r\n \r\n Modal displays only the form relevant to current phase:\r\n \r\n **Phase 1 Form (Dehusking)**\r\n-- Input: Groundnuts (kg)\r\n-- Output: Dehusked peanuts (kg)\r\n+- Input: `input_groundnuts_kg` - Groundnuts (kg)\r\n+- Output: `output_peanuts_kg` - Dehusked peanuts (kg)\r\n+- Notes: Optional text field\r\n - Action: Advances to `pressing` phase\r\n \r\n **Phase 2 Form (Pressing)**\r\n-- Input: Peanuts (from Phase 1)\r\n-- Outputs: Oil (L), Oilcake (kg), Husk (kg)\r\n-- Calculation: Expected yield = peanuts × 62%\r\n+- Displays: Expected oil yield = `output_peanuts_kg × 0.62` (62% conversion)\r\n+- Outputs: \r\n+  - `output_oil_liters` - Oil collected (L)\r\n+  - `output_oilcake_kg` - Oilcake (kg)\r\n+  - `output_husk_kg` - Husk (kg)\r\n+- Notes: Optional text field\r\n - Action: Advances to `bottling` phase\r\n \r\n **Phase 3 Form (Bottling)**\r\n-- Input: Oil (from Phase 2)\r\n-- Outputs: 1L bottles, 5L tins, 15L tins, labels used\r\n-- Action: Completes batch (no phase change)\r\n+- Displays: Available oil from Phase 2 (`output_oil_liters`)\r\n+- Output: `bottled_units` - Number of 1L bottles filled\r\n+- Notes: Optional text field\r\n+- Action: Completes batch (stays in `bottling` phase)\r\n \r\n ### 4. ERP Inventory Transactions\r\n-Server action: `app/actions/production.ts` → `updateProductionPhase()`\r\n+Server action: `app/actions/production.ts` → `updatePhasedInventory()`\r\n \r\n Each phase completion triggers automated inventory updates:\r\n \r\n **Phase 1 Complete (Dehusking)**\r\n ```typescript\r\n-await updatePhasedInventory('groundnuts', -input_groundnuts);\r\n-await updatePhasedInventory('peanuts', +dehusked_peanuts);\r\n+// Decrement groundnuts input\r\n+if (phaseData.input_groundnuts_kg && groundnuts) {\r\n+  await supabase\r\n+    .from('inventory_items')\r\n+    .update({ stock_level: groundnuts.stock_level - phaseData.input_groundnuts_kg })\r\n+    .eq('id', groundnuts.id);\r\n+}\r\n+// Increment peanuts output\r\n+if (phaseData.output_peanuts_kg && peanuts) {\r\n+  await supabase\r\n+    .from('inventory_items')\r\n+    .update({ stock_level: peanuts.stock_level + phaseData.output_peanuts_kg })\r\n+    .eq('id', peanuts.id);\r\n+}\r\n ```\r\n \r\n **Phase 2 Complete (Pressing)**\r\n ```typescript\r\n-await updatePhasedInventory('peanuts', -dehusked_peanuts);\r\n-await updatePhasedInventory('oil', +pressing_oil);\r\n-await updatePhasedInventory('oilcake', +pressing_cake);\r\n-await updatePhasedInventory('husk', +pressing_husk);\r\n+// Increment oil, oilcake, husk outputs\r\n+if (phaseData.output_oil_liters && bulkOil) {\r\n+  await supabase.from('inventory_items')\r\n+    .update({ stock_level: bulkOil.stock_level + phaseData.output_oil_liters })\r\n+    .eq('id', bulkOil.id);\r\n+}\r\n+if (phaseData.output_oilcake_kg && oilcake) { /* ... */ }\r\n+if (phaseData.output_husk_kg && husk) { /* ... */ }\r\n+\r\n+// Decrement peanuts used (passed from batch data)\r\n+if (phaseData.output_peanuts_kg && peanuts) {\r\n+  await supabase.from('inventory_items')\r\n+    .update({ stock_level: peanuts.stock_level - phaseData.output_peanuts_kg })\r\n+    .eq('id', peanuts.id);\r\n+}\r\n ```\r\n \r\n **Phase 3 Complete (Bottling)**\r\n ```typescript\r\n-await updatePhasedInventory('oil', -consumed_oil);\r\n-await updatePhasedInventory('bottles_1l', -bottling_1l);\r\n-await updatePhasedInventory('bottles_5l', -bottling_5l);\r\n-await updatePhasedInventory('bottles_15l', -bottling_15l);\r\n-await updatePhasedInventory('finished_oil_1l', +bottling_1l);\r\n-await updatePhasedInventory('finished_oil_5l', +bottling_5l);\r\n-await updatePhasedInventory('finished_oil_15l', +bottling_15l);\r\n+// Increment finished goods (1L bottles of oil)\r\n+if (phaseData.bottled_units && finishedOil) {\r\n+  await supabase.from('inventory_items')\r\n+    .update({ stock_level: finishedOil.stock_level + phaseData.bottled_units })\r\n+    .eq('id', finishedOil.id);\r\n+}\r\n+\r\n+// Decrement bulk oil consumed\r\n+if (phaseData.output_oil_liters && bulkOil) {\r\n+  await supabase.from('inventory_items')\r\n+    .update({ stock_level: bulkOil.stock_level - phaseData.output_oil_liters })\r\n+    .eq('id', bulkOil.id);\r\n+}\r\n+\r\n+// Decrement empty bottles used\r\n+if (phaseData.bottled_units && bottle1L) {\r\n+  await supabase.from('inventory_items')\r\n+    .update({ stock_level: bottle1L.stock_level - phaseData.bottled_units })\r\n+    .eq('id', bottle1L.id);\r\n+}\r\n ```\r\n \r\n ## User Journey\r\n \r\n 1. **Create Batch**\r\n    - Click \"Start New Batch\" on `/production`\r\n-   - Fill batch details → Appears in \"Dehusking\" column\r\n+   - Fill: Batch code, Farmer name, Batch date\r\n+   - Batch appears in \"Phase 1: De-husking\" column\r\n \r\n 2. **Complete Dehusking**\r\n-   - Click batch card in Dehusking column\r\n-   - Enter dehusked peanuts output\r\n-   - Save → Batch moves to \"Pressing\" column\r\n+   - Click batch card in De-husking column\r\n+   - Enter: Input groundnuts (kg), Output peanuts (kg)\r\n+   - Optional: Add notes\r\n+   - Click \"Save & Advance to Pressing\"\r\n+   - Batch moves to \"Phase 2: Pressing\" column\r\n    - Inventory: Groundnuts ↓, Peanuts ↑\r\n \r\n 3. **Complete Pressing**\r\n    - Click batch card in Pressing column\r\n-   - See expected oil yield calculation\r\n-   - Enter oil, oilcake, husk outputs\r\n-   - Save → Batch moves to \"Bottling\" column\r\n-   - Inventory: Peanuts ↓, Oil ↑, Oilcake ↑, Husk ↑\r\n+   - View expected oil yield (peanuts × 62%)\r\n+   - Enter: Oil collected (L), Oilcake (kg), Husk (kg)\r\n+   - Optional: Add notes\r\n+   - Click \"Save & Advance to Bottling\"\r\n+   - Batch moves to \"Phase 3: Bottling\" column\r\n+   - Inventory: Peanuts ↓, Bulk Oil ↑, Oilcake ↑, Husk ↑\r\n \r\n 4. **Complete Bottling**\r\n    - Click batch card in Bottling column\r\n-   - Enter bottle quantities (1L, 5L, 15L)\r\n-   - Save → Batch remains in Bottling (completed)\r\n-   - Inventory: Oil ↓, Empty Bottles ↓, Finished Goods ↑\r\n+   - View available oil from Phase 2\r\n+   - Enter: Number of 1L bottles filled\r\n+   - Optional: Add notes\r\n+   - Click \"Complete Batch\"\r\n+   - Batch remains in Bottling column (marked as complete)\r\n+   - Inventory: Bulk Oil ↓, Empty 1L Bottles ↓, Finished 1L Oil ↑\r\n \r\n ## Technical Details\r\n \r\n ### Real-Time Synchronization\r\n@@ -171,44 +218,59 @@\n }\r\n ```\r\n \r\n ### Inventory Item Mapping\r\n-The `updatePhasedInventory()` helper queries `inventory_items` by name:\r\n+The `updatePhasedInventory()` function uses fuzzy name matching to find inventory items:\r\n ```typescript\r\n-const { data } = await supabase\r\n+const { data: inventoryItems } = await supabase\r\n   .from('inventory_items')\r\n-  .select('id, quantity')\r\n-  .eq('name', itemName)\r\n-  .single();\r\n+  .select('id, item_name, stock_level');\r\n \r\n-await supabase\r\n-  .from('inventory_items')\r\n-  .update({ quantity: currentQty + delta })\r\n-  .eq('id', itemId);\r\n+const findItem = (name: string) =>\r\n+  inventoryItems.find((item: any) =>\r\n+    item.item_name.toLowerCase().includes(name.toLowerCase())\r\n+  );\r\n+\r\n+const groundnuts = findItem('groundnut');\r\n+const peanuts = findItem('peanut');\r\n+const bulkOil = findItem('bulk oil') || findItem('oil');\r\n+const oilcake = findItem('oilcake');\r\n+const husk = findItem('husk');\r\n+const bottle1L = findItem('1l bottle');\r\n+const finishedOil = findItem('1l bottle oil');\r\n ```\r\n \r\n+This approach is resilient to slight variations in item naming (e.g., \"Groundnuts\" vs \"Groundnut Raw\").\r\n+\r\n ## Files Modified/Created\r\n \r\n **Created:**\r\n-- `app/actions/production.ts` - Server actions with ERP logic\r\n-- `components/production/start-batch-dialog.tsx` - Batch creation form\r\n+- `app/actions/production.ts` - Server actions with `createProductionBatch()`, `updateProductionPhase()`, `updatePhasedInventory()`\r\n+- `components/production/start-batch-dialog.tsx` - Batch creation form with batch_code/farmer_name/batch_date\r\n - `docs/PRODUCTION-WORKFLOW.md` - This documentation\r\n \r\n **Modified:**\r\n-- `app/production/page.tsx` - Converted to Kanban client component\r\n-- `components/production/workflow-form.tsx` - Rebuilt as phased modal\r\n+- `app/production/page.tsx` - Kanban board with real-time Supabase subscriptions, 3-column layout\r\n+- `components/production/workflow-form.tsx` - Phase-specific forms (DehuskingForm, PressingForm, BottlingForm)\r\n \r\n ## Testing Checklist\r\n \r\n-- [ ] Create batch with Start New Batch dialog\r\n-- [ ] Verify batch appears in Dehusking column\r\n-- [ ] Complete Phase 1, verify moves to Pressing\r\n-- [ ] Check inventory: Groundnuts decreased, Peanuts increased\r\n-- [ ] Complete Phase 2, verify moves to Bottling\r\n-- [ ] Check inventory: Peanuts decreased, Oil/Oilcake/Husk increased\r\n-- [ ] Complete Phase 3, verify stays in Bottling\r\n-- [ ] Check inventory: Oil/Bottles decreased, Finished Goods increased\r\n-- [ ] Verify real-time updates (open in two browsers)\r\n+- [ ] Create batch with Start New Batch dialog (batch_code, farmer_name, batch_date)\r\n+- [ ] Verify batch appears in \"Phase 1: De-husking\" column with \"Pending\" status\r\n+- [ ] Click batch, enter input_groundnuts_kg and output_peanuts_kg\r\n+- [ ] Verify batch moves to \"Phase 2: Pressing\" column\r\n+- [ ] Check inventory: Groundnuts stock_level decreased, Peanuts stock_level increased\r\n+- [ ] Click batch in Pressing, see expected oil yield calculation\r\n+- [ ] Enter output_oil_liters, output_oilcake_kg, output_husk_kg\r\n+- [ ] Verify batch moves to \"Phase 3: Bottling\" column\r\n+- [ ] Check inventory: Peanuts decreased, Bulk Oil/Oilcake/Husk increased\r\n+- [ ] Click batch in Bottling, see available oil displayed\r\n+- [ ] Enter bottled_units (1L bottles)\r\n+- [ ] Verify batch stays in Bottling column with \"Complete\" status\r\n+- [ ] Check inventory: Bulk Oil decreased, Empty 1L Bottles decreased, Finished 1L Oil increased\r\n+- [ ] Verify real-time updates (open /production in two browser tabs, update in one)\r\n+- [ ] Test notes field in each phase form\r\n+- [ ] Verify revalidatePath() updates both /production and /inventory pages\r\n \r\n ## Future Enhancements\r\n \r\n 1. **Batch Status** - Add 'paused' or 'cancelled' states\r\n"
                },
                {
                    "date": 1763364745346,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,24 +1,38 @@\n # Production Workflow Implementation\r\n \r\n ## Overview\r\n-Transformed the static production page into a phased Kanban-style workflow system with real-time ERP inventory tracking.\r\n+**Architecture Change (Decoupled Model):** Production now tracks batches from \"Groundnuts\" to \"Bulk Oil\" only. Bottling has been decoupled into a separate module (`/bottling`) to support commingled bulk oil inventory and flexible multi-SKU packaging.\r\n \r\n-## Architecture\r\n+## New Architecture\r\n \r\n+### Two Separate Processes\r\n+\r\n+**Process 1: Production** (`/production`)\r\n+- Tracks transformation: Groundnuts → Peanuts → Bulk Oil\r\n+- Ends when bulk oil is produced and added to inventory\r\n+- No longer handles packaging/bottling\r\n+\r\n+**Process 2: Bottling** (`/bottling`)\r\n+- Independent module for converting bulk oil to finished goods\r\n+- Supports multiple SKUs in a single run (1L Bottle, 5L Tin, 15L Tin)\r\n+- Solves the \"partial batch\" problem with commingled inventory\r\n+\r\n+## Production Workflow\r\n+\r\n ### Phased Workflow Model\r\n-Production batches move through three sequential phases:\r\n+Production batches move through two sequential phases plus completion:\r\n 1. **Dehusking** - Convert groundnuts → peanuts\r\n 2. **Pressing** - Extract oil, oilcake, and husk from peanuts\r\n-3. **Bottling** - Package oil into 1L/5L/15L containers\r\n+3. **Completed** - Batch finished, bulk oil in inventory\r\n \r\n ### Database Schema\r\n ```sql\r\n CREATE TABLE production_batches (\r\n   id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n   batch_code TEXT UNIQUE NOT NULL,\r\n   farmer_name TEXT,\r\n-  phase TEXT DEFAULT 'dehusking',\r\n+  phase TEXT DEFAULT 'dehusking' CHECK (phase IN ('dehusking', 'pressing', 'completed')),\r\n   batch_date DATE NOT NULL,\r\n   \r\n   -- Phase 1: Dehusking\r\n   input_groundnuts_kg NUMERIC,\r\n@@ -28,24 +42,25 @@\n   output_oil_liters NUMERIC,\r\n   output_oilcake_kg NUMERIC,\r\n   output_husk_kg NUMERIC,\r\n   \r\n-  -- Phase 3: Bottling\r\n-  bottled_units INT,\r\n-  \r\n   -- General\r\n   notes TEXT,\r\n   created_at TIMESTAMPTZ DEFAULT NOW()\r\n );\r\n ```\r\n \r\n+**Note:** The `bottled_units` column has been removed. Bottling is now handled in the separate `/bottling` module.\r\n+```\r\n+\r\n ## Features Implemented\r\n \r\n ### 1. Kanban Production Board (`/production`)\r\n-- **3-column layout**: Dehusking | Pressing | Bottling\r\n+- **3-column layout**: Phase 1: De-husking | Phase 2: Pressing | Completed\r\n - **Real-time updates** via Supabase subscriptions\r\n - **Batch cards** show phase-specific metrics\r\n-- **Click to advance** - Opens modal for current phase\r\n+- **Click to edit** - Opens modal for current phase (dehusking or pressing only)\r\n+- **Completed batches** - Read-only, cannot be edited\r\n \r\n ### 2. Start New Batch Dialog\r\n Component: `components/production/start-batch-dialog.tsx`\r\n \r\n@@ -73,16 +88,10 @@\n   - `output_oil_liters` - Oil collected (L)\r\n   - `output_oilcake_kg` - Oilcake (kg)\r\n   - `output_husk_kg` - Husk (kg)\r\n - Notes: Optional text field\r\n-- Action: Advances to `bottling` phase\r\n+- Action: **Completes batch** - Sets phase to `completed`\r\n \r\n-**Phase 3 Form (Bottling)**\r\n-- Displays: Available oil from Phase 2 (`output_oil_liters`)\r\n-- Output: `bottled_units` - Number of 1L bottles filled\r\n-- Notes: Optional text field\r\n-- Action: Completes batch (stays in `bottling` phase)\r\n-\r\n ### 4. ERP Inventory Transactions\r\n Server action: `app/actions/production.ts` → `updatePhasedInventory()`\r\n \r\n Each phase completion triggers automated inventory updates:\r\n@@ -162,25 +171,22 @@\n    - Click \"Save & Advance to Pressing\"\r\n    - Batch moves to \"Phase 2: Pressing\" column\r\n    - Inventory: Groundnuts ↓, Peanuts ↑\r\n \r\n-3. **Complete Pressing**\r\n+3. **Complete Pressing (Final Step)**\r\n    - Click batch card in Pressing column\r\n    - View expected oil yield (peanuts × 62%)\r\n    - Enter: Oil collected (L), Oilcake (kg), Husk (kg)\r\n    - Optional: Add notes\r\n-   - Click \"Save & Advance to Bottling\"\r\n-   - Batch moves to \"Phase 3: Bottling\" column\r\n-   - Inventory: Peanuts ↓, Bulk Oil ↑, Oilcake ↑, Husk ↑\r\n+   - Click \"Save & Complete Batch\"\r\n+   - Batch moves to \"Completed\" column\r\n+   - Inventory: Peanuts ↓, **Bulk Oil ↑**, Oilcake ↑, Husk ↑\r\n+   - **Batch is now finished** - Bulk oil is ready for bottling\r\n \r\n-4. **Complete Bottling**\r\n-   - Click batch card in Bottling column\r\n-   - View available oil from Phase 2\r\n-   - Enter: Number of 1L bottles filled\r\n-   - Optional: Add notes\r\n-   - Click \"Complete Batch\"\r\n-   - Batch remains in Bottling column (marked as complete)\r\n-   - Inventory: Bulk Oil ↓, Empty 1L Bottles ↓, Finished 1L Oil ↑\r\n+4. **Bottling (Separate Process)**\r\n+   - Navigate to `/bottling` page\r\n+   - Create bottling run with multiple SKUs\r\n+   - See [Bottling Module Documentation](#bottling-module) below\r\n \r\n ## Technical Details\r\n \r\n ### Real-Time Synchronization\r\n@@ -202,22 +208,20 @@\n ```\r\n \r\n ### Phase Transition Logic\r\n ```typescript\r\n-const phaseMap: Record<string, string | null> = {\r\n+const phaseMap: Record<string, string> = {\r\n   'dehusking': 'pressing',\r\n-  'pressing': 'bottling',\r\n-  'bottling': null  // Terminal state\r\n+  'pressing': 'completed',\r\n };\r\n \r\n const nextPhase = phaseMap[currentPhase];\r\n-if (nextPhase) {\r\n-  await supabase\r\n-    .from('production_batches')\r\n-    .update({ phase: nextPhase, ...phaseData })\r\n-    .eq('id', batchId);\r\n-}\r\n+await supabase\r\n+  .from('production_batches')\r\n+  .update({ phase: nextPhase, ...phaseData })\r\n+  .eq('id', batchId);\r\n ```\r\n+```\r\n \r\n ### Inventory Item Mapping\r\n The `updatePhasedInventory()` function uses fuzzy name matching to find inventory items:\r\n ```typescript\r\n@@ -234,53 +238,203 @@\n const peanuts = findItem('peanut');\r\n const bulkOil = findItem('bulk oil') || findItem('oil');\r\n const oilcake = findItem('oilcake');\r\n const husk = findItem('husk');\r\n-const bottle1L = findItem('1l bottle');\r\n-const finishedOil = findItem('1l bottle oil');\r\n ```\r\n \r\n This approach is resilient to slight variations in item naming (e.g., \"Groundnuts\" vs \"Groundnut Raw\").\r\n \r\n+**Note:** Empty bottles and finished goods are now managed in the `/bottling` module.\r\n+\r\n ## Files Modified/Created\r\n \r\n-**Created:**\r\n-- `app/actions/production.ts` - Server actions with `createProductionBatch()`, `updateProductionPhase()`, `updatePhasedInventory()`\r\n+**Production Module:**\r\n+- `app/actions/production.ts` - Server actions with `createProductionBatch()`, `updateProductionPhase()`, `updatePhasedInventory()` (2 phases only)\r\n - `components/production/start-batch-dialog.tsx` - Batch creation form with batch_code/farmer_name/batch_date\r\n+- `app/production/page.tsx` - Kanban board with 3 columns: Dehusking | Pressing | Completed\r\n+- `components/production/workflow-form.tsx` - Phase-specific forms (DehuskingForm, PressingForm only)\r\n+\r\n+**Bottling Module (New):**\r\n+- `app/bottling/page.tsx` - Bottling run UI with multi-SKU support\r\n+- `app/actions/bottling.ts` - Server action `createBottlingRun()` with commingled inventory logic\r\n+\r\n+**Database:**\r\n+- `supabase/schema.sql` - Updated production_batches table (removed bottled_units, updated phase constraint)\r\n+- `supabase/migration-remove-bottled-units.sql` - Migration script\r\n+\r\n+**Documentation:**\r\n - `docs/PRODUCTION-WORKFLOW.md` - This documentation\r\n \r\n-**Modified:**\r\n-- `app/production/page.tsx` - Kanban board with real-time Supabase subscriptions, 3-column layout\r\n-- `components/production/workflow-form.tsx` - Phase-specific forms (DehuskingForm, PressingForm, BottlingForm)\r\n-\r\n ## Testing Checklist\r\n \r\n+**Production Module:**\r\n - [ ] Create batch with Start New Batch dialog (batch_code, farmer_name, batch_date)\r\n - [ ] Verify batch appears in \"Phase 1: De-husking\" column with \"Pending\" status\r\n - [ ] Click batch, enter input_groundnuts_kg and output_peanuts_kg\r\n - [ ] Verify batch moves to \"Phase 2: Pressing\" column\r\n - [ ] Check inventory: Groundnuts stock_level decreased, Peanuts stock_level increased\r\n - [ ] Click batch in Pressing, see expected oil yield calculation\r\n - [ ] Enter output_oil_liters, output_oilcake_kg, output_husk_kg\r\n-- [ ] Verify batch moves to \"Phase 3: Bottling\" column\r\n-- [ ] Check inventory: Peanuts decreased, Bulk Oil/Oilcake/Husk increased\r\n-- [ ] Click batch in Bottling, see available oil displayed\r\n-- [ ] Enter bottled_units (1L bottles)\r\n-- [ ] Verify batch stays in Bottling column with \"Complete\" status\r\n-- [ ] Check inventory: Bulk Oil decreased, Empty 1L Bottles decreased, Finished 1L Oil increased\r\n+- [ ] Click \"Save & Complete Batch\" - verify batch moves to \"Completed\" column\r\n+- [ ] Check inventory: Peanuts decreased, **Bulk Oil** increased, Oilcake increased, Husk increased\r\n+- [ ] Try clicking completed batch - verify read-only modal appears\r\n - [ ] Verify real-time updates (open /production in two browser tabs, update in one)\r\n - [ ] Test notes field in each phase form\r\n - [ ] Verify revalidatePath() updates both /production and /inventory pages\r\n \r\n+**Bottling Module:**\r\n+- [ ] Navigate to `/bottling` page\r\n+- [ ] Add multiple bottling lines (1L, 5L, 15L)\r\n+- [ ] Verify total liters calculation updates correctly\r\n+- [ ] Submit bottling run - verify success message\r\n+- [ ] Check inventory: Bulk Oil decreased, Empty containers decreased, Finished goods increased\r\n+- [ ] Verify insufficient bulk oil error handling\r\n+- [ ] Verify insufficient empty container error handling\r\n+- [ ] Test remove line functionality (minimum 1 line enforced)\r\n+\r\n+---\r\n+\r\n+## Bottling Module\r\n+\r\n+### Overview\r\n+The bottling module (`/bottling`) is a **separate, independent process** that converts commingled bulk oil into multiple finished good SKUs in a single run. This solves the \"partial batch\" problem by decoupling packaging from production.\r\n+\r\n+### Key Benefits\r\n+1. **Commingled Inventory** - All bulk oil goes into one inventory pool, regardless of which batch produced it\r\n+2. **Multi-SKU Flexibility** - Package 1L bottles, 5L tins, and 15L tins in any combination\r\n+3. **No Batch Constraints** - Not tied to specific production batches\r\n+4. **Simplified Production** - Production workflow ends at bulk oil, reducing complexity\r\n+\r\n+### Bottling Run Workflow\r\n+\r\n+**UI: `/bottling` Page**\r\n+- Form with repeatable \"bottling lines\"\r\n+- Each line: [SKU Dropdown] | [Quantity Input] | [Liters Calculation] | [Remove Button]\r\n+- Add Line button to create new rows\r\n+- Total liters summary at bottom\r\n+\r\n+**Form Structure:**\r\n+```typescript\r\n+type BottlingLine = {\r\n+  id: number;\r\n+  sku: string;      // \"1L Bottle\" | \"5L Tin\" | \"15L Tin\"\r\n+  quantity: number; // Number of units to bottle\r\n+};\r\n+```\r\n+\r\n+**Example Bottling Run:**\r\n+```\r\n+Line 1: 50 × 1L Bottle  = 50 L\r\n+Line 2: 10 × 5L Tin     = 50 L\r\n+Line 3: 2 × 15L Tin     = 30 L\r\n+────────────────────────────────\r\n+Total: 130 L bulk oil required\r\n+```\r\n+\r\n+### ERP Transaction Logic\r\n+\r\n+Server action: `app/actions/bottling.ts` → `createBottlingRun()`\r\n+\r\n+**Algorithm:**\r\n+1. Initialize `total_liters_consumed = 0`\r\n+2. For each bottling line:\r\n+   - Calculate liters: `parseFloat(sku.split('L')[0]) × quantity`\r\n+   - Add to `total_liters_consumed`\r\n+   - Find empty container inventory item (fuzzy match)\r\n+   - Find finished good inventory item (fuzzy match)\r\n+   - Validate sufficient empty containers available\r\n+   - Queue updates: Decrement empty containers, Increment finished goods\r\n+3. Validate sufficient bulk oil available (`bulk_oil.stock_level >= total_liters_consumed`)\r\n+4. Execute all container updates\r\n+5. **Final transaction**: Decrement bulk oil by `total_liters_consumed`\r\n+6. Revalidate `/inventory` and `/bottling` paths\r\n+\r\n+**Inventory Item Mapping:**\r\n+```typescript\r\n+// SKU → Empty Container → Finished Good\r\n+\"1L Bottle\" → \"1l bottle\" / \"empty 1l\" → \"1l bottle oil\" / \"finished 1l\"\r\n+\"5L Tin\"    → \"5l tin\" / \"empty 5l\"    → \"5l tin oil\" / \"finished 5l\"\r\n+\"15L Tin\"   → \"15l tin\" / \"empty 15l\"  → \"15l tin oil\" / \"finished 15l\"\r\n+```\r\n+\r\n+**Error Handling:**\r\n+- Insufficient bulk oil: Shows available vs required\r\n+- Insufficient empty containers: Shows available vs required per SKU\r\n+- Invalid quantities: All quantities must be > 0\r\n+\r\n+### Code Example\r\n+\r\n+```typescript\r\n+// app/actions/bottling.ts\r\n+export async function createBottlingRun(formData: FormData) {\r\n+  const lines: BottlingLine[] = JSON.parse(formData.get(\"bottling_lines\"));\r\n+  let totalLitersConsumed = 0;\r\n+\r\n+  // Process each line\r\n+  for (const line of lines) {\r\n+    const litersPerUnit = parseFloat(line.sku.split(\"L\")[0]);\r\n+    totalLitersConsumed += litersPerUnit * line.quantity;\r\n+\r\n+    // Decrement empty containers\r\n+    await updateInventory(emptyContainer.id, -line.quantity);\r\n+    // Increment finished goods\r\n+    await updateInventory(finishedGood.id, +line.quantity);\r\n+  }\r\n+\r\n+  // Final: Decrement bulk oil\r\n+  await updateInventory(bulkOil.id, -totalLitersConsumed);\r\n+\r\n+  revalidatePath(\"/inventory\");\r\n+  revalidatePath(\"/bottling\");\r\n+}\r\n+```\r\n+\r\n+### User Journey: Bottling Run\r\n+\r\n+1. **Navigate to Bottling** - Click \"Bottling\" in sidebar or go to `/bottling`\r\n+\r\n+2. **Add Lines** \r\n+   - Default: 1 line with \"1L Bottle\" selected\r\n+   - Click \"Add Line\" to add more SKUs\r\n+   - Select SKU from dropdown (1L Bottle, 5L Tin, 15L Tin)\r\n+   - Enter quantity\r\n+   - See automatic liter calculation\r\n+\r\n+3. **Review Total**\r\n+   - Blue summary box shows total bulk oil required\r\n+   - Example: \"130.0 L - This amount will be deducted from your bulk oil inventory\"\r\n+\r\n+4. **Submit Run**\r\n+   - Click \"Start Bottling Run\"\r\n+   - Validation checks run\r\n+   - Success: Green message shows \"Bottling run completed! Consumed 130.0L of bulk oil.\"\r\n+   - Form resets for next run\r\n+\r\n+5. **Verify Inventory**\r\n+   - Check `/inventory` page\r\n+   - Bulk Oil decreased by total liters\r\n+   - Empty containers decreased by quantities\r\n+   - Finished goods increased by quantities\r\n+\r\n ## Future Enhancements\r\n \r\n+**Production:**\r\n 1. **Batch Status** - Add 'paused' or 'cancelled' states\r\n 2. **Quality Metrics** - Track oil quality (color, acidity)\r\n 3. **Waste Tracking** - Record spillage or damaged goods\r\n 4. **Photo Uploads** - Attach batch photos at each phase\r\n 5. **Analytics** - Phase duration, yield efficiency reports\r\n-6. **Batch Notes** - Comment field for anomalies or observations\r\n \r\n+**Bottling:**\r\n+1. **Bottling History** - Track all bottling runs with timestamps\r\n+2. **Label Tracking** - Integrate label consumption into bottling runs\r\n+3. **Batch Traceability** - Optional: Link finished goods back to source batches\r\n+4. **Pre-fill Suggestions** - Recommend SKU mix based on order backlog\r\n+5. **Quality Control** - Add QC checkpoints before finishing run\r\n+\r\n ## Related Documentation\r\n - [CRM Implementation](./CRM-IMPLEMENTATION.md)\r\n+- [Inventory Implementation](./INVENTORY-IMPLEMENTATION.md)\r\n+- [Finance Workflow](./FINANCE-WORKFLOW.md)\r\n+- [ERP Bridge](./ERP-BRIDGE.md)\r\n - [Quick Start Guide](./QUICK-START-GUIDE.md)\r\n - [Database Schema](../supabase/schema.sql)\r\n"
                }
            ],
            "date": 1763361124619,
            "name": "Commit-0",
            "content": "# Production Workflow Implementation\r\n\r\n## Overview\r\nTransformed the static production page into a phased Kanban-style workflow system with real-time ERP inventory tracking.\r\n\r\n## Architecture\r\n\r\n### Phased Workflow Model\r\nProduction batches move through three sequential phases:\r\n1. **Dehusking** - Convert groundnuts → peanuts\r\n2. **Pressing** - Extract oil, oilcake, and husk from peanuts\r\n3. **Bottling** - Package oil into 1L/5L/15L containers\r\n\r\n### Database Schema\r\n```sql\r\nCREATE TABLE production_batches (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  batch_id TEXT UNIQUE NOT NULL,\r\n  farmer_name TEXT NOT NULL,\r\n  phase TEXT DEFAULT 'dehusking',\r\n  pressed_on DATE NOT NULL,\r\n  \r\n  -- Phase 1: Dehusking\r\n  input_groundnuts NUMERIC,\r\n  dehusked_peanuts NUMERIC,\r\n  \r\n  -- Phase 2: Pressing\r\n  pressing_oil NUMERIC,\r\n  pressing_cake NUMERIC,\r\n  pressing_husk NUMERIC,\r\n  \r\n  -- Phase 3: Bottling\r\n  bottling_1l INT,\r\n  bottling_5l INT,\r\n  bottling_15l INT,\r\n  bottling_labels INT,\r\n  \r\n  created_at TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n```\r\n\r\n## Features Implemented\r\n\r\n### 1. Kanban Production Board (`/production`)\r\n- **3-column layout**: Dehusking | Pressing | Bottling\r\n- **Real-time updates** via Supabase subscriptions\r\n- **Batch cards** show phase-specific metrics\r\n- **Click to advance** - Opens modal for current phase\r\n\r\n### 2. Start New Batch Dialog\r\nComponent: `components/production/start-batch-dialog.tsx`\r\n\r\nSimple form to initiate a new batch:\r\n- Batch ID (auto-suggested: `BATCH-{timestamp}`)\r\n- Farmer name\r\n- Pressing date\r\n- Input groundnuts (kg)\r\n\r\nCreates batch with `phase='dehusking'` default.\r\n\r\n### 3. Phased Update Modal\r\nComponent: `components/production/workflow-form.tsx`\r\n\r\nModal displays only the form relevant to current phase:\r\n\r\n**Phase 1 Form (Dehusking)**\r\n- Input: Groundnuts (kg)\r\n- Output: Dehusked peanuts (kg)\r\n- Action: Advances to `pressing` phase\r\n\r\n**Phase 2 Form (Pressing)**\r\n- Input: Peanuts (from Phase 1)\r\n- Outputs: Oil (L), Oilcake (kg), Husk (kg)\r\n- Calculation: Expected yield = peanuts × 62%\r\n- Action: Advances to `bottling` phase\r\n\r\n**Phase 3 Form (Bottling)**\r\n- Input: Oil (from Phase 2)\r\n- Outputs: 1L bottles, 5L tins, 15L tins, labels used\r\n- Action: Completes batch (no phase change)\r\n\r\n### 4. ERP Inventory Transactions\r\nServer action: `app/actions/production.ts` → `updateProductionPhase()`\r\n\r\nEach phase completion triggers automated inventory updates:\r\n\r\n**Phase 1 Complete (Dehusking)**\r\n```typescript\r\nawait updatePhasedInventory('groundnuts', -input_groundnuts);\r\nawait updatePhasedInventory('peanuts', +dehusked_peanuts);\r\n```\r\n\r\n**Phase 2 Complete (Pressing)**\r\n```typescript\r\nawait updatePhasedInventory('peanuts', -dehusked_peanuts);\r\nawait updatePhasedInventory('oil', +pressing_oil);\r\nawait updatePhasedInventory('oilcake', +pressing_cake);\r\nawait updatePhasedInventory('husk', +pressing_husk);\r\n```\r\n\r\n**Phase 3 Complete (Bottling)**\r\n```typescript\r\nawait updatePhasedInventory('oil', -consumed_oil);\r\nawait updatePhasedInventory('bottles_1l', -bottling_1l);\r\nawait updatePhasedInventory('bottles_5l', -bottling_5l);\r\nawait updatePhasedInventory('bottles_15l', -bottling_15l);\r\nawait updatePhasedInventory('finished_oil_1l', +bottling_1l);\r\nawait updatePhasedInventory('finished_oil_5l', +bottling_5l);\r\nawait updatePhasedInventory('finished_oil_15l', +bottling_15l);\r\n```\r\n\r\n## User Journey\r\n\r\n1. **Create Batch**\r\n   - Click \"Start New Batch\" on `/production`\r\n   - Fill batch details → Appears in \"Dehusking\" column\r\n\r\n2. **Complete Dehusking**\r\n   - Click batch card in Dehusking column\r\n   - Enter dehusked peanuts output\r\n   - Save → Batch moves to \"Pressing\" column\r\n   - Inventory: Groundnuts ↓, Peanuts ↑\r\n\r\n3. **Complete Pressing**\r\n   - Click batch card in Pressing column\r\n   - See expected oil yield calculation\r\n   - Enter oil, oilcake, husk outputs\r\n   - Save → Batch moves to \"Bottling\" column\r\n   - Inventory: Peanuts ↓, Oil ↑, Oilcake ↑, Husk ↑\r\n\r\n4. **Complete Bottling**\r\n   - Click batch card in Bottling column\r\n   - Enter bottle quantities (1L, 5L, 15L)\r\n   - Save → Batch remains in Bottling (completed)\r\n   - Inventory: Oil ↓, Empty Bottles ↓, Finished Goods ↑\r\n\r\n## Technical Details\r\n\r\n### Real-Time Synchronization\r\n```typescript\r\nuseEffect(() => {\r\n  const channel = supabase\r\n    .channel('production-batches')\r\n    .on('postgres_changes', {\r\n      event: '*',\r\n      schema: 'public',\r\n      table: 'production_batches'\r\n    }, () => {\r\n      fetchBatches();\r\n    })\r\n    .subscribe();\r\n\r\n  return () => { supabase.removeChannel(channel); };\r\n}, []);\r\n```\r\n\r\n### Phase Transition Logic\r\n```typescript\r\nconst phaseMap: Record<string, string | null> = {\r\n  'dehusking': 'pressing',\r\n  'pressing': 'bottling',\r\n  'bottling': null  // Terminal state\r\n};\r\n\r\nconst nextPhase = phaseMap[currentPhase];\r\nif (nextPhase) {\r\n  await supabase\r\n    .from('production_batches')\r\n    .update({ phase: nextPhase, ...phaseData })\r\n    .eq('id', batchId);\r\n}\r\n```\r\n\r\n### Inventory Item Mapping\r\nThe `updatePhasedInventory()` helper queries `inventory_items` by name:\r\n```typescript\r\nconst { data } = await supabase\r\n  .from('inventory_items')\r\n  .select('id, quantity')\r\n  .eq('name', itemName)\r\n  .single();\r\n\r\nawait supabase\r\n  .from('inventory_items')\r\n  .update({ quantity: currentQty + delta })\r\n  .eq('id', itemId);\r\n```\r\n\r\n## Files Modified/Created\r\n\r\n**Created:**\r\n- `app/actions/production.ts` - Server actions with ERP logic\r\n- `components/production/start-batch-dialog.tsx` - Batch creation form\r\n- `docs/PRODUCTION-WORKFLOW.md` - This documentation\r\n\r\n**Modified:**\r\n- `app/production/page.tsx` - Converted to Kanban client component\r\n- `components/production/workflow-form.tsx` - Rebuilt as phased modal\r\n\r\n## Testing Checklist\r\n\r\n- [ ] Create batch with Start New Batch dialog\r\n- [ ] Verify batch appears in Dehusking column\r\n- [ ] Complete Phase 1, verify moves to Pressing\r\n- [ ] Check inventory: Groundnuts decreased, Peanuts increased\r\n- [ ] Complete Phase 2, verify moves to Bottling\r\n- [ ] Check inventory: Peanuts decreased, Oil/Oilcake/Husk increased\r\n- [ ] Complete Phase 3, verify stays in Bottling\r\n- [ ] Check inventory: Oil/Bottles decreased, Finished Goods increased\r\n- [ ] Verify real-time updates (open in two browsers)\r\n\r\n## Future Enhancements\r\n\r\n1. **Batch Status** - Add 'paused' or 'cancelled' states\r\n2. **Quality Metrics** - Track oil quality (color, acidity)\r\n3. **Waste Tracking** - Record spillage or damaged goods\r\n4. **Photo Uploads** - Attach batch photos at each phase\r\n5. **Analytics** - Phase duration, yield efficiency reports\r\n6. **Batch Notes** - Comment field for anomalies or observations\r\n\r\n## Related Documentation\r\n- [CRM Implementation](./CRM-IMPLEMENTATION.md)\r\n- [Quick Start Guide](./QUICK-START-GUIDE.md)\r\n- [Database Schema](../supabase/schema.sql)\r\n"
        }
    ]
}