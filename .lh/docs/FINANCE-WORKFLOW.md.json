{
    "sourceFile": "docs/FINANCE-WORKFLOW.md",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763361634206,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763362519358,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -385,9 +385,67 @@\n \r\n ### With Inventory Module\r\n - Packaging costs fetched from `inventory_items.avg_cost`\r\n - Supports dynamic pricing (e.g., if bottle supplier raises prices, COGS updates instantly)\r\n+- **Stock Movement Bridge**: Expense creation can trigger inventory updates via `createStockMovement()` action\r\n \r\n+#### The Finance-Inventory Bridge\r\n+\r\n+When recording expenses for procurement (e.g., \"Purchase Groundnuts\"), you can simultaneously update inventory using the **Stock Movement** system.\r\n+\r\n+**Manual Workflow:**\r\n+1. Navigate to `/inventory`\r\n+2. Click **\"+ New Stock Movement\"**\r\n+3. Select item (e.g., Groundnuts)\r\n+4. Enter quantity: `+500` (kg)\r\n+5. Reason: \"Procurement from Gowda Farms - Invoice #GF-2025-045\"\r\n+6. System updates `inventory_items.stock_level`\r\n+\r\n+**Future Enhancement (Automated):**\r\n+The Finance expense form will include an optional checkbox:\r\n+```typescript\r\n+// When creating expense with type='purchase_groundnuts'\r\n+if (formData.get(\"update_inventory\") === \"true\") {\r\n+  await createStockMovement({\r\n+    item_id: formData.get(\"inventory_item_id\"),\r\n+    quantity: parseFloat(formData.get(\"procurement_quantity\")),\r\n+    reason: `Expense: ${expense.description}`\r\n+  });\r\n+}\r\n+```\r\n+\r\n+This creates bidirectional sync:\r\n+- **Expense** â†’ Finance ledger (cost tracking)\r\n+- **Stock Movement** â†’ Inventory (quantity tracking)\r\n+\r\n+**Server Action:**\r\n+```typescript\r\n+// app/actions/inventory.ts\r\n+export async function createStockMovement(formData: FormData) {\r\n+  const itemId = formData.get(\"item_id\");\r\n+  const quantity = parseFloat(formData.get(\"quantity\"));\r\n+  \r\n+  // Get current stock\r\n+  const { data: item } = await supabase\r\n+    .from(\"inventory_items\")\r\n+    .select(\"stock_level, item_name\")\r\n+    .eq(\"id\", itemId)\r\n+    .single();\r\n+  \r\n+  const newStock = item.stock_level + quantity;\r\n+  \r\n+  // Update inventory\r\n+  await supabase\r\n+    .from(\"inventory_items\")\r\n+    .update({ stock_level: newStock })\r\n+    .eq(\"id\", itemId);\r\n+    \r\n+  // Revalidate both pages\r\n+  revalidatePath(\"/inventory\");\r\n+  revalidatePath(\"/finance\");\r\n+}\r\n+```\r\n+\r\n ## Files Modified/Created\r\n \r\n **Created:**\r\n - `app/actions/finance.ts` - Server actions for expenses and loan transactions\r\n"
                },
                {
                    "date": 1763363343220,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -389,69 +389,114 @@\n - **Stock Movement Bridge**: Expense creation can trigger inventory updates via `createStockMovement()` action\r\n \r\n #### The Finance-Inventory Bridge\r\n \r\n-When recording expenses for procurement (e.g., \"Purchase Groundnuts\"), you can simultaneously update inventory using the **Stock Movement** system.\r\n+When recording expenses for procurement (e.g., \"Purchase Groundnuts\"), the system **automatically updates inventory** using **Weighted Average Cost (WAC)** calculation.\r\n \r\n-**Manual Workflow:**\r\n-1. Navigate to `/inventory`\r\n-2. Click **\"+ New Stock Movement\"**\r\n-3. Select item (e.g., Groundnuts)\r\n-4. Enter quantity: `+500` (kg)\r\n-5. Reason: \"Procurement from Gowda Farms - Invoice #GF-2025-045\"\r\n-6. System updates `inventory_items.stock_level`\r\n+**Automated Workflow (ERP Integration):**\r\n+1. Navigate to `/finance`\r\n+2. Click **\"+ Log New Expense\"**\r\n+3. Select Category: **Purchase Groundnuts**\r\n+4. ðŸ“¦ **Inventory Update section appears** (conditional rendering)\r\n+5. Fill procurement details:\r\n+   - Amount: â‚¹80,000\r\n+   - Inventory Item: Groundnuts (dropdown shows current stock)\r\n+   - Quantity Purchased: 1000 kg\r\n+6. Click **\"Add Expense\"**\r\n+7. System performs **two-step transaction**:\r\n+   - **Step 1:** Insert expense record into `expenses` table\r\n+   - **Step 2:** Update `inventory_items` with WAC formula\r\n \r\n-**Future Enhancement (Automated):**\r\n-The Finance expense form will include an optional checkbox:\r\n+**Weighted Average Cost Formula:**\r\n ```typescript\r\n-// When creating expense with type='purchase_groundnuts'\r\n-if (formData.get(\"update_inventory\") === \"true\") {\r\n-  await createStockMovement({\r\n-    item_id: formData.get(\"inventory_item_id\"),\r\n-    quantity: parseFloat(formData.get(\"procurement_quantity\")),\r\n-    reason: `Expense: ${expense.description}`\r\n-  });\r\n-}\r\n+// Current State\r\n+current_stock = 1500 kg\r\n+current_avg_cost = â‚¹78/kg\r\n+current_value = 1500 Ã— 78 = â‚¹117,000\r\n+\r\n+// Purchase\r\n+purchased_quantity = 1000 kg\r\n+purchase_amount = â‚¹80,000\r\n+\r\n+// New State Calculation\r\n+new_stock = current_stock + purchased_quantity\r\n+         = 1500 + 1000 = 2500 kg\r\n+\r\n+new_total_value = current_value + purchase_amount\r\n+                = 117,000 + 80,000 = â‚¹197,000\r\n+\r\n+new_avg_cost = new_total_value / new_stock\r\n+             = 197,000 / 2500 = â‚¹78.8/kg\r\n ```\r\n \r\n-This creates bidirectional sync:\r\n-- **Expense** â†’ Finance ledger (cost tracking)\r\n-- **Stock Movement** â†’ Inventory (quantity tracking)\r\n+**Result:**\r\n+```\r\n+âœ… Expense logged: â‚¹80,000\r\n+âœ… Inventory updated: Groundnuts 1500 â†’ 2500 kg\r\n+âœ… Avg cost updated: â‚¹78 â†’ â‚¹78.8/kg\r\n+âœ… Finance COGS recalculates automatically\r\n+```\r\n \r\n **Server Action:**\r\n ```typescript\r\n-// app/actions/inventory.ts\r\n-export async function createStockMovement(formData: FormData) {\r\n-  const itemId = formData.get(\"item_id\");\r\n-  const quantity = parseFloat(formData.get(\"quantity\"));\r\n-  \r\n-  // Get current stock\r\n+// app/actions/finance.ts\r\n+async function updateInventoryFromPurchase(\r\n+  itemId: string,\r\n+  quantity: number,\r\n+  purchaseAmount: number\r\n+) {\r\n+  // Fetch current state\r\n   const { data: item } = await supabase\r\n     .from(\"inventory_items\")\r\n-    .select(\"stock_level, item_name\")\r\n+    .select(\"stock_level, avg_cost, item_name\")\r\n     .eq(\"id\", itemId)\r\n     .single();\r\n   \r\n-  const newStock = item.stock_level + quantity;\r\n+  const currentStock = item.stock_level;\r\n+  const currentAvgCost = item.avg_cost;\r\n   \r\n+  // Calculate new values\r\n+  const newStock = currentStock + quantity;\r\n+  const currentValue = currentStock * currentAvgCost;\r\n+  const newTotalValue = currentValue + purchaseAmount;\r\n+  const newAvgCost = newTotalValue / newStock;\r\n+  \r\n   // Update inventory\r\n   await supabase\r\n     .from(\"inventory_items\")\r\n-    .update({ stock_level: newStock })\r\n+    .update({\r\n+      stock_level: newStock,\r\n+      avg_cost: newAvgCost\r\n+    })\r\n     .eq(\"id\", itemId);\r\n     \r\n   // Revalidate both pages\r\n   revalidatePath(\"/inventory\");\r\n   revalidatePath(\"/finance\");\r\n }\r\n+\r\n+export async function addExpense(formData: FormData) {\r\n+  // Step 1: Insert expense\r\n+  await supabase.from(\"expenses\").insert([expense]);\r\n+  \r\n+  // Step 2: Update inventory if procurement\r\n+  if (inventoryItemId && procurementQuantity > 0) {\r\n+    await updateInventoryFromPurchase(\r\n+      inventoryItemId,\r\n+      procurementQuantity,\r\n+      amount\r\n+    );\r\n+  }\r\n+}\r\n ```\r\n \r\n ## Files Modified/Created\r\n \r\n **Created:**\r\n-- `app/actions/finance.ts` - Server actions for expenses and loan transactions\r\n-- `components/finance/add-expense-form.tsx` - Expense logging form\r\n+- `app/actions/finance.ts` - Server actions with ERP WAC logic\r\n+- `components/finance/add-expense-form.tsx` - Conditional inventory fields\r\n - `components/finance/loan-management.tsx` - Loan tracking with modals\r\n+- `app/api/inventory-items/route.ts` - API endpoint for inventory dropdown\r\n - `docs/FINANCE-WORKFLOW.md` - This documentation\r\n \r\n **Modified:**\r\n - `app/finance/page.tsx` - Server component with parallel data fetching\r\n"
                }
            ],
            "date": 1763361634206,
            "name": "Commit-0",
            "content": "# Finance Module Workflow\r\n\r\n## Overview\r\nThe Finance module provides real-time profitability tracking, expense management, loan accounting, and dynamic COGS (Cost of Goods Sold) calculation for the peanut oil production business.\r\n\r\n## Architecture\r\n\r\n### Database Schema\r\n```sql\r\n-- Expense tracking\r\nCREATE TABLE expenses (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  expense_type TEXT NOT NULL,  -- 'purchase_groundnuts', 'transport', 'labor', 'maintenance', 'utilities'\r\n  amount NUMERIC NOT NULL,\r\n  expense_date DATE NOT NULL,\r\n  status TEXT DEFAULT 'paid',  -- 'paid' or 'unpaid'\r\n  description TEXT,\r\n  created_at TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n\r\n-- Loan management\r\nCREATE TABLE loans (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  lender_name TEXT NOT NULL,\r\n  initial_amount NUMERIC NOT NULL,\r\n  current_balance NUMERIC NOT NULL,\r\n  interest_rate_pa NUMERIC,  -- Annual interest percentage\r\n  created_at TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n\r\n-- Loan transaction history\r\nCREATE TABLE loan_transactions (\r\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\r\n  loan_id UUID NOT NULL REFERENCES loans ON DELETE CASCADE,\r\n  type TEXT NOT NULL,  -- 'payment' or 'interest'\r\n  amount NUMERIC NOT NULL,\r\n  date TIMESTAMPTZ DEFAULT NOW()\r\n);\r\n```\r\n\r\n### Dynamic COGS Calculation\r\nThe system uses a PostgreSQL stored function to calculate real-time bulk oil cost:\r\n\r\n```sql\r\nCREATE OR REPLACE FUNCTION get_bulk_oil_cost_per_liter()\r\nRETURNS numeric AS $$\r\nDECLARE\r\n  total_production_expenses numeric;\r\n  total_groundnut_expenses numeric;\r\n  total_oil_liters numeric;\r\n  bulk_cost numeric;\r\nBEGIN\r\n  -- Sum all non-groundnut expenses (transport, labor, utilities, maintenance)\r\n  SELECT COALESCE(SUM(amount), 0)\r\n  INTO total_production_expenses\r\n  FROM expenses\r\n  WHERE expense_type IN ('transport', 'labor', 'utilities', 'maintenance');\r\n\r\n  -- Sum groundnut purchase expenses\r\n  SELECT COALESCE(SUM(amount), 0)\r\n  INTO total_groundnut_expenses\r\n  FROM expenses\r\n  WHERE expense_type = 'purchase_groundnuts';\r\n\r\n  -- Sum total oil produced (liters)\r\n  SELECT COALESCE(SUM(pressing_oil), 0)\r\n  INTO total_oil_liters\r\n  FROM production_batches;\r\n\r\n  IF total_oil_liters = 0 THEN\r\n    RETURN 0;\r\n  END IF;\r\n\r\n  -- Calculate cost per liter\r\n  bulk_cost := (total_production_expenses + total_groundnut_expenses) / total_oil_liters;\r\n  RETURN bulk_cost;\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n```\r\n\r\n## Features Implemented\r\n\r\n### 1. Finance Snapshot Dashboard (`/finance`)\r\nReal-time metrics displayed using server-side rendering:\r\n\r\n**Key Metrics:**\r\n- **Income (Delivered)** - Total revenue from delivered orders\r\n- **Expenses (30d)** - All recorded expenses\r\n- **Net Profit** - Income minus expenses\r\n- **COD Receivables** - Pending cash-on-delivery collections\r\n- **Payables** - Unpaid expenses\r\n\r\n**Data Flow:**\r\n```typescript\r\nconst totalIncome = orders\r\n  .filter(order => order.status === 'delivered')\r\n  .reduce((acc, order) => acc + order.total_amount, 0);\r\n\r\nconst totalExpenses = expenses\r\n  .reduce((acc, expense) => acc + expense.amount, 0);\r\n\r\nconst netProfit = totalIncome - totalExpenses;\r\n```\r\n\r\n### 2. Add Expense Form\r\nComponent: `components/finance/add-expense-form.tsx`\r\n\r\n**Expense Categories:**\r\n- **Purchase Groundnuts** - Raw material procurement\r\n- **Transport** - Delivery and logistics costs\r\n- **Labor** - Wages and worker payments\r\n- **Maintenance** - Equipment repairs and upkeep\r\n- **Utilities** - Electricity, water, gas\r\n\r\n**Form Fields:**\r\n- Date (defaults to today)\r\n- Amount (â‚¹)\r\n- Category (dropdown)\r\n- Status (Paid/Unpaid)\r\n- Notes (optional description)\r\n\r\n**Server Action:**\r\n```typescript\r\n// app/actions/finance.ts\r\nexport async function addExpense(formData: FormData) {\r\n  const expense = {\r\n    expense_type: formData.get(\"expense_type\"),\r\n    amount: parseFloat(formData.get(\"amount\")),\r\n    expense_date: formData.get(\"expense_date\"),\r\n    status: formData.get(\"status\") || \"paid\",\r\n    description: formData.get(\"description\")\r\n  };\r\n  \r\n  await supabase.from(\"expenses\").insert([expense]);\r\n  revalidatePath(\"/finance\");\r\n}\r\n```\r\n\r\n### 3. Loan Management\r\nComponent: `components/finance/loan-management.tsx`\r\n\r\n**Features:**\r\n- View all active loans with current balances\r\n- Log interest charges (increases loan balance)\r\n- Log payments (decreases loan balance)\r\n- Track transaction history\r\n\r\n**Loan Transaction Flow:**\r\n```typescript\r\nexport async function addLoanTransaction(formData: FormData) {\r\n  const type = formData.get(\"type\"); // 'payment' or 'interest'\r\n  const amount = parseFloat(formData.get(\"amount\"));\r\n  \r\n  // Insert transaction record\r\n  await supabase.from(\"loan_transactions\").insert([{\r\n    loan_id: loanId,\r\n    type,\r\n    amount,\r\n    date: new Date().toISOString()\r\n  }]);\r\n  \r\n  // Update loan balance\r\n  const newBalance = type === \"payment\"\r\n    ? currentBalance - amount\r\n    : currentBalance + amount;\r\n    \r\n  await supabase.from(\"loans\")\r\n    .update({ current_balance: newBalance })\r\n    .eq(\"id\", loanId);\r\n}\r\n```\r\n\r\n### 4. Payables & Receivables Tracker\r\nTwo-column card showing cash flow obligations:\r\n\r\n**Payables (Red):**\r\n- Total unpaid expenses\r\n- Helps track vendor dues\r\n\r\n**Receivables (Green):**\r\n- Pending COD collections\r\n- Expected cash inflow from undelivered COD orders\r\n\r\n### 5. Expense Ledger\r\nChronological table of all expenses with:\r\n- Date\r\n- Category (human-readable labels)\r\n- Amount (â‚¹)\r\n- Status badge (Paid/Unpaid)\r\n- Description notes\r\n\r\n### 6. Cost of Goods Sold (COGS) Calculator\r\nDynamic profitability breakdown per SKU:\r\n\r\n**Bulk Oil Cost:**\r\n- Calculated using `get_bulk_oil_cost_per_liter()` RPC\r\n- Updates automatically when expenses or production data changes\r\n\r\n**Per-SKU COGS:**\r\n```typescript\r\nconst cogs1L = bulkOilCostPerLiter * 1 \r\n             + packagingCost(\"Empty 1L Bottle\")\r\n             + packagingCost(\"Labels\");\r\n\r\nconst cogs5L = bulkOilCostPerLiter * 5\r\n             + packagingCost(\"Empty 5L Tin\")\r\n             + packagingCost(\"Labels\");\r\n\r\nconst cogs15L = bulkOilCostPerLiter * 15\r\n              + packagingCost(\"Empty 15L Tin\")\r\n              + packagingCost(\"Labels\");\r\n```\r\n\r\n**Packaging Costs:**\r\nFetched from `inventory_items.avg_cost` for:\r\n- Empty 1L Bottle\r\n- Empty 5L Tin\r\n- Empty 15L Tin\r\n- Labels\r\n\r\n## User Workflows\r\n\r\n### Workflow 1: Log Daily Expense\r\n1. Navigate to `/finance`\r\n2. Click **\"+ Log New Expense\"** button\r\n3. Fill form:\r\n   - Date: Today (pre-filled)\r\n   - Amount: â‚¹5000\r\n   - Category: Transport\r\n   - Status: Paid\r\n   - Notes: \"Delivery to Bangalore customers\"\r\n4. Click **\"Add Expense\"**\r\n5. Page revalidates â†’ Expense appears in ledger\r\n6. Metrics update automatically\r\n\r\n### Workflow 2: Track Loan Payment\r\n1. View **Loan Management** card on finance page\r\n2. Locate loan in table (e.g., \"HDFC Bank - â‚¹500,000 balance\")\r\n3. Click **\"Log Payment\"** button\r\n4. Enter payment amount: â‚¹25,000\r\n5. Click **\"Record Transaction\"**\r\n6. System updates:\r\n   - Inserts transaction to `loan_transactions`\r\n   - Decreases `current_balance` to â‚¹475,000\r\n   - Page refreshes to show new balance\r\n\r\n### Workflow 3: Add Interest Charge\r\n1. Find loan in **Loan Management** table\r\n2. Click **\"Log Interest\"** button\r\n3. Enter interest amount: â‚¹3,500\r\n4. Click **\"Record Transaction\"**\r\n5. System updates:\r\n   - Inserts transaction with `type='interest'`\r\n   - Increases `current_balance` by â‚¹3,500\r\n   - Reflects new balance immediately\r\n\r\n### Workflow 4: Monitor Profitability\r\n1. Check **Finance Snapshot** metrics at page top\r\n2. Review:\r\n   - **Income**: â‚¹145,000 (from delivered orders)\r\n   - **Expenses**: â‚¹98,000 (last 30 days)\r\n   - **Net Profit**: â‚¹47,000\r\n3. Scroll to **COGS Card** to analyze per-unit profit margins\r\n4. Compare selling price vs COGS:\r\n   - 1L Bottle: Sell â‚¹350, COGS â‚¹180 â†’ Margin: â‚¹170\r\n   - 5L Tin: Sell â‚¹1,600, COGS â‚¹920 â†’ Margin: â‚¹680\r\n   - 15L Tin: Sell â‚¹4,500, COGS â‚¹2,800 â†’ Margin: â‚¹1,700\r\n\r\n### Workflow 5: Manage Payables\r\n1. View **Payables & Receivables** card\r\n2. Note **Total Payables**: â‚¹12,000 (unpaid expenses)\r\n3. Click **Expense Ledger** to identify vendors\r\n4. Filter by **Status: UNPAID**\r\n5. Contact vendors to settle dues\r\n6. After payment, edit expense status to \"Paid\"\r\n7. Payables metric decreases automatically\r\n\r\n## Technical Details\r\n\r\n### Server-Side Rendering (SSR)\r\nThe finance page uses Next.js App Router server components for optimal performance:\r\n\r\n```typescript\r\n// app/finance/page.tsx\r\nexport default async function FinancePage() {\r\n  const supabase = await createSupabaseServerClient();\r\n  \r\n  // Parallel data fetching\r\n  const [\r\n    { data: expenses },\r\n    { data: orders },\r\n    { data: loans },\r\n    { data: inventoryItems },\r\n    bulkOilCostResult\r\n  ] = await Promise.all([\r\n    supabase.from(\"expenses\").select(\"*\").order(\"expense_date\", { ascending: false }),\r\n    supabase.from(\"orders\").select(\"*\"),\r\n    supabase.from(\"loans\").select(\"*\"),\r\n    supabase.from(\"inventory_items\").select(\"item_name, avg_cost\"),\r\n    supabase.rpc(\"get_bulk_oil_cost_per_liter\")\r\n  ]);\r\n  \r\n  // Server-side calculations\r\n  const totalIncome = orders\r\n    .filter(order => order.status === 'delivered')\r\n    .reduce((acc, order) => acc + order.total_amount, 0);\r\n    \r\n  return <FinanceDashboard data={{ expenses, orders, ... }} />;\r\n}\r\n```\r\n\r\n### Revalidation Strategy\r\nAfter mutations, `revalidatePath(\"/finance\")` ensures fresh data:\r\n\r\n```typescript\r\nexport async function addExpense(formData: FormData) {\r\n  // ... insert expense\r\n  revalidatePath(\"/finance\");  // Triggers re-render with new data\r\n  return { success: true };\r\n}\r\n```\r\n\r\n### COGS Formula Breakdown\r\n```\r\nBulk Oil Cost = (Total Expenses) / (Total Oil Produced)\r\n              = (Groundnuts + Transport + Labor + Utilities + Maintenance) / (Liters)\r\n\r\n1L COGS = (Bulk Oil Ã— 1L) + Bottle Cost + Label Cost\r\n5L COGS = (Bulk Oil Ã— 5L) + Tin Cost + Label Cost\r\n15L COGS = (Bulk Oil Ã— 15L) + Tin Cost + Label Cost\r\n```\r\n\r\n**Example Calculation:**\r\n```\r\nTotal Expenses: â‚¹98,000\r\nTotal Oil Produced: 550 L\r\nBulk Oil Cost: â‚¹98,000 / 550 = â‚¹178.18/L\r\n\r\n1L Bottle COGS:\r\n  Oil: â‚¹178.18 Ã— 1 = â‚¹178.18\r\n  Bottle: â‚¹15\r\n  Label: â‚¹2\r\n  Total: â‚¹195.18\r\n```\r\n\r\n### Loan Balance Updates\r\nTransaction-based approach prevents race conditions:\r\n\r\n```typescript\r\n// 1. Insert transaction (audit trail)\r\nawait supabase.from(\"loan_transactions\").insert([{\r\n  loan_id: \"abc-123\",\r\n  type: \"payment\",\r\n  amount: 25000,\r\n  date: \"2025-11-17\"\r\n}]);\r\n\r\n// 2. Fetch current balance\r\nconst { data: loan } = await supabase\r\n  .from(\"loans\")\r\n  .select(\"current_balance\")\r\n  .eq(\"id\", \"abc-123\")\r\n  .single();\r\n\r\n// 3. Calculate new balance\r\nconst newBalance = loan.current_balance - 25000;\r\n\r\n// 4. Update loan record\r\nawait supabase.from(\"loans\")\r\n  .update({ current_balance: newBalance })\r\n  .eq(\"id\", \"abc-123\");\r\n```\r\n\r\n## Integration Points\r\n\r\n### With Production Module\r\n- Production batches create `pressing_oil` records\r\n- Finance module queries `production_batches.pressing_oil` for COGS calculation\r\n- Bulk oil cost updates automatically when new batches complete pressing phase\r\n\r\n### With Orders Module\r\n- Delivered orders contribute to **Income** metric\r\n- COD orders with `status != 'delivered'` show in **Receivables**\r\n- Payment status tracked separately from delivery status\r\n\r\n### With Inventory Module\r\n- Packaging costs fetched from `inventory_items.avg_cost`\r\n- Supports dynamic pricing (e.g., if bottle supplier raises prices, COGS updates instantly)\r\n\r\n## Files Modified/Created\r\n\r\n**Created:**\r\n- `app/actions/finance.ts` - Server actions for expenses and loan transactions\r\n- `components/finance/add-expense-form.tsx` - Expense logging form\r\n- `components/finance/loan-management.tsx` - Loan tracking with modals\r\n- `docs/FINANCE-WORKFLOW.md` - This documentation\r\n\r\n**Modified:**\r\n- `app/finance/page.tsx` - Server component with parallel data fetching\r\n- `supabase/schema.sql` - Added `get_bulk_oil_cost_per_liter()` function\r\n\r\n## Testing Checklist\r\n\r\n- [ ] Add expense with all categories (groundnuts, transport, labor, maintenance, utilities)\r\n- [ ] Verify expense appears in ledger immediately\r\n- [ ] Check metrics update: Expenses â†‘, Net Profit â†“\r\n- [ ] Toggle expense status (Paid â†” Unpaid), verify Payables updates\r\n- [ ] Create loan record in Supabase\r\n- [ ] Log payment on loan, verify balance decreases\r\n- [ ] Log interest on loan, verify balance increases\r\n- [ ] Check transaction history persists in `loan_transactions`\r\n- [ ] Complete production batch, verify Bulk Oil Cost recalculates\r\n- [ ] Update `inventory_items.avg_cost` for bottle, verify COGS updates\r\n- [ ] Mark order as delivered, verify Income increases\r\n- [ ] Create COD order, verify appears in Receivables\r\n\r\n## Future Enhancements\r\n\r\n1. **Profit & Loss Statement** - Monthly P&L report with category breakdowns\r\n2. **Cash Flow Forecast** - Predict next 30/60/90 days cash position\r\n3. **Expense Analytics** - Charts showing expense trends by category\r\n4. **Budget Tracking** - Set monthly budgets and track variance\r\n5. **Invoice Generation** - Auto-generate PDF invoices for delivered orders\r\n6. **Tax Calculation** - GST tracking and quarterly reporting\r\n7. **Bank Reconciliation** - Match recorded transactions with bank statements\r\n8. **Multi-Currency Support** - Handle forex if exporting products\r\n9. **Loan Amortization Schedule** - Auto-calculate EMI and interest splits\r\n10. **Profitability by Customer** - Identify most/least profitable customers\r\n\r\n## Formulas Reference\r\n\r\n### Key Financial Metrics\r\n```typescript\r\n// Revenue Recognition\r\nIncome = Î£(orders.total_amount WHERE status = 'delivered')\r\n\r\n// Total Operating Expenses\r\nExpenses = Î£(expenses.amount)\r\n\r\n// Bottom Line\r\nNet Profit = Income - Expenses\r\n\r\n// Outstanding Collections\r\nReceivables = Î£(orders.total_amount WHERE payment_status = 'cod' AND status != 'delivered')\r\n\r\n// Vendor Dues\r\nPayables = Î£(expenses.amount WHERE status = 'unpaid')\r\n```\r\n\r\n### COGS Components\r\n```typescript\r\n// Base Oil Cost\r\nBulk Oil Cost/L = (Î£ expenses.amount) / (Î£ production_batches.pressing_oil)\r\n\r\n// Packaging Costs (from inventory_items.avg_cost)\r\nBottle 1L Cost = inventory_items[name='Empty 1L Bottle'].avg_cost\r\nTin 5L Cost = inventory_items[name='Empty 5L Tin'].avg_cost\r\nTin 15L Cost = inventory_items[name='Empty 15L Tin'].avg_cost\r\nLabel Cost = inventory_items[name='Labels'].avg_cost\r\n\r\n// Total COGS per SKU\r\nCOGS(1L) = (Bulk Oil Cost Ã— 1) + Bottle 1L Cost + Label Cost\r\nCOGS(5L) = (Bulk Oil Cost Ã— 5) + Tin 5L Cost + Label Cost\r\nCOGS(15L) = (Bulk Oil Cost Ã— 15) + Tin 15L Cost + Label Cost\r\n```\r\n\r\n### Loan Calculations\r\n```typescript\r\n// Balance after payment\r\nNew Balance = Current Balance - Payment Amount\r\n\r\n// Balance after interest charge\r\nNew Balance = Current Balance + Interest Amount\r\n\r\n// Total loan obligation\r\nTotal Debt = Î£(loans.current_balance)\r\n```\r\n\r\n## Related Documentation\r\n- [Production Workflow](./PRODUCTION-WORKFLOW.md) - How oil costs feed into COGS\r\n- [CRM Implementation](./CRM-IMPLEMENTATION.md) - How orders affect income\r\n- [Quick Start Guide](./QUICK-START-GUIDE.md) - Initial setup\r\n- [Database Schema](../supabase/schema.sql) - Full schema reference\r\n"
        }
    ]
}