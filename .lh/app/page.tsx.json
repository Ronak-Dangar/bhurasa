{
    "sourceFile": "app/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763069565216,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763136497257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -3,58 +3,73 @@\n import { MetricCard } from \"@/components/ui/metric-card\";\n import { Card } from \"@/components/ui/card\";\n import { Badge } from \"@/components/ui/badge\";\n import { Table, THead, TBody, TH, TD } from \"@/components/ui/table\";\n-import {\n-  buildPipelineAlerts,\n-  summarizeFinancials,\n-  summarizeOrderPipeline,\n-} from \"@/lib/analytics\";\n-import {\n-  customers,\n-  deliveryAssignments,\n-  expenses,\n-  inventoryItems,\n-  orders,\n-  productionBatches,\n-} from \"@/lib/sample-data\";\n+import { buildPipelineAlerts } from \"@/lib/analytics\";\n import type { PipelineAlert } from \"@/types\";\n+import { createSupabaseServerClient } from \"@/lib/supabase/server\";\n \n-export default function Home() {\n+export default async function Home() {\n+  const supabase = await createSupabaseServerClient();\n+\n+  // Fetch all required data in parallel\n+  const [\n+    { data: customers },\n+    { data: orders },\n+    { data: inventoryItems },\n+    { data: deliveryAssignments },\n+    { data: expenses },\n+    { data: productionBatches },\n+  ] = await Promise.all([\n+    supabase.from(\"customers\").select(\"*\"),\n+    supabase.from(\"orders\").select(\"*\"),\n+    supabase.from(\"inventory_items\").select(\"*\"),\n+    supabase.from(\"delivery_assignments\").select(\"*\"),\n+    supabase.from(\"expenses\").select(\"*\").gte(\"expense_date\", new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()),\n+    supabase.from(\"production_batches\").select(\"*\").order(\"production_date\", { ascending: false }),\n+  ]);\n+\n+  // Calculate financials\n+  const deliveredOrders = orders?.filter((o) => o.status === \"delivered\") ?? [];\n+  const totalIncome = deliveredOrders.reduce((sum, o) => sum + o.total_price, 0);\n+  const totalExpenses = expenses?.reduce((sum, e) => sum + e.amount, 0) ?? 0;\n+  const netProfit = totalIncome - totalExpenses;\n+\n+  // Calculate order pipeline\n+  const openOrders = orders?.filter((o) => o.status !== \"delivered\" && o.status !== \"cancelled\") ?? [];\n+  const openCount = openOrders.length;\n+\n   const alerts = buildPipelineAlerts({\n-    customers,\n-    orders,\n-    inventory: inventoryItems,\n-    assignments: deliveryAssignments,\n+    customers: customers ?? [],\n+    orders: orders ?? [],\n+    inventory: inventoryItems ?? [],\n+    assignments: deliveryAssignments ?? [],\n   });\n \n   const nurtureAlerts = alerts.filter((alert) => alert.type === \"nurture\");\n   const retentionAlerts = alerts.filter((alert) => alert.type === \"retention\");\n   const inventoryAlerts = alerts.filter((alert) => alert.type === \"inventory\");\n   const deliveryAlerts = alerts.filter((alert) => alert.type === \"delivery\");\n \n-  const financials = summarizeFinancials(orders, expenses);\n-  const orderPipeline = summarizeOrderPipeline(orders);\n-\n-  const lowStockItems = inventoryItems.filter((item) => item.stockLevel < item.lowStockThreshold);\n+  const lowStockItems = inventoryItems?.filter((item) => item.current_stock < item.low_stock_threshold) ?? [];\n   const upcomingRefills = customers\n-    .filter((customer) => customer.status === \"refill_due\" || customer.nextRefillDate)\n-    .slice(0, 6);\n+    ?.filter((customer) => customer.status === \"refill_due\" || customer.next_refill_date)\n+    .slice(0, 6) ?? [];\n \n   return (\n     <div className=\"mx-auto flex max-w-7xl flex-col gap-6\">\n       <section className=\"grid gap-4 md:grid-cols-2 xl:grid-cols-4\">\n         <MetricCard\n           label=\"Net Profit (30d)\"\n-          value={`₹${financials.net.toLocaleString(\"en-IN\")}`}\n+          value={`₹${netProfit.toLocaleString(\"en-IN\")}`}\n           caption=\"Income minus expenses\"\n           trend=\"↑ 12.4% vs last cycle\"\n           icon={Wallet}\n-          tone={financials.net > 0 ? \"success\" : \"danger\"}\n+          tone={netProfit > 0 ? \"success\" : \"danger\"}\n         />\n         <MetricCard\n           label=\"Orders in Flight\"\n-          value={`${orderPipeline.openCount}`}\n+          value={`${openCount}`}\n           caption=\"Pending fulfilment\"\n           icon={Truck}\n         />\n         <MetricCard\n@@ -110,25 +125,25 @@\n                 <TH>Output</TH>\n               </tr>\n             </THead>\n             <TBody>\n-              {productionBatches.map((batch) => (\n+              {productionBatches?.map((batch) => (\n                 <tr key={batch.id}>\n                   <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\n-                    <div>{batch.id.toUpperCase()}</div>\n-                    <div className=\"text-xs text-zinc-500\">{new Date(batch.date).toLocaleDateString()}</div>\n+                    <div>{batch.batch_code.toUpperCase()}</div>\n+                    <div className=\"text-xs text-zinc-500\">{new Date(batch.production_date).toLocaleDateString()}</div>\n                   </TD>\n                   <TD>\n                     <Badge variant=\"neutral\" className=\"uppercase\">\n-                      {batch.phase}\n+                      {batch.current_phase}\n                     </Badge>\n-                    {batch.farmerName && (\n-                      <div className=\"text-xs text-zinc-500\">{batch.farmerName}</div>\n+                    {batch.farmer_name && (\n+                      <div className=\"text-xs text-zinc-500\">{batch.farmer_name}</div>\n                     )}\n                   </TD>\n-                  <TD>{batch.inputQuantityKg} kg</TD>\n+                  <TD>{batch.input_groundnuts_kg} kg</TD>\n                   <TD>\n-                    {batch.outputOilLiters ? `${batch.outputOilLiters} L Oil` : \"Pending\"}\n+                    {batch.output_oil_liters ? `${batch.output_oil_liters} L Oil` : \"Pending\"}\n                   </TD>\n                 </tr>\n               ))}\n             </TBody>\n@@ -154,10 +169,10 @@\n                   <TD>\n                     <Badge variant=\"info\">{formatStatus(customer.status)}</Badge>\n                   </TD>\n                   <TD>\n-                    {customer.nextRefillDate\n-                      ? new Date(customer.nextRefillDate).toLocaleDateString()\n+                    {customer.next_refill_date\n+                      ? new Date(customer.next_refill_date).toLocaleDateString()\n                       : \"Calculate\"}\n                   </TD>\n                 </tr>\n               ))}\n"
                },
                {
                    "date": 1763302823090,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -18,27 +18,30 @@\n     { data: inventoryItems },\n     { data: deliveryAssignments },\n     { data: expenses },\n     { data: productionBatches },\n+    { count: leadsToNurtureCount },\n+    { count: ordersInFlightCount },\n+    { data: upcomingRefillsData },\n   ] = await Promise.all([\n     supabase.from(\"customers\").select(\"*\"),\n     supabase.from(\"orders\").select(\"*\"),\n     supabase.from(\"inventory_items\").select(\"*\"),\n     supabase.from(\"delivery_assignments\").select(\"*\"),\n     supabase.from(\"expenses\").select(\"*\").gte(\"expense_date\", new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString()),\n-    supabase.from(\"production_batches\").select(\"*\").order(\"production_date\", { ascending: false }),\n+    supabase.from(\"production_batches\").select(\"*\").order(\"batch_date\", { ascending: false }),\n+    // Command Center Widget Queries\n+    supabase.from(\"customers\").select(\"*\", { count: \"exact\", head: true }).in(\"status\", [\"inquiry\", \"education\", \"price_sent\", \"trust_process\"]),\n+    supabase.from(\"orders\").select(\"*\", { count: \"exact\", head: true }).in(\"status\", [\"pending\", \"processing\", \"out_for_delivery\"]),\n+    supabase.from(\"customers\").select(\"name, phone, status, next_refill_date\").or(`status.eq.refill_due,next_refill_date.lte.${new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}`).order(\"next_refill_date\", { ascending: true }).limit(5),\n   ]);\n \n   // Calculate financials\n   const deliveredOrders = orders?.filter((o) => o.status === \"delivered\") ?? [];\n-  const totalIncome = deliveredOrders.reduce((sum, o) => sum + o.total_price, 0);\n+  const totalIncome = deliveredOrders.reduce((sum, o) => sum + o.total_amount, 0);\n   const totalExpenses = expenses?.reduce((sum, e) => sum + e.amount, 0) ?? 0;\n   const netProfit = totalIncome - totalExpenses;\n \n-  // Calculate order pipeline\n-  const openOrders = orders?.filter((o) => o.status !== \"delivered\" && o.status !== \"cancelled\") ?? [];\n-  const openCount = openOrders.length;\n-\n   const alerts = buildPipelineAlerts({\n     customers: customers ?? [],\n     orders: orders ?? [],\n     inventory: inventoryItems ?? [],\n@@ -49,12 +52,10 @@\n   const retentionAlerts = alerts.filter((alert) => alert.type === \"retention\");\n   const inventoryAlerts = alerts.filter((alert) => alert.type === \"inventory\");\n   const deliveryAlerts = alerts.filter((alert) => alert.type === \"delivery\");\n \n-  const lowStockItems = inventoryItems?.filter((item) => item.current_stock < item.low_stock_threshold) ?? [];\n-  const upcomingRefills = customers\n-    ?.filter((customer) => customer.status === \"refill_due\" || customer.next_refill_date)\n-    .slice(0, 6) ?? [];\n+  const lowStockItems = inventoryItems?.filter((item) => item.stock_level < item.low_stock_threshold) ?? [];\n+  const upcomingRefills = upcomingRefillsData ?? [];\n \n   return (\n     <div className=\"mx-auto flex max-w-7xl flex-col gap-6\">\n       <section className=\"grid gap-4 md:grid-cols-2 xl:grid-cols-4\">\n@@ -67,18 +68,18 @@\n           tone={netProfit > 0 ? \"success\" : \"danger\"}\n         />\n         <MetricCard\n           label=\"Orders in Flight\"\n-          value={`${openCount}`}\n+          value={`${ordersInFlightCount ?? 0}`}\n           caption=\"Pending fulfilment\"\n           icon={Truck}\n         />\n         <MetricCard\n           label=\"Leads to Nurture\"\n-          value={`${nurtureAlerts.length}`}\n+          value={`${leadsToNurtureCount ?? 0}`}\n           caption=\"Still waiting for follow-up\"\n           icon={ClipboardCheck}\n-          tone={nurtureAlerts.length > 0 ? \"warning\" : \"default\"}\n+          tone={(leadsToNurtureCount ?? 0) > 0 ? \"warning\" : \"default\"}\n         />\n         <MetricCard\n           label=\"Low Stock Items\"\n           value={`${lowStockItems.length}`}\n@@ -129,13 +130,13 @@\n               {productionBatches?.map((batch) => (\n                 <tr key={batch.id}>\n                   <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\n                     <div>{batch.batch_code.toUpperCase()}</div>\n-                    <div className=\"text-xs text-zinc-500\">{new Date(batch.production_date).toLocaleDateString()}</div>\n+                    <div className=\"text-xs text-zinc-500\">{new Date(batch.batch_date).toLocaleDateString()}</div>\n                   </TD>\n                   <TD>\n                     <Badge variant=\"neutral\" className=\"uppercase\">\n-                      {batch.current_phase}\n+                      {batch.phase}\n                     </Badge>\n                     {batch.farmer_name && (\n                       <div className=\"text-xs text-zinc-500\">{batch.farmer_name}</div>\n                     )}\n@@ -159,10 +160,10 @@\n                 <TH>Next Refill</TH>\n               </tr>\n             </THead>\n             <TBody>\n-              {upcomingRefills.map((customer) => (\n-                <tr key={customer.id}>\n+              {upcomingRefills.map((customer, index) => (\n+                <tr key={index}>\n                   <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\n                     <div>{customer.name}</div>\n                     <div className=\"text-xs text-zinc-500\">{customer.phone}</div>\n                   </TD>\n"
                }
            ],
            "date": 1763069565216,
            "name": "Commit-0",
            "content": "import { AlertTriangle, ClipboardCheck, Factory, Truck, Wallet } from \"lucide-react\";\nimport type { ComponentType } from \"react\";\nimport { MetricCard } from \"@/components/ui/metric-card\";\nimport { Card } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, THead, TBody, TH, TD } from \"@/components/ui/table\";\nimport {\n  buildPipelineAlerts,\n  summarizeFinancials,\n  summarizeOrderPipeline,\n} from \"@/lib/analytics\";\nimport {\n  customers,\n  deliveryAssignments,\n  expenses,\n  inventoryItems,\n  orders,\n  productionBatches,\n} from \"@/lib/sample-data\";\nimport type { PipelineAlert } from \"@/types\";\n\nexport default function Home() {\n  const alerts = buildPipelineAlerts({\n    customers,\n    orders,\n    inventory: inventoryItems,\n    assignments: deliveryAssignments,\n  });\n\n  const nurtureAlerts = alerts.filter((alert) => alert.type === \"nurture\");\n  const retentionAlerts = alerts.filter((alert) => alert.type === \"retention\");\n  const inventoryAlerts = alerts.filter((alert) => alert.type === \"inventory\");\n  const deliveryAlerts = alerts.filter((alert) => alert.type === \"delivery\");\n\n  const financials = summarizeFinancials(orders, expenses);\n  const orderPipeline = summarizeOrderPipeline(orders);\n\n  const lowStockItems = inventoryItems.filter((item) => item.stockLevel < item.lowStockThreshold);\n  const upcomingRefills = customers\n    .filter((customer) => customer.status === \"refill_due\" || customer.nextRefillDate)\n    .slice(0, 6);\n\n  return (\n    <div className=\"mx-auto flex max-w-7xl flex-col gap-6\">\n      <section className=\"grid gap-4 md:grid-cols-2 xl:grid-cols-4\">\n        <MetricCard\n          label=\"Net Profit (30d)\"\n          value={`₹${financials.net.toLocaleString(\"en-IN\")}`}\n          caption=\"Income minus expenses\"\n          trend=\"↑ 12.4% vs last cycle\"\n          icon={Wallet}\n          tone={financials.net > 0 ? \"success\" : \"danger\"}\n        />\n        <MetricCard\n          label=\"Orders in Flight\"\n          value={`${orderPipeline.openCount}`}\n          caption=\"Pending fulfilment\"\n          icon={Truck}\n        />\n        <MetricCard\n          label=\"Leads to Nurture\"\n          value={`${nurtureAlerts.length}`}\n          caption=\"Still waiting for follow-up\"\n          icon={ClipboardCheck}\n          tone={nurtureAlerts.length > 0 ? \"warning\" : \"default\"}\n        />\n        <MetricCard\n          label=\"Low Stock Items\"\n          value={`${lowStockItems.length}`}\n          caption=\"Below safety threshold\"\n          icon={Factory}\n          tone={lowStockItems.length > 0 ? \"warning\" : \"default\"}\n        />\n      </section>\n\n      <section className=\"grid gap-6 lg:grid-cols-5\">\n        <Card className=\"lg:col-span-3\" title=\"Pipeline Alerts\" description=\"Prioritise these tasks to retain trust.\" actions={<Badge variant=\"info\">Live</Badge>}>\n          <div className=\"space-y-6\">\n            <AlertColumn title=\"Nurture\" alerts={nurtureAlerts} />\n            <AlertColumn title=\"Retention\" alerts={retentionAlerts} />\n            <AlertColumn title=\"Inventory\" alerts={inventoryAlerts} />\n            <AlertColumn title=\"Delivery\" alerts={deliveryAlerts} />\n          </div>\n        </Card>\n\n        <Card\n          className=\"lg:col-span-2\"\n          title=\"Next Actions\"\n          description=\"Focus for the next 4 hours\"\n        >\n          <div className=\"space-y-4 text-sm text-zinc-600 dark:text-zinc-300\">\n            <ActionRow icon={AlertTriangle} message=\"Send health benefits deck to 2 inquiry leads.\" />\n            <ActionRow icon={Truck} message=\"Confirm COD payment for Order 2102 after delivery.\" />\n            <ActionRow icon={Factory} message=\"Prepare labels for Batch 24A bottling completion.\" />\n          </div>\n        </Card>\n      </section>\n\n      <section className=\"grid gap-6 lg:grid-cols-2\">\n        <Card\n          title=\"Production Timeline\"\n          description=\"Track batches from groundnut to bottle.\"\n        >\n          <Table>\n            <THead>\n              <tr>\n                <TH>Batch</TH>\n                <TH>Phase</TH>\n                <TH>Input</TH>\n                <TH>Output</TH>\n              </tr>\n            </THead>\n            <TBody>\n              {productionBatches.map((batch) => (\n                <tr key={batch.id}>\n                  <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\n                    <div>{batch.id.toUpperCase()}</div>\n                    <div className=\"text-xs text-zinc-500\">{new Date(batch.date).toLocaleDateString()}</div>\n                  </TD>\n                  <TD>\n                    <Badge variant=\"neutral\" className=\"uppercase\">\n                      {batch.phase}\n                    </Badge>\n                    {batch.farmerName && (\n                      <div className=\"text-xs text-zinc-500\">{batch.farmerName}</div>\n                    )}\n                  </TD>\n                  <TD>{batch.inputQuantityKg} kg</TD>\n                  <TD>\n                    {batch.outputOilLiters ? `${batch.outputOilLiters} L Oil` : \"Pending\"}\n                  </TD>\n                </tr>\n              ))}\n            </TBody>\n          </Table>\n        </Card>\n\n        <Card title=\"Upcoming Refills\" description=\"Stay ahead of customer consumption cycles.\">\n          <Table>\n            <THead>\n              <tr>\n                <TH>Customer</TH>\n                <TH>Status</TH>\n                <TH>Next Refill</TH>\n              </tr>\n            </THead>\n            <TBody>\n              {upcomingRefills.map((customer) => (\n                <tr key={customer.id}>\n                  <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\n                    <div>{customer.name}</div>\n                    <div className=\"text-xs text-zinc-500\">{customer.phone}</div>\n                  </TD>\n                  <TD>\n                    <Badge variant=\"info\">{formatStatus(customer.status)}</Badge>\n                  </TD>\n                  <TD>\n                    {customer.nextRefillDate\n                      ? new Date(customer.nextRefillDate).toLocaleDateString()\n                      : \"Calculate\"}\n                  </TD>\n                </tr>\n              ))}\n            </TBody>\n          </Table>\n        </Card>\n      </section>\n    </div>\n  );\n}\n\ninterface AlertColumnProps {\n  title: string;\n  alerts: PipelineAlert[];\n}\n\nfunction AlertColumn({ title, alerts }: AlertColumnProps) {\n  if (alerts.length === 0) {\n    return (\n      <div>\n        <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">{title}</p>\n        <p className=\"text-sm text-zinc-500 dark:text-zinc-400\">All clear.</p>\n      </div>\n    );\n  }\n\n  return (\n    <div>\n      <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">{title}</p>\n      <ul className=\"mt-2 space-y-2 text-sm text-zinc-600 dark:text-zinc-300\">\n        {alerts.map((alert) => (\n          <li key={alert.id} className=\"flex items-start justify-between rounded-lg bg-emerald-50/60 px-3 py-2 dark:bg-emerald-950/40\">\n            <span>{alert.message}</span>\n            <Badge variant={alert.severity === \"critical\" ? \"danger\" : alert.severity === \"warning\" ? \"warning\" : \"info\"}>\n              {alert.severity.toUpperCase()}\n            </Badge>\n          </li>\n        ))}\n      </ul>\n    </div>\n  );\n}\n\ninterface ActionRowProps {\n  icon: ComponentType<{ size?: number }>;\n  message: string;\n}\n\nfunction ActionRow({ icon: Icon, message }: ActionRowProps) {\n  return (\n    <div className=\"flex items-center gap-3 rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\n      <span className=\"rounded-full bg-emerald-500/15 p-2 text-emerald-600 dark:bg-emerald-900/40 dark:text-emerald-200\">\n        <Icon size={16} />\n      </span>\n      <span>{message}</span>\n    </div>\n  );\n}\n\nfunction formatStatus(status: string) {\n  return status\n    .split(\"_\")\n    .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1))\n    .join(\" \");\n}\n"
        }
    ]
}