{
    "sourceFile": "app/finance/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763069565217,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763136497279,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,12 @@\n import { PiggyBank, TrendingUp, Wallet } from \"lucide-react\";\r\n import { MetricCard } from \"@/components/ui/metric-card\";\r\n import { Card } from \"@/components/ui/card\";\r\n+import { Badge } from \"@/components/ui/badge\";\r\n import { Table, THead, TBody, TH, TD } from \"@/components/ui/table\";\r\n-import { expenses, orders } from \"@/lib/sample-data\";\r\n-import { summarizeFinancials } from \"@/lib/analytics\";\r\n+import { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\n+import { AddExpenseForm } from \"@/components/finance/add-expense-form\";\r\n+import { LoanManagement } from \"@/components/finance/loan-management\";\r\n \r\n const expenseLabels: Record<string, string> = {\r\n   purchase_groundnuts: \"Purchase Groundnuts\",\r\n   transport: \"Transport\",\r\n@@ -12,87 +14,194 @@\n   maintenance: \"Maintenance\",\r\n   utilities: \"Utilities\",\r\n };\r\n \r\n-export default function FinancePage() {\r\n-  const financials = summarizeFinancials(orders, expenses);\r\n+export default async function FinancePage() {\r\n+  const supabase = await createSupabaseServerClient();\r\n \r\n-  const codReceivables = orders.filter((order) => order.paymentStatus === \"cod\" && order.status !== \"delivered\").reduce((acc, order) => acc + order.totalAmount, 0);\r\n+  const [\r\n+    { data: expenses },\r\n+    { data: orders },\r\n+    { data: loans },\r\n+    { data: inventoryItems },\r\n+    bulkOilCostResult,\r\n+  ] = await Promise.all([\r\n+    supabase.from(\"expenses\").select(\"*\").order(\"expense_date\", { ascending: false }),\r\n+    supabase.from(\"orders\").select(\"*\"),\r\n+    supabase.from(\"loans\").select(\"*\"),\r\n+    supabase.from(\"inventory_items\").select(\"item_name, avg_cost\"),\r\n+    supabase.rpc(\"get_bulk_oil_cost_per_liter\"),\r\n+  ]);\r\n \r\n+  const allExpenses = expenses ?? [];\r\n+  const allOrders = orders ?? [];\r\n+  const allLoans = loans ?? [];\r\n+  const packagingCosts = inventoryItems ?? [];\r\n+  const bulkOilCostPerLiter = (bulkOilCostResult.data as number) ?? 0;\r\n+\r\n+  const totalIncome = allOrders\r\n+    .filter((order) => order.status === \"delivered\")\r\n+    .reduce((acc, order) => acc + (order.total_amount ?? 0), 0);\r\n+\r\n+  const totalExpenses = allExpenses.reduce((acc, expense) => acc + (expense.amount ?? 0), 0);\r\n+  const netProfit = totalIncome - totalExpenses;\r\n+\r\n+  const codReceivables = allOrders\r\n+    .filter((order) => order.payment_status === \"cod\" && order.status !== \"delivered\")\r\n+    .reduce((acc, order) => acc + (order.total_amount ?? 0), 0);\r\n+\r\n+  const totalPayables = allExpenses\r\n+    .filter((expense) => expense.status === \"unpaid\")\r\n+    .reduce((acc, expense) => acc + (expense.amount ?? 0), 0);\r\n+\r\n+  const getPackagingCost = (itemName: string) => {\r\n+    const item = packagingCosts.find((i) => i.item_name === itemName);\r\n+    return item?.avg_cost ?? 0;\r\n+  };\r\n+\r\n+  const cogs1L = bulkOilCostPerLiter * 1 + getPackagingCost(\"Empty 1L Bottle\") + getPackagingCost(\"Labels\");\r\n+  const cogs5L = bulkOilCostPerLiter * 5 + getPackagingCost(\"Empty 5L Tin\") + getPackagingCost(\"Labels\");\r\n+  const cogs15L = bulkOilCostPerLiter * 15 + getPackagingCost(\"Empty 15L Tin\") + getPackagingCost(\"Labels\");\r\n+\r\n   return (\r\n     <div className=\"space-y-6\">\r\n-      <div>\r\n-        <h2 className=\"text-2xl font-semibold text-zinc-900 dark:text-zinc-100\">Finance Snapshot</h2>\r\n-        <p className=\"mt-1 text-sm text-zinc-500 dark:text-zinc-400\">\r\n-          High-level profitability and cost levers across the oil lifecycle.\r\n-        </p>\r\n+      <div className=\"flex items-center justify-between\">\r\n+        <div>\r\n+          <h2 className=\"text-2xl font-semibold text-zinc-900 dark:text-zinc-100\">Finance Snapshot</h2>\r\n+          <p className=\"mt-1 text-sm text-zinc-500 dark:text-zinc-400\">\r\n+            High-level profitability and cost levers across the oil lifecycle.\r\n+          </p>\r\n+        </div>\r\n+        <AddExpenseForm />\r\n       </div>\r\n \r\n       <section className=\"grid gap-4 md:grid-cols-3\">\r\n         <MetricCard\r\n           label=\"Income (Delivered)\"\r\n-          value={`₹${financials.income.toLocaleString(\"en-IN\")}`}\r\n+          value={`₹${totalIncome.toLocaleString(\"en-IN\")}`}\r\n           caption=\"Collected from prepaid + COD\"\r\n           trend=\"↑ 8.2%\"\r\n           icon={TrendingUp}\r\n           tone=\"success\"\r\n         />\r\n         <MetricCard\r\n           label=\"Expenses (30d)\"\r\n-          value={`₹${financials.expenses.toLocaleString(\"en-IN\")}`}\r\n+          value={`₹${totalExpenses.toLocaleString(\"en-IN\")}`}\r\n           caption=\"Procurement + Ops\"\r\n           icon={PiggyBank}\r\n         />\r\n         <MetricCard\r\n           label=\"Net Profit\"\r\n-          value={`₹${financials.net.toLocaleString(\"en-IN\")}`}\r\n+          value={`₹${netProfit.toLocaleString(\"en-IN\")}`}\r\n           caption={`COD pending ₹${codReceivables.toLocaleString(\"en-IN\")}`}\r\n           icon={Wallet}\r\n-          tone={financials.net > 0 ? \"success\" : \"danger\"}\r\n+          tone={netProfit > 0 ? \"success\" : \"danger\"}\r\n         />\r\n       </section>\r\n \r\n+      <Card title=\"Payables & Receivables\" description=\"Track outstanding obligations and expected cash.\">\r\n+        <div className=\"grid gap-4 md:grid-cols-2\">\r\n+          <div className=\"rounded-lg border border-rose-200 bg-rose-50/60 p-4 dark:border-rose-900/40 dark:bg-rose-950/30\">\r\n+            <p className=\"text-sm font-medium text-rose-700 dark:text-rose-200\">Total Payables</p>\r\n+            <p className=\"mt-2 text-2xl font-semibold text-rose-900 dark:text-rose-100\">\r\n+              ₹{totalPayables.toLocaleString(\"en-IN\")}\r\n+            </p>\r\n+            <p className=\"mt-1 text-xs text-rose-600 dark:text-rose-300\">Unpaid expenses</p>\r\n+          </div>\r\n+          <div className=\"rounded-lg border border-emerald-200 bg-emerald-50/60 p-4 dark:border-emerald-900/40 dark:bg-emerald-950/30\">\r\n+            <p className=\"text-sm font-medium text-emerald-700 dark:text-emerald-200\">Total Receivables</p>\r\n+            <p className=\"mt-2 text-2xl font-semibold text-emerald-900 dark:text-emerald-100\">\r\n+              ₹{codReceivables.toLocaleString(\"en-IN\")}\r\n+            </p>\r\n+            <p className=\"mt-1 text-xs text-emerald-600 dark:text-emerald-300\">Pending COD collections</p>\r\n+          </div>\r\n+        </div>\r\n+      </Card>\r\n+\r\n+      <LoanManagement loans={allLoans} />\r\n+\r\n       <div className=\"grid gap-6 lg:grid-cols-2\">\r\n         <Card title=\"Expense Ledger\" description=\"Where every rupee went this week.\">\r\n           <Table>\r\n             <THead>\r\n               <tr>\r\n                 <TH>Date</TH>\r\n                 <TH>Category</TH>\r\n                 <TH>Amount</TH>\r\n+                <TH>Status</TH>\r\n                 <TH>Notes</TH>\r\n               </tr>\r\n             </THead>\r\n             <TBody>\r\n-              {expenses.map((expense) => (\r\n+              {allExpenses.map((expense) => (\r\n                 <tr key={expense.id}>\r\n                   <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\r\n-                    {new Date(expense.date).toLocaleDateString()}\r\n+                    {new Date(expense.expense_date).toLocaleDateString()}\r\n                   </TD>\r\n-                  <TD>{expenseLabels[expense.type] ?? expense.type}</TD>\r\n+                  <TD>{expenseLabels[expense.expense_type] ?? expense.expense_type}</TD>\r\n                   <TD>₹{expense.amount.toLocaleString(\"en-IN\")}</TD>\r\n+                  <TD>\r\n+                    <Badge variant={expense.status === \"paid\" ? \"success\" : \"warning\"}>\r\n+                      {expense.status.toUpperCase()}\r\n+                    </Badge>\r\n+                  </TD>\r\n                   <TD className=\"text-xs text-zinc-500\">{expense.description ?? \"-\"}</TD>\r\n                 </tr>\r\n               ))}\r\n             </TBody>\r\n           </Table>\r\n         </Card>\r\n \r\n-        <Card title=\"Profitability Insights\" description=\"Quick levers to defend margin.\">\r\n-          <ul className=\"space-y-3 text-sm text-zinc-600 dark:text-zinc-300\">\r\n-            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n-              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">Oil Yield</p>\r\n-              <p className=\"text-xs text-zinc-500\">Batch 24A delivered 62% yield vs target 60%. Maintain farmer mix.</p>\r\n-            </li>\r\n-            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n-              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">Packaging Cost</p>\r\n-              <p className=\"text-xs text-zinc-500\">1L bottle cost at ₹18. Explore MOQ discount with supplier.</p>\r\n-            </li>\r\n-            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n-              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">COD Recovery</p>\r\n-              <p className=\"text-xs text-zinc-500\">₹{codReceivables.toLocaleString(\"en-IN\")} pending. Trigger reminders post shift close.</p>\r\n-            </li>\r\n-          </ul>\r\n+        <Card title=\"Cost of Goods Sold (COGS)\" description=\"Dynamic profitability breakdown per SKU.\">\r\n+          <div className=\"space-y-4 text-sm\">\r\n+            <div className=\"rounded-lg border border-emerald-200 bg-emerald-50/60 p-4 dark:border-emerald-900/40 dark:bg-emerald-950/30\">\r\n+              <p className=\"font-semibold text-emerald-900 dark:text-emerald-100\">Bulk Oil Cost</p>\r\n+              <p className=\"mt-1 text-2xl font-bold text-emerald-700 dark:text-emerald-200\">\r\n+                ₹{bulkOilCostPerLiter.toFixed(2)} / Liter\r\n+              </p>\r\n+              <p className=\"mt-1 text-xs text-emerald-600 dark:text-emerald-300\">\r\n+                Based on production expenses + groundnut costs\r\n+              </p>\r\n+            </div>\r\n+\r\n+            <div className=\"space-y-3\">\r\n+              <div className=\"rounded-lg border border-zinc-200 bg-white p-3 dark:border-zinc-800 dark:bg-zinc-900\">\r\n+                <div className=\"flex items-center justify-between\">\r\n+                  <span className=\"font-semibold text-zinc-900 dark:text-zinc-100\">COGS (1L Bottle)</span>\r\n+                  <span className=\"text-lg font-bold text-zinc-900 dark:text-zinc-100\">\r\n+                    ₹{cogs1L.toFixed(2)}\r\n+                  </span>\r\n+                </div>\r\n+                <p className=\"mt-1 text-xs text-zinc-500\">\r\n+                  Oil: ₹{bulkOilCostPerLiter.toFixed(2)} + Bottle: ₹{getPackagingCost(\"Empty 1L Bottle\")} + Label: ₹{getPackagingCost(\"Labels\")}\r\n+                </p>\r\n+              </div>\r\n+\r\n+              <div className=\"rounded-lg border border-zinc-200 bg-white p-3 dark:border-zinc-800 dark:bg-zinc-900\">\r\n+                <div className=\"flex items-center justify-between\">\r\n+                  <span className=\"font-semibold text-zinc-900 dark:text-zinc-100\">COGS (5L Tin)</span>\r\n+                  <span className=\"text-lg font-bold text-zinc-900 dark:text-zinc-100\">\r\n+                    ₹{cogs5L.toFixed(2)}\r\n+                  </span>\r\n+                </div>\r\n+                <p className=\"mt-1 text-xs text-zinc-500\">\r\n+                  Oil: ₹{(bulkOilCostPerLiter * 5).toFixed(2)} + Tin: ₹{getPackagingCost(\"Empty 5L Tin\")} + Label: ₹{getPackagingCost(\"Labels\")}\r\n+                </p>\r\n+              </div>\r\n+\r\n+              <div className=\"rounded-lg border border-zinc-200 bg-white p-3 dark:border-zinc-800 dark:bg-zinc-900\">\r\n+                <div className=\"flex items-center justify-between\">\r\n+                  <span className=\"font-semibold text-zinc-900 dark:text-zinc-100\">COGS (15L Tin)</span>\r\n+                  <span className=\"text-lg font-bold text-zinc-900 dark:text-zinc-100\">\r\n+                    ₹{cogs15L.toFixed(2)}\r\n+                  </span>\r\n+                </div>\r\n+                <p className=\"mt-1 text-xs text-zinc-500\">\r\n+                  Oil: ₹{(bulkOilCostPerLiter * 15).toFixed(2)} + Tin: ₹{getPackagingCost(\"Empty 15L Tin\")} + Label: ₹{getPackagingCost(\"Labels\")}\r\n+                </p>\r\n+              </div>\r\n+            </div>\r\n+          </div>\r\n         </Card>\r\n       </div>\r\n     </div>\r\n   );\r\n"
                }
            ],
            "date": 1763069565217,
            "name": "Commit-0",
            "content": "import { PiggyBank, TrendingUp, Wallet } from \"lucide-react\";\r\nimport { MetricCard } from \"@/components/ui/metric-card\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Table, THead, TBody, TH, TD } from \"@/components/ui/table\";\r\nimport { expenses, orders } from \"@/lib/sample-data\";\r\nimport { summarizeFinancials } from \"@/lib/analytics\";\r\n\r\nconst expenseLabels: Record<string, string> = {\r\n  purchase_groundnuts: \"Purchase Groundnuts\",\r\n  transport: \"Transport\",\r\n  labor: \"Labor\",\r\n  maintenance: \"Maintenance\",\r\n  utilities: \"Utilities\",\r\n};\r\n\r\nexport default function FinancePage() {\r\n  const financials = summarizeFinancials(orders, expenses);\r\n\r\n  const codReceivables = orders.filter((order) => order.paymentStatus === \"cod\" && order.status !== \"delivered\").reduce((acc, order) => acc + order.totalAmount, 0);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div>\r\n        <h2 className=\"text-2xl font-semibold text-zinc-900 dark:text-zinc-100\">Finance Snapshot</h2>\r\n        <p className=\"mt-1 text-sm text-zinc-500 dark:text-zinc-400\">\r\n          High-level profitability and cost levers across the oil lifecycle.\r\n        </p>\r\n      </div>\r\n\r\n      <section className=\"grid gap-4 md:grid-cols-3\">\r\n        <MetricCard\r\n          label=\"Income (Delivered)\"\r\n          value={`₹${financials.income.toLocaleString(\"en-IN\")}`}\r\n          caption=\"Collected from prepaid + COD\"\r\n          trend=\"↑ 8.2%\"\r\n          icon={TrendingUp}\r\n          tone=\"success\"\r\n        />\r\n        <MetricCard\r\n          label=\"Expenses (30d)\"\r\n          value={`₹${financials.expenses.toLocaleString(\"en-IN\")}`}\r\n          caption=\"Procurement + Ops\"\r\n          icon={PiggyBank}\r\n        />\r\n        <MetricCard\r\n          label=\"Net Profit\"\r\n          value={`₹${financials.net.toLocaleString(\"en-IN\")}`}\r\n          caption={`COD pending ₹${codReceivables.toLocaleString(\"en-IN\")}`}\r\n          icon={Wallet}\r\n          tone={financials.net > 0 ? \"success\" : \"danger\"}\r\n        />\r\n      </section>\r\n\r\n      <div className=\"grid gap-6 lg:grid-cols-2\">\r\n        <Card title=\"Expense Ledger\" description=\"Where every rupee went this week.\">\r\n          <Table>\r\n            <THead>\r\n              <tr>\r\n                <TH>Date</TH>\r\n                <TH>Category</TH>\r\n                <TH>Amount</TH>\r\n                <TH>Notes</TH>\r\n              </tr>\r\n            </THead>\r\n            <TBody>\r\n              {expenses.map((expense) => (\r\n                <tr key={expense.id}>\r\n                  <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\r\n                    {new Date(expense.date).toLocaleDateString()}\r\n                  </TD>\r\n                  <TD>{expenseLabels[expense.type] ?? expense.type}</TD>\r\n                  <TD>₹{expense.amount.toLocaleString(\"en-IN\")}</TD>\r\n                  <TD className=\"text-xs text-zinc-500\">{expense.description ?? \"-\"}</TD>\r\n                </tr>\r\n              ))}\r\n            </TBody>\r\n          </Table>\r\n        </Card>\r\n\r\n        <Card title=\"Profitability Insights\" description=\"Quick levers to defend margin.\">\r\n          <ul className=\"space-y-3 text-sm text-zinc-600 dark:text-zinc-300\">\r\n            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">Oil Yield</p>\r\n              <p className=\"text-xs text-zinc-500\">Batch 24A delivered 62% yield vs target 60%. Maintain farmer mix.</p>\r\n            </li>\r\n            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">Packaging Cost</p>\r\n              <p className=\"text-xs text-zinc-500\">1L bottle cost at ₹18. Explore MOQ discount with supplier.</p>\r\n            </li>\r\n            <li className=\"rounded-lg border border-zinc-200 bg-white p-3 shadow-sm dark:border-zinc-800 dark:bg-zinc-900\">\r\n              <p className=\"font-semibold text-zinc-900 dark:text-zinc-100\">COD Recovery</p>\r\n              <p className=\"text-xs text-zinc-500\">₹{codReceivables.toLocaleString(\"en-IN\")} pending. Trigger reminders post shift close.</p>\r\n            </li>\r\n          </ul>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"
        }
    ]
}