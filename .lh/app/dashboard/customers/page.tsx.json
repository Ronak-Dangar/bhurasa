{
    "sourceFile": "app/dashboard/customers/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763302822985,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763302822985,
            "name": "Commit-0",
            "content": "\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { createSupabaseClient } from \"@/lib/supabase/client\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Table, THead, TBody, TH, TD } from \"@/components/ui/table\";\r\nimport { AddCustomerDialog } from \"@/components/customers/add-customer-dialog\";\r\nimport { CustomerDetailsModal } from \"@/components/customers/customer-details-modal\";\r\nimport type { Customer, LeadStatus } from \"@/types\";\r\nimport { Trash2 } from \"lucide-react\";\r\nimport { deleteCustomer } from \"@/app/actions/customers\";\r\n\r\nconst STATUS_FILTERS: { label: string; value: LeadStatus | \"all\" }[] = [\r\n  { label: \"All\", value: \"all\" },\r\n  { label: \"Inquiry\", value: \"inquiry\" },\r\n  { label: \"Education\", value: \"education\" },\r\n  { label: \"Price Sent\", value: \"price_sent\" },\r\n  { label: \"Trust Process\", value: \"trust_process\" },\r\n  { label: \"Closed Won\", value: \"closed_won\" },\r\n  { label: \"Feedback Pending\", value: \"feedback_pending\" },\r\n  { label: \"Refill Due\", value: \"refill_due\" },\r\n];\r\n\r\nexport default function CustomersPage() {\r\n  const [customers, setCustomers] = useState<Customer[]>([]);\r\n  const [filteredCustomers, setFilteredCustomers] = useState<Customer[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n  const [selectedFilter, setSelectedFilter] = useState<LeadStatus | \"all\">(\"all\");\r\n  const [selectedCustomer, setSelectedCustomer] = useState<Customer | null>(null);\r\n  const [showAddDialog, setShowAddDialog] = useState(false);\r\n  const [deleteConfirm, setDeleteConfirm] = useState<string | null>(null);\r\n\r\n  const supabase = createSupabaseClient();\r\n\r\n  const fetchCustomers = async () => {\r\n    setLoading(true);\r\n    const { data, error } = await supabase\r\n      .from(\"customers\")\r\n      .select(\"*\")\r\n      .order(\"created_at\", { ascending: false });\r\n\r\n    if (!error && data) {\r\n      setCustomers(data);\r\n      setFilteredCustomers(data);\r\n    }\r\n    setLoading(false);\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchCustomers();\r\n\r\n    // Subscribe to real-time changes\r\n    const channel = supabase\r\n      .channel(\"customers-changes\")\r\n      .on(\r\n        \"postgres_changes\",\r\n        { event: \"*\", schema: \"public\", table: \"customers\" },\r\n        () => {\r\n          fetchCustomers();\r\n        }\r\n      )\r\n      .subscribe();\r\n\r\n    return () => {\r\n      supabase.removeChannel(channel);\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (selectedFilter === \"all\") {\r\n      setFilteredCustomers(customers);\r\n    } else {\r\n      setFilteredCustomers(customers.filter((c) => c.status === selectedFilter));\r\n    }\r\n  }, [selectedFilter, customers]);\r\n\r\n  const handleDelete = async (customerId: string) => {\r\n    const result = await deleteCustomer(customerId);\r\n    if (result.success) {\r\n      setDeleteConfirm(null);\r\n      fetchCustomers();\r\n    } else {\r\n      alert(`Error: ${result.error}`);\r\n    }\r\n  };\r\n\r\n  const getStatusBadgeVariant = (status: LeadStatus): \"default\" | \"info\" | \"success\" | \"warning\" | \"danger\" => {\r\n    switch (status) {\r\n      case \"inquiry\":\r\n      case \"education\":\r\n        return \"info\";\r\n      case \"price_sent\":\r\n      case \"trust_process\":\r\n        return \"warning\";\r\n      case \"closed_won\":\r\n        return \"success\";\r\n      case \"feedback_pending\":\r\n        return \"default\";\r\n      case \"refill_due\":\r\n        return \"danger\";\r\n      default:\r\n        return \"default\";\r\n    }\r\n  };\r\n\r\n  const formatStatus = (status: string) => {\r\n    return status\r\n      .split(\"_\")\r\n      .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1))\r\n      .join(\" \");\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-semibold text-zinc-900 dark:text-zinc-100\">Customers</h2>\r\n          <p className=\"mt-1 text-sm text-zinc-500 dark:text-zinc-400\">\r\n            Manage your customer pipeline from inquiry to refill.\r\n          </p>\r\n        </div>\r\n        <button\r\n          onClick={() => setShowAddDialog(true)}\r\n          className=\"rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-500\"\r\n        >\r\n          + Add New Customer\r\n        </button>\r\n      </div>\r\n\r\n      {/* Status Filters */}\r\n      <div className=\"flex flex-wrap gap-2\">\r\n        {STATUS_FILTERS.map((filter) => (\r\n          <button\r\n            key={filter.value}\r\n            onClick={() => setSelectedFilter(filter.value)}\r\n            className={`rounded-lg px-4 py-2 text-sm font-medium transition-colors ${\r\n              selectedFilter === filter.value\r\n                ? \"bg-emerald-600 text-white\"\r\n                : \"bg-zinc-100 text-zinc-700 hover:bg-zinc-200 dark:bg-zinc-800 dark:text-zinc-300 dark:hover:bg-zinc-700\"\r\n            }`}\r\n          >\r\n            {filter.label}\r\n          </button>\r\n        ))}\r\n      </div>\r\n\r\n      <Card title={`${filteredCustomers.length} Customers`} description=\"Click a row to view details\">\r\n        {loading ? (\r\n          <div className=\"py-8 text-center text-sm text-zinc-500\">Loading customers...</div>\r\n        ) : filteredCustomers.length === 0 ? (\r\n          <div className=\"py-8 text-center text-sm text-zinc-500\">No customers found.</div>\r\n        ) : (\r\n          <Table>\r\n            <THead>\r\n              <tr>\r\n                <TH>Name</TH>\r\n                <TH>Phone</TH>\r\n                <TH>Status</TH>\r\n                <TH>Family Size</TH>\r\n                <TH>Next Refill</TH>\r\n                <TH>Actions</TH>\r\n              </tr>\r\n            </THead>\r\n            <TBody>\r\n              {filteredCustomers.map((customer) => (\r\n                <tr\r\n                  key={customer.id}\r\n                  className=\"cursor-pointer hover:bg-zinc-50 dark:hover:bg-zinc-800/50\"\r\n                  onClick={() => setSelectedCustomer(customer)}\r\n                >\r\n                  <TD className=\"font-medium text-zinc-900 dark:text-zinc-100\">\r\n                    <div>{customer.name}</div>\r\n                    <div className=\"text-xs text-zinc-500\">{customer.address}</div>\r\n                  </TD>\r\n                  <TD>{customer.phone}</TD>\r\n                  <TD>\r\n                    <Badge variant={getStatusBadgeVariant(customer.status)}>\r\n                      {formatStatus(customer.status)}\r\n                    </Badge>\r\n                  </TD>\r\n                  <TD className=\"capitalize\">{customer.familySize}</TD>\r\n                  <TD>\r\n                    {customer.nextRefillDate\r\n                      ? new Date(customer.nextRefillDate).toLocaleDateString()\r\n                      : \"â€”\"}\r\n                  </TD>\r\n                  <TD>\r\n                    <button\r\n                      onClick={(e) => {\r\n                        e.stopPropagation();\r\n                        setDeleteConfirm(customer.id);\r\n                      }}\r\n                      className=\"rounded p-1 text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20\"\r\n                      title=\"Delete customer\"\r\n                    >\r\n                      <Trash2 size={16} />\r\n                    </button>\r\n                  </TD>\r\n                </tr>\r\n              ))}\r\n            </TBody>\r\n          </Table>\r\n        )}\r\n      </Card>\r\n\r\n      {/* Add Customer Dialog */}\r\n      {showAddDialog && (\r\n        <AddCustomerDialog\r\n          onClose={() => setShowAddDialog(false)}\r\n          onSuccess={() => {\r\n            setShowAddDialog(false);\r\n            fetchCustomers();\r\n          }}\r\n        />\r\n      )}\r\n\r\n      {/* Customer Details Modal */}\r\n      {selectedCustomer && (\r\n        <CustomerDetailsModal\r\n          customer={selectedCustomer}\r\n          onClose={() => setSelectedCustomer(null)}\r\n          onSuccess={() => {\r\n            setSelectedCustomer(null);\r\n            fetchCustomers();\r\n          }}\r\n        />\r\n      )}\r\n\r\n      {/* Delete Confirmation Modal */}\r\n      {deleteConfirm && (\r\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/50\">\r\n          <div className=\"w-full max-w-md rounded-lg bg-white p-6 shadow-xl dark:bg-zinc-900\">\r\n            <h3 className=\"text-lg font-semibold text-zinc-900 dark:text-zinc-100\">\r\n              Delete Customer?\r\n            </h3>\r\n            <p className=\"mt-2 text-sm text-zinc-600 dark:text-zinc-400\">\r\n              This action cannot be undone. All orders and history will also be deleted.\r\n            </p>\r\n            <div className=\"mt-6 flex justify-end gap-3\">\r\n              <button\r\n                onClick={() => setDeleteConfirm(null)}\r\n                className=\"rounded-lg px-4 py-2 text-sm font-medium text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-800\"\r\n              >\r\n                Cancel\r\n              </button>\r\n              <button\r\n                onClick={() => handleDelete(deleteConfirm)}\r\n                className=\"rounded-lg bg-rose-600 px-4 py-2 text-sm font-semibold text-white hover:bg-rose-500\"\r\n              >\r\n                Delete\r\n              </button>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n"
        }
    ]
}