{
    "sourceFile": "app/actions/customers.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763302822979,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763302822979,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\nimport type { Customer, LeadStatus, FamilySize } from \"@/types\";\r\n\r\nexport async function createCustomer(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const customer = {\r\n    name: formData.get(\"name\") as string,\r\n    phone: formData.get(\"phone\") as string,\r\n    address: formData.get(\"address\") as string,\r\n    family_size: formData.get(\"family_size\") as FamilySize,\r\n    status: \"inquiry\" as LeadStatus, // Default status\r\n  };\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"customers\")\r\n    .insert([customer])\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  // Log the initial status in history\r\n  if (data) {\r\n    await supabase.from(\"customer_status_history\").insert([\r\n      {\r\n        customer_id: data.id,\r\n        status: \"inquiry\",\r\n        notes: \"Customer created\",\r\n      },\r\n    ]);\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/customers\");\r\n  return { success: true, data };\r\n}\r\n\r\nexport async function updateCustomer(customerId: string, formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const updates: any = {\r\n    name: formData.get(\"name\") as string,\r\n    phone: formData.get(\"phone\") as string,\r\n    address: formData.get(\"address\") as string,\r\n    family_size: formData.get(\"family_size\") as FamilySize,\r\n  };\r\n\r\n  const newStatus = formData.get(\"status\") as LeadStatus | null;\r\n  \r\n  // Get current customer to check status change\r\n  const { data: currentCustomer } = await supabase\r\n    .from(\"customers\")\r\n    .select(\"status\")\r\n    .eq(\"id\", customerId)\r\n    .single();\r\n\r\n  if (newStatus && currentCustomer && newStatus !== currentCustomer.status) {\r\n    updates.status = newStatus;\r\n  }\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"customers\")\r\n    .update(updates)\r\n    .eq(\"id\", customerId)\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  // Log status change if it occurred\r\n  if (newStatus && currentCustomer && newStatus !== currentCustomer.status) {\r\n    await supabase.from(\"customer_status_history\").insert([\r\n      {\r\n        customer_id: customerId,\r\n        status: newStatus,\r\n        notes: `Status manually updated from ${currentCustomer.status} to ${newStatus}`,\r\n      },\r\n    ]);\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/customers\");\r\n  return { success: true, data };\r\n}\r\n\r\nexport async function deleteCustomer(customerId: string) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const { error } = await supabase\r\n    .from(\"customers\")\r\n    .delete()\r\n    .eq(\"id\", customerId);\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  revalidatePath(\"/dashboard/customers\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function getCustomerStatusHistory(customerId: string) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"customer_status_history\")\r\n    .select(\"*\")\r\n    .eq(\"customer_id\", customerId)\r\n    .order(\"changed_at\", { ascending: false });\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: [] };\r\n  }\r\n\r\n  return { success: true, data };\r\n}\r\n"
        }
    ]
}