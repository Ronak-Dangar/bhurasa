{
    "sourceFile": "app/actions/finance.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763136497224,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763363343229,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,27 +2,126 @@\n \r\n import { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\n import { revalidatePath } from \"next/cache\";\r\n \r\n+/**\r\n+ * Weighted Average Cost (WAC) Calculation for ERP Integration\r\n+ * \r\n+ * Updates inventory stock level and avg_cost when procurement expenses are logged.\r\n+ * \r\n+ * Formula:\r\n+ * new_avg_cost = (current_value + purchase_amount) / (current_stock + purchased_quantity)\r\n+ * \r\n+ * Example:\r\n+ * - Current: 1500 kg @ ₹78/kg = ₹117,000\r\n+ * - Purchase: 1000 kg for ₹80,000\r\n+ * - New: 2500 kg @ ₹78.8/kg = ₹197,000\r\n+ */\r\n+async function updateInventoryFromPurchase(\r\n+  itemId: string,\r\n+  quantity: number,\r\n+  purchaseAmount: number\r\n+) {\r\n+  const supabase = await createSupabaseServerClient();\r\n+\r\n+  // Step 1: Fetch current inventory state\r\n+  const { data: item, error: fetchError } = await supabase\r\n+    .from(\"inventory_items\")\r\n+    .select(\"stock_level, avg_cost, item_name\")\r\n+    .eq(\"id\", itemId)\r\n+    .single();\r\n+\r\n+  if (fetchError || !item) {\r\n+    throw new Error(\"Inventory item not found\");\r\n+  }\r\n+\r\n+  const currentStock = item.stock_level;\r\n+  const currentAvgCost = item.avg_cost;\r\n+\r\n+  // Step 2: Calculate new stock level\r\n+  const newStock = currentStock + quantity;\r\n+\r\n+  // Step 3: Calculate weighted average cost\r\n+  const currentValue = currentStock * currentAvgCost;\r\n+  const newTotalValue = currentValue + purchaseAmount;\r\n+  const newAvgCost = newStock > 0 ? newTotalValue / newStock : 0;\r\n+\r\n+  // Step 4: Update inventory_items table\r\n+  const { error: updateError } = await supabase\r\n+    .from(\"inventory_items\")\r\n+    .update({\r\n+      stock_level: newStock,\r\n+      avg_cost: newAvgCost,\r\n+    })\r\n+    .eq(\"id\", itemId);\r\n+\r\n+  if (updateError) {\r\n+    throw new Error(`Failed to update inventory: ${updateError.message}`);\r\n+  }\r\n+\r\n+  return {\r\n+    itemName: item.item_name,\r\n+    oldStock: currentStock,\r\n+    newStock,\r\n+    oldAvgCost: currentAvgCost,\r\n+    newAvgCost,\r\n+  };\r\n+}\r\n+\r\n export async function addExpense(formData: FormData) {\r\n   const supabase = await createSupabaseServerClient();\r\n \r\n+  const expenseType = formData.get(\"expense_type\") as string;\r\n+  const amount = parseFloat(formData.get(\"amount\") as string);\r\n+  const inventoryItemId = formData.get(\"inventory_item_id\") as string | null;\r\n+  const procurementQuantity = formData.get(\"procurement_quantity\")\r\n+    ? parseFloat(formData.get(\"procurement_quantity\") as string)\r\n+    : null;\r\n+\r\n   const expense = {\r\n-    expense_type: formData.get(\"expense_type\") as string,\r\n-    amount: parseFloat(formData.get(\"amount\") as string),\r\n+    expense_type: expenseType,\r\n+    amount,\r\n     expense_date: formData.get(\"expense_date\") as string,\r\n     status: (formData.get(\"status\") as string) || \"paid\",\r\n     description: formData.get(\"description\") as string,\r\n   };\r\n \r\n-  const { error } = await supabase.from(\"expenses\").insert([expense]);\r\n+  // Step 1: Insert expense record\r\n+  const { error: expenseError } = await supabase.from(\"expenses\").insert([expense]);\r\n \r\n-  if (error) {\r\n-    return { success: false, error: error.message };\r\n+  if (expenseError) {\r\n+    return { success: false, error: expenseError.message };\r\n   }\r\n \r\n+  // Step 2: ERP Bridge - Update inventory if procurement\r\n+  let inventoryUpdate = null;\r\n+  if (inventoryItemId && procurementQuantity && procurementQuantity > 0) {\r\n+    try {\r\n+      inventoryUpdate = await updateInventoryFromPurchase(\r\n+        inventoryItemId,\r\n+        procurementQuantity,\r\n+        amount\r\n+      );\r\n+    } catch (error: any) {\r\n+      return {\r\n+        success: false,\r\n+        error: `Expense logged but inventory update failed: ${error.message}`,\r\n+      };\r\n+    }\r\n+  }\r\n+\r\n+  // Step 3: Revalidate both pages\r\n   revalidatePath(\"/finance\");\r\n-  return { success: true };\r\n+  revalidatePath(\"/inventory\");\r\n+\r\n+  return {\r\n+    success: true,\r\n+    message: inventoryUpdate\r\n+      ? `Expense logged. Inventory updated: ${inventoryUpdate.itemName} ${inventoryUpdate.oldStock} → ${inventoryUpdate.newStock} ${\r\n+          inventoryUpdate.oldAvgCost.toFixed(2)\r\n+        } → ₹${inventoryUpdate.newAvgCost.toFixed(2)}`\r\n+      : \"Expense logged successfully\",\r\n+  };\r\n }\r\n \r\n export async function addLoanTransaction(formData: FormData) {\r\n   const supabase = await createSupabaseServerClient();\r\n"
                }
            ],
            "date": 1763136497224,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport async function addExpense(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const expense = {\r\n    expense_type: formData.get(\"expense_type\") as string,\r\n    amount: parseFloat(formData.get(\"amount\") as string),\r\n    expense_date: formData.get(\"expense_date\") as string,\r\n    status: (formData.get(\"status\") as string) || \"paid\",\r\n    description: formData.get(\"description\") as string,\r\n  };\r\n\r\n  const { error } = await supabase.from(\"expenses\").insert([expense]);\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  revalidatePath(\"/finance\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function addLoanTransaction(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const loanId = formData.get(\"loan_id\") as string;\r\n  const type = formData.get(\"type\") as \"payment\" | \"interest\";\r\n  const amount = parseFloat(formData.get(\"amount\") as string);\r\n\r\n  const transaction = {\r\n    loan_id: loanId,\r\n    type,\r\n    amount,\r\n    date: new Date().toISOString(),\r\n  };\r\n\r\n  const { error: transactionError } = await supabase\r\n    .from(\"loan_transactions\")\r\n    .insert([transaction]);\r\n\r\n  if (transactionError) {\r\n    return { success: false, error: transactionError.message };\r\n  }\r\n\r\n  const { data: loan } = await supabase\r\n    .from(\"loans\")\r\n    .select(\"current_balance\")\r\n    .eq(\"id\", loanId)\r\n    .single();\r\n\r\n  if (!loan) {\r\n    return { success: false, error: \"Loan not found\" };\r\n  }\r\n\r\n  const newBalance =\r\n    type === \"payment\"\r\n      ? loan.current_balance - amount\r\n      : loan.current_balance + amount;\r\n\r\n  const { error: updateError } = await supabase\r\n    .from(\"loans\")\r\n    .update({ current_balance: newBalance })\r\n    .eq(\"id\", loanId);\r\n\r\n  if (updateError) {\r\n    return { success: false, error: updateError.message };\r\n  }\r\n\r\n  revalidatePath(\"/finance\");\r\n  return { success: true };\r\n}\r\n"
        }
    ]
}