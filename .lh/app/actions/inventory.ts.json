{
    "sourceFile": "app/actions/inventory.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763362519344,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763368600004,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -32,9 +32,9 @@\n   const itemId = formData.get(\"item_id\") as string;\r\n   const quantity = parseFloat(formData.get(\"quantity\") as string);\r\n   const reason = formData.get(\"reason\") as string;\r\n \r\n-  // Get current stock level\r\n+  // Get current stock level to validate\r\n   const { data: item, error: fetchError } = await supabase\r\n     .from(\"inventory_items\")\r\n     .select(\"stock_level, item_name\")\r\n     .eq(\"id\", itemId)\r\n@@ -53,24 +53,24 @@\n       error: `Cannot reduce stock below zero. Current: ${item.stock_level}, Requested change: ${quantity}` \r\n     };\r\n   }\r\n \r\n-  // Update stock level\r\n-  const { error: updateError } = await supabase\r\n-    .from(\"inventory_items\")\r\n-    .update({ stock_level: newStockLevel })\r\n-    .eq(\"id\", itemId);\r\n+  // **REFACTORED:** Use stock_movements audit trail instead of direct update\r\n+  // The trigger will automatically update inventory_items.stock_level\r\n+  const { error: insertError } = await supabase\r\n+    .from(\"stock_movements\")\r\n+    .insert({\r\n+      item_id: itemId,\r\n+      quantity_change: quantity,\r\n+      reason: reason || \"Manual adjustment\",\r\n+    });\r\n \r\n-  if (updateError) {\r\n-    return { success: false, error: updateError.message };\r\n+  if (insertError) {\r\n+    return { success: false, error: insertError.message };\r\n   }\r\n \r\n-  // Log the movement (optional: create stock_movements table for audit trail)\r\n-  // For now, we'll just revalidate and return success\r\n-  // Future enhancement: Insert into stock_movements table with timestamp, user, reason\r\n-\r\n   revalidatePath(\"/inventory\");\r\n-  revalidatePath(\"/finance\"); // Revalidate finance page as well since it may show procurement data\r\n+  revalidatePath(\"/inventory/log\"); // Also revalidate the log page\r\n   \r\n   return { \r\n     success: true, \r\n     message: `${item.item_name}: ${item.stock_level} → ${newStockLevel} (${quantity > 0 ? '+' : ''}${quantity})` \r\n"
                },
                {
                    "date": 1765424201534,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -10,8 +10,9 @@\n   const updates = {\r\n     item_name: formData.get(\"item_name\") as string,\r\n     low_stock_threshold: parseFloat(formData.get(\"low_stock_threshold\") as string),\r\n     avg_cost: parseFloat(formData.get(\"avg_cost\") as string),\r\n+    selling_price: parseFloat(formData.get(\"selling_price\") as string),\r\n   };\r\n \r\n   const { error } = await supabase\r\n     .from(\"inventory_items\")\r\n@@ -22,8 +23,9 @@\n     return { success: false, error: error.message };\r\n   }\r\n \r\n   revalidatePath(\"/inventory\");\r\n+  revalidatePath(\"/orders/new\"); // Refresh order form if open\r\n   return { success: true };\r\n }\r\n \r\n export async function createStockMovement(formData: FormData) {\r\n"
                }
            ],
            "date": 1763362519344,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport async function updateInventoryItem(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const itemId = formData.get(\"item_id\") as string;\r\n  const updates = {\r\n    item_name: formData.get(\"item_name\") as string,\r\n    low_stock_threshold: parseFloat(formData.get(\"low_stock_threshold\") as string),\r\n    avg_cost: parseFloat(formData.get(\"avg_cost\") as string),\r\n  };\r\n\r\n  const { error } = await supabase\r\n    .from(\"inventory_items\")\r\n    .update(updates)\r\n    .eq(\"id\", itemId);\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  revalidatePath(\"/inventory\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function createStockMovement(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const itemId = formData.get(\"item_id\") as string;\r\n  const quantity = parseFloat(formData.get(\"quantity\") as string);\r\n  const reason = formData.get(\"reason\") as string;\r\n\r\n  // Get current stock level\r\n  const { data: item, error: fetchError } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"stock_level, item_name\")\r\n    .eq(\"id\", itemId)\r\n    .single();\r\n\r\n  if (fetchError || !item) {\r\n    return { success: false, error: \"Item not found\" };\r\n  }\r\n\r\n  const newStockLevel = item.stock_level + quantity;\r\n\r\n  // Prevent negative stock\r\n  if (newStockLevel < 0) {\r\n    return { \r\n      success: false, \r\n      error: `Cannot reduce stock below zero. Current: ${item.stock_level}, Requested change: ${quantity}` \r\n    };\r\n  }\r\n\r\n  // Update stock level\r\n  const { error: updateError } = await supabase\r\n    .from(\"inventory_items\")\r\n    .update({ stock_level: newStockLevel })\r\n    .eq(\"id\", itemId);\r\n\r\n  if (updateError) {\r\n    return { success: false, error: updateError.message };\r\n  }\r\n\r\n  // Log the movement (optional: create stock_movements table for audit trail)\r\n  // For now, we'll just revalidate and return success\r\n  // Future enhancement: Insert into stock_movements table with timestamp, user, reason\r\n\r\n  revalidatePath(\"/inventory\");\r\n  revalidatePath(\"/finance\"); // Revalidate finance page as well since it may show procurement data\r\n  \r\n  return { \r\n    success: true, \r\n    message: `${item.item_name}: ${item.stock_level} → ${newStockLevel} (${quantity > 0 ? '+' : ''}${quantity})` \r\n  };\r\n}\r\n\r\nexport async function getAllInventoryItems() {\r\n  const supabase = await createSupabaseServerClient();\r\n  \r\n  const { data, error } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"id, item_name, stock_level, unit\")\r\n    .order(\"item_name\", { ascending: true });\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: [] };\r\n  }\r\n\r\n  return { success: true, data: data ?? [] };\r\n}\r\n"
        }
    ]
}