{
    "sourceFile": "app/actions/bottling.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763364745312,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763368599991,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -14,8 +14,11 @@\n  * across multiple SKUs (1L Bottle, 5L Tin, 15L Tin).\r\n  * \r\n  * This implements the \"commingled bulk oil\" model where bottling is\r\n  * decoupled from production batches.\r\n+ * \r\n+ * **REFACTORED:** Now uses stock_movements audit trail instead of direct updates.\r\n+ * This fixes the bug where empty containers and finished goods weren't updating correctly.\r\n  */\r\n export async function createBottlingRun(formData: FormData) {\r\n   const supabase = await createSupabaseServerClient();\r\n \r\n@@ -49,9 +52,11 @@\n     }\r\n \r\n     // Initialize total liters consumed\r\n     let totalLitersConsumed = 0;\r\n-    const updates: { itemId: string; delta: number }[] = [];\r\n+    \r\n+    // Generate bottling run ID for audit trail\r\n+    const bottlingRunId = `BR-${Date.now()}`;\r\n \r\n     // Process each bottling line\r\n     for (const line of lines) {\r\n       if (line.quantity <= 0) continue;\r\n@@ -97,17 +102,40 @@\n           error: `Insufficient empty containers for ${line.sku}. Available: ${emptyContainer.stock_level}, Required: ${line.quantity}`,\r\n         };\r\n       }\r\n \r\n-      // Queue updates\r\n-      updates.push({\r\n-        itemId: emptyContainer.id,\r\n-        delta: -line.quantity, // Decrement empty containers\r\n-      });\r\n-      updates.push({\r\n-        itemId: finishedGood.id,\r\n-        delta: line.quantity, // Increment finished goods\r\n-      });\r\n+      // **BUG FIX:** Use stock_movements instead of direct updates\r\n+      // Insert stock movement for empty containers (decrement)\r\n+      const { error: emptyError } = await supabase\r\n+        .from(\"stock_movements\")\r\n+        .insert({\r\n+          item_id: emptyContainer.id,\r\n+          quantity_change: -line.quantity,\r\n+          reason: `Bottling Run ${bottlingRunId}: ${line.sku} (${line.quantity} units)`,\r\n+        });\r\n+\r\n+      if (emptyError) {\r\n+        return {\r\n+          success: false,\r\n+          error: `Failed to update empty containers for ${line.sku}: ${emptyError.message}`,\r\n+        };\r\n+      }\r\n+\r\n+      // Insert stock movement for finished goods (increment)\r\n+      const { error: finishedError } = await supabase\r\n+        .from(\"stock_movements\")\r\n+        .insert({\r\n+          item_id: finishedGood.id,\r\n+          quantity_change: line.quantity,\r\n+          reason: `Bottling Run ${bottlingRunId}: ${line.sku} (${line.quantity} units)`,\r\n+        });\r\n+\r\n+      if (finishedError) {\r\n+        return {\r\n+          success: false,\r\n+          error: `Failed to update finished goods for ${line.sku}: ${finishedError.message}`,\r\n+        };\r\n+      }\r\n     }\r\n \r\n     // Check if sufficient bulk oil available\r\n     if (bulkOil.stock_level < totalLitersConsumed) {\r\n@@ -116,31 +144,16 @@\n         error: `Insufficient bulk oil. Available: ${bulkOil.stock_level}L, Required: ${totalLitersConsumed}L`,\r\n       };\r\n     }\r\n \r\n-    // Execute all inventory updates in sequence\r\n-    for (const update of updates) {\r\n-      const item = inventoryItems.find((i: any) => i.id === update.itemId);\r\n-      if (!item) continue;\r\n-\r\n-      const { error: updateError } = await supabase\r\n-        .from(\"inventory_items\")\r\n-        .update({ stock_level: item.stock_level + update.delta })\r\n-        .eq(\"id\", update.itemId);\r\n-\r\n-      if (updateError) {\r\n-        return {\r\n-          success: false,\r\n-          error: `Failed to update ${item.item_name}: ${updateError.message}`,\r\n-        };\r\n-      }\r\n-    }\r\n-\r\n-    // Final transaction: Decrement bulk oil\r\n+    // Final transaction: Decrement bulk oil using stock_movements\r\n     const { error: bulkOilError } = await supabase\r\n-      .from(\"inventory_items\")\r\n-      .update({ stock_level: bulkOil.stock_level - totalLitersConsumed })\r\n-      .eq(\"id\", bulkOil.id);\r\n+      .from(\"stock_movements\")\r\n+      .insert({\r\n+        item_id: bulkOil.id,\r\n+        quantity_change: -totalLitersConsumed,\r\n+        reason: `Bottling Run ${bottlingRunId}: Total bulk oil consumed`,\r\n+      });\r\n \r\n     if (bulkOilError) {\r\n       return {\r\n         success: false,\r\n"
                },
                {
                    "date": 1765701483956,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,12 +74,12 @@\n         emptyContainer = findItem(\"1l bottle\") || findItem(\"empty 1l\");\r\n         finishedGood = findItem(\"1l bottle oil\") || findItem(\"finished 1l\");\r\n       } else if (line.sku === \"5L Tin\") {\r\n         emptyContainer = findItem(\"5l tin\") || findItem(\"empty 5l\");\r\n-        finishedGood = findItem(\"5l tin oil\") || findItem(\"finished 5l\");\r\n+        finishedGood = inventoryItems.find((item: any) => item.item_name === \"5L Tin Oil\") || findItem(\"5l tin oil\") || findItem(\"finished 5l\");\r\n       } else if (line.sku === \"15L Tin\") {\r\n         emptyContainer = findItem(\"15l tin\") || findItem(\"empty 15l\");\r\n-        finishedGood = findItem(\"15l tin oil\") || findItem(\"finished 15l\");\r\n+        finishedGood = inventoryItems.find((item: any) => item.item_name === \"15L Tin Oil\") || findItem(\"15l tin oil\") || findItem(\"finished 15l\");\r\n       }\r\n \r\n       // Validate inventory items exist\r\n       if (!emptyContainer) {\r\n"
                }
            ],
            "date": 1763364745312,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\ntype BottlingLine = {\r\n  id: number;\r\n  sku: string;\r\n  quantity: number;\r\n};\r\n\r\n/**\r\n * Creates a new bottling run that converts bulk oil into finished goods\r\n * across multiple SKUs (1L Bottle, 5L Tin, 15L Tin).\r\n * \r\n * This implements the \"commingled bulk oil\" model where bottling is\r\n * decoupled from production batches.\r\n */\r\nexport async function createBottlingRun(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  try {\r\n    // Parse bottling lines from form data\r\n    const linesJson = formData.get(\"bottling_lines\") as string;\r\n    const lines: BottlingLine[] = JSON.parse(linesJson);\r\n\r\n    if (!lines || lines.length === 0) {\r\n      return { success: false, error: \"No bottling lines provided\" };\r\n    }\r\n\r\n    // Get inventory items\r\n    const { data: inventoryItems, error: fetchError } = await supabase\r\n      .from(\"inventory_items\")\r\n      .select(\"id, item_name, stock_level\");\r\n\r\n    if (fetchError || !inventoryItems) {\r\n      return { success: false, error: \"Failed to fetch inventory items\" };\r\n    }\r\n\r\n    const findItem = (name: string) =>\r\n      inventoryItems.find((item: any) =>\r\n        item.item_name.toLowerCase().includes(name.toLowerCase())\r\n      );\r\n\r\n    // Find bulk oil inventory item\r\n    const bulkOil = findItem(\"bulk oil\") || findItem(\"oil\");\r\n    if (!bulkOil) {\r\n      return { success: false, error: \"Bulk oil inventory item not found\" };\r\n    }\r\n\r\n    // Initialize total liters consumed\r\n    let totalLitersConsumed = 0;\r\n    const updates: { itemId: string; delta: number }[] = [];\r\n\r\n    // Process each bottling line\r\n    for (const line of lines) {\r\n      if (line.quantity <= 0) continue;\r\n\r\n      // Extract liters per unit from SKU (e.g., \"1L Bottle\" -> 1)\r\n      const litersPerUnit = parseFloat(line.sku.split(\"L\")[0]) || 0;\r\n      const totalLiters = litersPerUnit * line.quantity;\r\n      totalLitersConsumed += totalLiters;\r\n\r\n      // Find empty container inventory item\r\n      let emptyContainer = null;\r\n      let finishedGood = null;\r\n\r\n      if (line.sku === \"1L Bottle\") {\r\n        emptyContainer = findItem(\"1l bottle\") || findItem(\"empty 1l\");\r\n        finishedGood = findItem(\"1l bottle oil\") || findItem(\"finished 1l\");\r\n      } else if (line.sku === \"5L Tin\") {\r\n        emptyContainer = findItem(\"5l tin\") || findItem(\"empty 5l\");\r\n        finishedGood = findItem(\"5l tin oil\") || findItem(\"finished 5l\");\r\n      } else if (line.sku === \"15L Tin\") {\r\n        emptyContainer = findItem(\"15l tin\") || findItem(\"empty 15l\");\r\n        finishedGood = findItem(\"15l tin oil\") || findItem(\"finished 15l\");\r\n      }\r\n\r\n      // Validate inventory items exist\r\n      if (!emptyContainer) {\r\n        return {\r\n          success: false,\r\n          error: `Empty container inventory item not found for ${line.sku}`,\r\n        };\r\n      }\r\n      if (!finishedGood) {\r\n        return {\r\n          success: false,\r\n          error: `Finished good inventory item not found for ${line.sku}`,\r\n        };\r\n      }\r\n\r\n      // Check if sufficient empty containers available\r\n      if (emptyContainer.stock_level < line.quantity) {\r\n        return {\r\n          success: false,\r\n          error: `Insufficient empty containers for ${line.sku}. Available: ${emptyContainer.stock_level}, Required: ${line.quantity}`,\r\n        };\r\n      }\r\n\r\n      // Queue updates\r\n      updates.push({\r\n        itemId: emptyContainer.id,\r\n        delta: -line.quantity, // Decrement empty containers\r\n      });\r\n      updates.push({\r\n        itemId: finishedGood.id,\r\n        delta: line.quantity, // Increment finished goods\r\n      });\r\n    }\r\n\r\n    // Check if sufficient bulk oil available\r\n    if (bulkOil.stock_level < totalLitersConsumed) {\r\n      return {\r\n        success: false,\r\n        error: `Insufficient bulk oil. Available: ${bulkOil.stock_level}L, Required: ${totalLitersConsumed}L`,\r\n      };\r\n    }\r\n\r\n    // Execute all inventory updates in sequence\r\n    for (const update of updates) {\r\n      const item = inventoryItems.find((i: any) => i.id === update.itemId);\r\n      if (!item) continue;\r\n\r\n      const { error: updateError } = await supabase\r\n        .from(\"inventory_items\")\r\n        .update({ stock_level: item.stock_level + update.delta })\r\n        .eq(\"id\", update.itemId);\r\n\r\n      if (updateError) {\r\n        return {\r\n          success: false,\r\n          error: `Failed to update ${item.item_name}: ${updateError.message}`,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Final transaction: Decrement bulk oil\r\n    const { error: bulkOilError } = await supabase\r\n      .from(\"inventory_items\")\r\n      .update({ stock_level: bulkOil.stock_level - totalLitersConsumed })\r\n      .eq(\"id\", bulkOil.id);\r\n\r\n    if (bulkOilError) {\r\n      return {\r\n        success: false,\r\n        error: `Failed to update bulk oil: ${bulkOilError.message}`,\r\n      };\r\n    }\r\n\r\n    // Revalidate paths\r\n    revalidatePath(\"/inventory\");\r\n    revalidatePath(\"/bottling\");\r\n\r\n    return {\r\n      success: true,\r\n      message: `Bottling run completed! Consumed ${totalLitersConsumed.toFixed(1)}L of bulk oil.`,\r\n    };\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      error: error.message || \"An unexpected error occurred\",\r\n    };\r\n  }\r\n}\r\n"
        }
    ]
}