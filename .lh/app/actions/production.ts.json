{
    "sourceFile": "app/actions/production.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 2,
            "patches": [
                {
                    "date": 1763361124618,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763364745320,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -29,18 +29,17 @@\n \r\n export async function updateProductionPhase(\r\n   batchId: string,\r\n   phaseData: {\r\n-    phase: \"dehusking\" | \"pressing\" | \"bottling\";\r\n+    phase: \"dehusking\" | \"pressing\";\r\n     input_groundnuts_kg?: number;\r\n     output_peanuts_kg?: number;\r\n     output_oil_liters?: number;\r\n     output_oilcake_kg?: number;\r\n     output_husk_kg?: number;\r\n-    bottled_units?: number;\r\n     notes?: string;\r\n   },\r\n-  nextPhase: \"pressing\" | \"bottling\" | \"completed\"\r\n+  nextPhase: \"pressing\" | \"completed\"\r\n ) {\r\n   const supabase = await createSupabaseServerClient();\r\n \r\n   // Get current batch data\r\n@@ -56,9 +55,9 @@\n \r\n   // Update the batch with phase data\r\n   const updateData: any = {\r\n     ...phaseData,\r\n-    phase: nextPhase === \"completed\" ? \"bottling\" : nextPhase,\r\n+    phase: nextPhase,\r\n   };\r\n \r\n   const { error: updateError } = await supabase\r\n     .from(\"production_batches\")\r\n@@ -72,9 +71,10 @@\n   // Run phased inventory transactions\r\n   const inventoryResult = await updatePhasedInventory(\r\n     supabase,\r\n     batch.phase,\r\n-    phaseData\r\n+    phaseData,\r\n+    batch\r\n   );\r\n \r\n   if (!inventoryResult.success) {\r\n     return inventoryResult;\r\n@@ -86,10 +86,11 @@\n }\r\n \r\n async function updatePhasedInventory(\r\n   supabase: any,\r\n-  completedPhase: \"dehusking\" | \"pressing\" | \"bottling\",\r\n-  phaseData: any\r\n+  completedPhase: \"dehusking\" | \"pressing\",\r\n+  phaseData: any,\r\n+  batch: any\r\n ) {\r\n   // Get inventory item IDs\r\n   const { data: inventoryItems } = await supabase\r\n     .from(\"inventory_items\")\r\n@@ -108,10 +109,8 @@\n   const peanuts = findItem(\"peanut\");\r\n   const bulkOil = findItem(\"bulk oil\") || findItem(\"oil\");\r\n   const oilcake = findItem(\"oilcake\");\r\n   const husk = findItem(\"husk\");\r\n-  const bottle1L = findItem(\"1l bottle\");\r\n-  const finishedOil = findItem(\"1l bottle oil\");\r\n \r\n   try {\r\n     if (completedPhase === \"dehusking\") {\r\n       // Phase 1: Groundnuts → Peanuts\r\n@@ -132,9 +131,11 @@\n           })\r\n           .eq(\"id\", peanuts.id);\r\n       }\r\n     } else if (completedPhase === \"pressing\") {\r\n-      // Phase 2: Peanuts → Oil + Oilcake + Husk\r\n+      // Phase 2: Peanuts → Bulk Oil + Oilcake + Husk\r\n+      \r\n+      // Increment outputs\r\n       if (phaseData.output_oil_liters && bulkOil) {\r\n         await supabase\r\n           .from(\"inventory_items\")\r\n           .update({\r\n@@ -160,46 +161,17 @@\n           })\r\n           .eq(\"id\", husk.id);\r\n       }\r\n \r\n-      // Decrement peanuts used (assuming it's tracked in the batch)\r\n-      if (phaseData.output_peanuts_kg && peanuts) {\r\n+      // Decrement peanuts used (from Phase 1 output)\r\n+      if (batch.output_peanuts_kg && peanuts) {\r\n         await supabase\r\n           .from(\"inventory_items\")\r\n           .update({\r\n-            stock_level: peanuts.stock_level - phaseData.output_peanuts_kg,\r\n+            stock_level: peanuts.stock_level - batch.output_peanuts_kg,\r\n           })\r\n           .eq(\"id\", peanuts.id);\r\n       }\r\n-    } else if (completedPhase === \"bottling\") {\r\n-      // Phase 3: Bulk Oil + Bottles → Finished Goods\r\n-      if (phaseData.bottled_units && finishedOil) {\r\n-        await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: finishedOil.stock_level + phaseData.bottled_units,\r\n-          })\r\n-          .eq(\"id\", finishedOil.id);\r\n-      }\r\n-\r\n-      // Decrement bulk oil and bottles\r\n-      if (phaseData.output_oil_liters && bulkOil) {\r\n-        await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: bulkOil.stock_level - phaseData.output_oil_liters,\r\n-          })\r\n-          .eq(\"id\", bulkOil.id);\r\n-      }\r\n-\r\n-      if (phaseData.bottled_units && bottle1L) {\r\n-        await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: bottle1L.stock_level - phaseData.bottled_units,\r\n-          })\r\n-          .eq(\"id\", bottle1L.id);\r\n-      }\r\n     }\r\n \r\n     return { success: true };\r\n   } catch (error: any) {\r\n"
                },
                {
                    "date": 1763368599994,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -113,64 +113,73 @@\n \r\n   try {\r\n     if (completedPhase === \"dehusking\") {\r\n       // Phase 1: Groundnuts → Peanuts\r\n+      // Use stock_movements audit trail instead of direct updates\r\n+      \r\n       if (phaseData.input_groundnuts_kg && groundnuts) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: groundnuts.stock_level - phaseData.input_groundnuts_kg,\r\n-          })\r\n-          .eq(\"id\", groundnuts.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: groundnuts.id,\r\n+            quantity_change: -phaseData.input_groundnuts_kg,\r\n+            reason: `Production: Batch ${batch.batch_code} - Dehusking (consumed)`,\r\n+          });\r\n       }\r\n \r\n       if (phaseData.output_peanuts_kg && peanuts) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: peanuts.stock_level + phaseData.output_peanuts_kg,\r\n-          })\r\n-          .eq(\"id\", peanuts.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: peanuts.id,\r\n+            quantity_change: phaseData.output_peanuts_kg,\r\n+            reason: `Production: Batch ${batch.batch_code} - Dehusking (produced)`,\r\n+          });\r\n       }\r\n     } else if (completedPhase === \"pressing\") {\r\n       // Phase 2: Peanuts → Bulk Oil + Oilcake + Husk\r\n+      // Use stock_movements audit trail instead of direct updates\r\n       \r\n       // Increment outputs\r\n       if (phaseData.output_oil_liters && bulkOil) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: bulkOil.stock_level + phaseData.output_oil_liters,\r\n-          })\r\n-          .eq(\"id\", bulkOil.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: bulkOil.id,\r\n+            quantity_change: phaseData.output_oil_liters,\r\n+            reason: `Production: Batch ${batch.batch_code} - Pressing (bulk oil produced)`,\r\n+          });\r\n       }\r\n \r\n       if (phaseData.output_oilcake_kg && oilcake) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: oilcake.stock_level + phaseData.output_oilcake_kg,\r\n-          })\r\n-          .eq(\"id\", oilcake.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: oilcake.id,\r\n+            quantity_change: phaseData.output_oilcake_kg,\r\n+            reason: `Production: Batch ${batch.batch_code} - Pressing (oilcake byproduct)`,\r\n+          });\r\n       }\r\n \r\n       if (phaseData.output_husk_kg && husk) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: husk.stock_level + phaseData.output_husk_kg,\r\n-          })\r\n-          .eq(\"id\", husk.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: husk.id,\r\n+            quantity_change: phaseData.output_husk_kg,\r\n+            reason: `Production: Batch ${batch.batch_code} - Pressing (husk byproduct)`,\r\n+          });\r\n       }\r\n \r\n       // Decrement peanuts used (from Phase 1 output)\r\n       if (batch.output_peanuts_kg && peanuts) {\r\n         await supabase\r\n-          .from(\"inventory_items\")\r\n-          .update({\r\n-            stock_level: peanuts.stock_level - batch.output_peanuts_kg,\r\n-          })\r\n-          .eq(\"id\", peanuts.id);\r\n+          .from(\"stock_movements\")\r\n+          .insert({\r\n+            item_id: peanuts.id,\r\n+            quantity_change: -batch.output_peanuts_kg,\r\n+            reason: `Production: Batch ${batch.batch_code} - Pressing (consumed)`,\r\n+          });\r\n       }\r\n     }\r\n \r\n     return { success: true };\r\n"
                }
            ],
            "date": 1763361124618,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport async function createProductionBatch(formData: FormData) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const batch = {\r\n    batch_code: formData.get(\"batch_code\") as string,\r\n    farmer_name: formData.get(\"farmer_name\") as string,\r\n    batch_date: formData.get(\"batch_date\") as string,\r\n    phase: \"dehusking\", // Default to Phase 1\r\n  };\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"production_batches\")\r\n    .insert([batch])\r\n    .select()\r\n    .single();\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message };\r\n  }\r\n\r\n  revalidatePath(\"/production\");\r\n  return { success: true, data };\r\n}\r\n\r\nexport async function updateProductionPhase(\r\n  batchId: string,\r\n  phaseData: {\r\n    phase: \"dehusking\" | \"pressing\" | \"bottling\";\r\n    input_groundnuts_kg?: number;\r\n    output_peanuts_kg?: number;\r\n    output_oil_liters?: number;\r\n    output_oilcake_kg?: number;\r\n    output_husk_kg?: number;\r\n    bottled_units?: number;\r\n    notes?: string;\r\n  },\r\n  nextPhase: \"pressing\" | \"bottling\" | \"completed\"\r\n) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  // Get current batch data\r\n  const { data: batch, error: fetchError } = await supabase\r\n    .from(\"production_batches\")\r\n    .select(\"*\")\r\n    .eq(\"id\", batchId)\r\n    .single();\r\n\r\n  if (fetchError || !batch) {\r\n    return { success: false, error: \"Batch not found\" };\r\n  }\r\n\r\n  // Update the batch with phase data\r\n  const updateData: any = {\r\n    ...phaseData,\r\n    phase: nextPhase === \"completed\" ? \"bottling\" : nextPhase,\r\n  };\r\n\r\n  const { error: updateError } = await supabase\r\n    .from(\"production_batches\")\r\n    .update(updateData)\r\n    .eq(\"id\", batchId);\r\n\r\n  if (updateError) {\r\n    return { success: false, error: updateError.message };\r\n  }\r\n\r\n  // Run phased inventory transactions\r\n  const inventoryResult = await updatePhasedInventory(\r\n    supabase,\r\n    batch.phase,\r\n    phaseData\r\n  );\r\n\r\n  if (!inventoryResult.success) {\r\n    return inventoryResult;\r\n  }\r\n\r\n  revalidatePath(\"/production\");\r\n  revalidatePath(\"/inventory\");\r\n  return { success: true };\r\n}\r\n\r\nasync function updatePhasedInventory(\r\n  supabase: any,\r\n  completedPhase: \"dehusking\" | \"pressing\" | \"bottling\",\r\n  phaseData: any\r\n) {\r\n  // Get inventory item IDs\r\n  const { data: inventoryItems } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"id, item_name, stock_level\");\r\n\r\n  if (!inventoryItems) {\r\n    return { success: false, error: \"Failed to fetch inventory\" };\r\n  }\r\n\r\n  const findItem = (name: string) =>\r\n    inventoryItems.find((item: any) =>\r\n      item.item_name.toLowerCase().includes(name.toLowerCase())\r\n    );\r\n\r\n  const groundnuts = findItem(\"groundnut\");\r\n  const peanuts = findItem(\"peanut\");\r\n  const bulkOil = findItem(\"bulk oil\") || findItem(\"oil\");\r\n  const oilcake = findItem(\"oilcake\");\r\n  const husk = findItem(\"husk\");\r\n  const bottle1L = findItem(\"1l bottle\");\r\n  const finishedOil = findItem(\"1l bottle oil\");\r\n\r\n  try {\r\n    if (completedPhase === \"dehusking\") {\r\n      // Phase 1: Groundnuts → Peanuts\r\n      if (phaseData.input_groundnuts_kg && groundnuts) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: groundnuts.stock_level - phaseData.input_groundnuts_kg,\r\n          })\r\n          .eq(\"id\", groundnuts.id);\r\n      }\r\n\r\n      if (phaseData.output_peanuts_kg && peanuts) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: peanuts.stock_level + phaseData.output_peanuts_kg,\r\n          })\r\n          .eq(\"id\", peanuts.id);\r\n      }\r\n    } else if (completedPhase === \"pressing\") {\r\n      // Phase 2: Peanuts → Oil + Oilcake + Husk\r\n      if (phaseData.output_oil_liters && bulkOil) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: bulkOil.stock_level + phaseData.output_oil_liters,\r\n          })\r\n          .eq(\"id\", bulkOil.id);\r\n      }\r\n\r\n      if (phaseData.output_oilcake_kg && oilcake) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: oilcake.stock_level + phaseData.output_oilcake_kg,\r\n          })\r\n          .eq(\"id\", oilcake.id);\r\n      }\r\n\r\n      if (phaseData.output_husk_kg && husk) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: husk.stock_level + phaseData.output_husk_kg,\r\n          })\r\n          .eq(\"id\", husk.id);\r\n      }\r\n\r\n      // Decrement peanuts used (assuming it's tracked in the batch)\r\n      if (phaseData.output_peanuts_kg && peanuts) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: peanuts.stock_level - phaseData.output_peanuts_kg,\r\n          })\r\n          .eq(\"id\", peanuts.id);\r\n      }\r\n    } else if (completedPhase === \"bottling\") {\r\n      // Phase 3: Bulk Oil + Bottles → Finished Goods\r\n      if (phaseData.bottled_units && finishedOil) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: finishedOil.stock_level + phaseData.bottled_units,\r\n          })\r\n          .eq(\"id\", finishedOil.id);\r\n      }\r\n\r\n      // Decrement bulk oil and bottles\r\n      if (phaseData.output_oil_liters && bulkOil) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: bulkOil.stock_level - phaseData.output_oil_liters,\r\n          })\r\n          .eq(\"id\", bulkOil.id);\r\n      }\r\n\r\n      if (phaseData.bottled_units && bottle1L) {\r\n        await supabase\r\n          .from(\"inventory_items\")\r\n          .update({\r\n            stock_level: bottle1L.stock_level - phaseData.bottled_units,\r\n          })\r\n          .eq(\"id\", bottle1L.id);\r\n      }\r\n    }\r\n\r\n    return { success: true };\r\n  } catch (error: any) {\r\n    return { success: false, error: error.message };\r\n  }\r\n}\r\n\r\nexport async function getProductionBatch(batchId: string) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"production_batches\")\r\n    .select(\"*\")\r\n    .eq(\"id\", batchId)\r\n    .single();\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: null };\r\n  }\r\n\r\n  return { success: true, data };\r\n}\r\n"
        }
    ]
}