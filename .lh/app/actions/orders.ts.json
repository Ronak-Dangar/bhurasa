{
    "sourceFile": "app/actions/orders.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1763302822984,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1763302822984,
            "name": "Commit-0",
            "content": "\"use server\";\r\n\r\nimport { createSupabaseServerClient } from \"@/lib/supabase/server\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\nexport async function createOrder(formData: {\r\n  customerId: string;\r\n  paymentStatus: \"cod\" | \"prepaid\";\r\n  deliveryAgentId?: string;\r\n  items: Array<{\r\n    productId: string;\r\n    productName: string;\r\n    quantity: number;\r\n    unitPrice: number;\r\n  }>;\r\n}) {\r\n  const supabase = await createSupabaseServerClient();\r\n\r\n  // Calculate totals\r\n  const totalAmount = formData.items.reduce(\r\n    (sum, item) => sum + item.quantity * item.unitPrice,\r\n    0\r\n  );\r\n\r\n  // Calculate total liters (assuming product names contain size info)\r\n  const totalLiters = formData.items.reduce((sum, item) => {\r\n    // Extract liters from product name (e.g., \"1L Bottle Oil\" -> 1)\r\n    const literMatch = item.productName.match(/(\\d+)L/i);\r\n    const liters = literMatch ? parseInt(literMatch[1]) : 1;\r\n    return sum + liters * item.quantity;\r\n  }, 0);\r\n\r\n  // Create the order\r\n  const { data: order, error: orderError } = await supabase\r\n    .from(\"orders\")\r\n    .insert([\r\n      {\r\n        customer_id: formData.customerId,\r\n        status: \"pending\",\r\n        payment_status: formData.paymentStatus,\r\n        total_amount: totalAmount,\r\n        total_liters: totalLiters,\r\n        assigned_agent: formData.deliveryAgentId || null,\r\n      },\r\n    ])\r\n    .select()\r\n    .single();\r\n\r\n  if (orderError) {\r\n    return { success: false, error: orderError.message };\r\n  }\r\n\r\n  // Create order items\r\n  const orderItems = formData.items.map((item) => ({\r\n    order_id: order.id,\r\n    product_id: item.productId,\r\n    product_name: item.productName,\r\n    quantity: item.quantity,\r\n    unit_price: item.unitPrice,\r\n  }));\r\n\r\n  const { error: itemsError } = await supabase\r\n    .from(\"order_items\")\r\n    .insert(orderItems);\r\n\r\n  if (itemsError) {\r\n    // Rollback order if items fail\r\n    await supabase.from(\"orders\").delete().eq(\"id\", order.id);\r\n    return { success: false, error: itemsError.message };\r\n  }\r\n\r\n  // Create delivery assignment if agent is assigned\r\n  if (formData.deliveryAgentId) {\r\n    await supabase.from(\"delivery_assignments\").insert([\r\n      {\r\n        order_id: order.id,\r\n        delivery_agent_id: formData.deliveryAgentId,\r\n        scheduled_for: new Date().toISOString(),\r\n      },\r\n    ]);\r\n  }\r\n\r\n  revalidatePath(\"/orders/new\");\r\n  revalidatePath(\"/\");\r\n  return { success: true, data: order };\r\n}\r\n\r\nexport async function getAllCustomersForDropdown() {\r\n  const supabase = await createSupabaseServerClient();\r\n  \r\n  const { data, error } = await supabase\r\n    .from(\"customers\")\r\n    .select(\"id, name, phone, address, family_size, status\")\r\n    .order(\"name\", { ascending: true });\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: [] };\r\n  }\r\n\r\n  return { success: true, data };\r\n}\r\n\r\nexport async function getAllInventoryItems() {\r\n  const supabase = await createSupabaseServerClient();\r\n  \r\n  const { data, error } = await supabase\r\n    .from(\"inventory_items\")\r\n    .select(\"*\")\r\n    .eq(\"item_type\", \"finished_good\")\r\n    .gt(\"stock_level\", 0)\r\n    .order(\"item_name\", { ascending: true });\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: [] };\r\n  }\r\n\r\n  return { success: true, data };\r\n}\r\n\r\nexport async function getDeliveryAgents() {\r\n  const supabase = await createSupabaseServerClient();\r\n  \r\n  const { data, error } = await supabase\r\n    .from(\"profiles\")\r\n    .select(\"id, full_name, role\")\r\n    .eq(\"role\", \"delivery_agent\")\r\n    .order(\"full_name\", { ascending: true });\r\n\r\n  if (error) {\r\n    return { success: false, error: error.message, data: [] };\r\n  }\r\n\r\n  return { success: true, data };\r\n}\r\n"
        }
    ]
}