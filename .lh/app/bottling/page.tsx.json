{
    "sourceFile": "app/bottling/page.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763364745312,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763368599998,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,10 +1,11 @@\n \"use client\";\r\n \r\n-import { useState } from \"react\";\r\n+import { useState, useEffect } from \"react\";\r\n import { Card } from \"@/components/ui/card\";\r\n import { Plus, Trash2 } from \"lucide-react\";\r\n import { createBottlingRun } from \"@/app/actions/bottling\";\r\n+import { createSupabaseClient } from \"@/lib/supabase/client\";\r\n \r\n type BottlingLine = {\r\n   id: number;\r\n   sku: string;\r\n@@ -18,11 +19,54 @@\n   const [loading, setLoading] = useState(false);\r\n   const [error, setError] = useState<string | null>(null);\r\n   const [success, setSuccess] = useState<string | null>(null);\r\n   const [nextId, setNextId] = useState(2);\r\n+  const [availableBulkOil, setAvailableBulkOil] = useState<number | null>(null);\r\n+  const [loadingStock, setLoadingStock] = useState(true);\r\n \r\n+  const supabase = createSupabaseClient();\r\n   const skuOptions = [\"1L Bottle\", \"5L Tin\", \"15L Tin\"];\r\n \r\n+  // Fetch available bulk oil stock\r\n+  useEffect(() => {\r\n+    const fetchBulkOilStock = async () => {\r\n+      setLoadingStock(true);\r\n+      const { data: inventoryItems } = await supabase\r\n+        .from(\"inventory_items\")\r\n+        .select(\"id, item_name, stock_level\");\r\n+\r\n+      if (inventoryItems) {\r\n+        const bulkOil = inventoryItems.find((item: any) =>\r\n+          item.item_name.toLowerCase().includes(\"bulk oil\") ||\r\n+          (item.item_name.toLowerCase().includes(\"oil\") && !item.item_name.toLowerCase().includes(\"bottle\"))\r\n+        );\r\n+\r\n+        if (bulkOil) {\r\n+          setAvailableBulkOil(bulkOil.stock_level);\r\n+        }\r\n+      }\r\n+      setLoadingStock(false);\r\n+    };\r\n+\r\n+    fetchBulkOilStock();\r\n+\r\n+    // Subscribe to real-time updates\r\n+    const channel = supabase\r\n+      .channel(\"bulk-oil-updates\")\r\n+      .on(\r\n+        \"postgres_changes\",\r\n+        { event: \"*\", schema: \"public\", table: \"inventory_items\" },\r\n+        () => {\r\n+          fetchBulkOilStock();\r\n+        }\r\n+      )\r\n+      .subscribe();\r\n+\r\n+    return () => {\r\n+      supabase.removeChannel(channel);\r\n+    };\r\n+  }, []);\r\n+\r\n   const addLine = () => {\r\n     setLines([...lines, { id: nextId, sku: \"1L Bottle\", quantity: 0 }]);\r\n     setNextId(nextId + 1);\r\n   };\r\n@@ -91,8 +135,37 @@\n           Convert bulk oil into finished goods across multiple SKUs.\r\n         </p>\r\n       </div>\r\n \r\n+      {/* Available Bulk Oil Display */}\r\n+      <Card title=\"Available Inventory\">\r\n+        <div className=\"flex items-center justify-between rounded-lg border border-emerald-200 bg-emerald-50/70 p-4 dark:border-emerald-900/40 dark:bg-emerald-950/30\">\r\n+          <div>\r\n+            <p className=\"text-sm font-medium text-emerald-800 dark:text-emerald-200\">\r\n+              Available Bulk Oil\r\n+            </p>\r\n+            {loadingStock ? (\r\n+              <p className=\"mt-1 text-xs text-emerald-600/80 dark:text-emerald-200/70\">\r\n+                Loading...\r\n+              </p>\r\n+            ) : (\r\n+              <p className=\"mt-1 text-xs text-emerald-600/80 dark:text-emerald-200/70\">\r\n+                Real-time stock level from inventory\r\n+              </p>\r\n+            )}\r\n+          </div>\r\n+          <div className=\"text-right\">\r\n+            {loadingStock ? (\r\n+              <div className=\"h-8 w-24 animate-pulse rounded bg-emerald-200 dark:bg-emerald-900\"></div>\r\n+            ) : (\r\n+              <p className=\"text-3xl font-bold text-emerald-700 dark:text-emerald-100\">\r\n+                {availableBulkOil !== null ? availableBulkOil.toFixed(1) : \"---\"} L\r\n+              </p>\r\n+            )}\r\n+          </div>\r\n+        </div>\r\n+      </Card>\r\n+\r\n       <Card title=\"Start New Bottling Run\">\r\n         <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n           {/* Success Message */}\r\n           {success && (\r\n"
                }
            ],
            "date": 1763364745312,
            "name": "Commit-0",
            "content": "\"use client\";\r\n\r\nimport { useState } from \"react\";\r\nimport { Card } from \"@/components/ui/card\";\r\nimport { Plus, Trash2 } from \"lucide-react\";\r\nimport { createBottlingRun } from \"@/app/actions/bottling\";\r\n\r\ntype BottlingLine = {\r\n  id: number;\r\n  sku: string;\r\n  quantity: number;\r\n};\r\n\r\nexport default function BottlingPage() {\r\n  const [lines, setLines] = useState<BottlingLine[]>([\r\n    { id: 1, sku: \"1L Bottle\", quantity: 0 },\r\n  ]);\r\n  const [loading, setLoading] = useState(false);\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [success, setSuccess] = useState<string | null>(null);\r\n  const [nextId, setNextId] = useState(2);\r\n\r\n  const skuOptions = [\"1L Bottle\", \"5L Tin\", \"15L Tin\"];\r\n\r\n  const addLine = () => {\r\n    setLines([...lines, { id: nextId, sku: \"1L Bottle\", quantity: 0 }]);\r\n    setNextId(nextId + 1);\r\n  };\r\n\r\n  const removeLine = (id: number) => {\r\n    if (lines.length > 1) {\r\n      setLines(lines.filter((line) => line.id !== id));\r\n    }\r\n  };\r\n\r\n  const updateLine = (id: number, field: \"sku\" | \"quantity\", value: string | number) => {\r\n    setLines(\r\n      lines.map((line) =>\r\n        line.id === id ? { ...line, [field]: value } : line\r\n      )\r\n    );\r\n  };\r\n\r\n  const calculateTotalLiters = () => {\r\n    return lines.reduce((total, line) => {\r\n      const litersPerUnit = parseFloat(line.sku.split(\"L\")[0]) || 0;\r\n      return total + litersPerUnit * line.quantity;\r\n    }, 0);\r\n  };\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    setError(null);\r\n    setSuccess(null);\r\n\r\n    // Validate that all quantities are positive\r\n    const hasInvalidQuantity = lines.some((line) => line.quantity <= 0);\r\n    if (hasInvalidQuantity) {\r\n      setError(\"All quantities must be greater than 0\");\r\n      setLoading(false);\r\n      return;\r\n    }\r\n\r\n    const formData = new FormData();\r\n    formData.append(\"bottling_lines\", JSON.stringify(lines));\r\n\r\n    const result = await createBottlingRun(formData);\r\n\r\n    if (result.success) {\r\n      setSuccess(result.message || \"Bottling run completed successfully!\");\r\n      // Reset form\r\n      setLines([{ id: nextId, sku: \"1L Bottle\", quantity: 0 }]);\r\n      setNextId(nextId + 1);\r\n    } else {\r\n      setError(result.error || \"Failed to create bottling run\");\r\n    }\r\n\r\n    setLoading(false);\r\n  };\r\n\r\n  const totalLiters = calculateTotalLiters();\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div>\r\n        <h2 className=\"text-2xl font-semibold text-zinc-900 dark:text-zinc-100\">\r\n          Bottling Module\r\n        </h2>\r\n        <p className=\"mt-1 text-sm text-zinc-500 dark:text-zinc-400\">\r\n          Convert bulk oil into finished goods across multiple SKUs.\r\n        </p>\r\n      </div>\r\n\r\n      <Card title=\"Start New Bottling Run\">\r\n        <form onSubmit={handleSubmit} className=\"space-y-6\">\r\n          {/* Success Message */}\r\n          {success && (\r\n            <div className=\"rounded-lg bg-emerald-50 p-4 text-sm text-emerald-700 dark:bg-emerald-900/20 dark:text-emerald-400\">\r\n              {success}\r\n            </div>\r\n          )}\r\n\r\n          {/* Error Message */}\r\n          {error && (\r\n            <div className=\"rounded-lg bg-rose-50 p-4 text-sm text-rose-700 dark:bg-rose-900/20 dark:text-rose-400\">\r\n              {error}\r\n            </div>\r\n          )}\r\n\r\n          {/* Bottling Lines */}\r\n          <div className=\"space-y-3\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <label className=\"text-sm font-medium text-zinc-900 dark:text-zinc-100\">\r\n                Bottling Lines\r\n              </label>\r\n              <button\r\n                type=\"button\"\r\n                onClick={addLine}\r\n                className=\"flex items-center gap-1 rounded-lg bg-emerald-600 px-3 py-1.5 text-xs font-semibold text-white hover:bg-emerald-500\"\r\n              >\r\n                <Plus size={14} />\r\n                Add Line\r\n              </button>\r\n            </div>\r\n\r\n            {lines.map((line, index) => (\r\n              <div\r\n                key={line.id}\r\n                className=\"flex items-center gap-3 rounded-lg border border-zinc-200 bg-zinc-50 p-3 dark:border-zinc-800 dark:bg-zinc-900/50\"\r\n              >\r\n                <span className=\"text-sm font-medium text-zinc-500 dark:text-zinc-400\">\r\n                  {index + 1}.\r\n                </span>\r\n\r\n                {/* SKU Dropdown */}\r\n                <select\r\n                  value={line.sku}\r\n                  onChange={(e) => updateLine(line.id, \"sku\", e.target.value)}\r\n                  className=\"flex-1 rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100\"\r\n                >\r\n                  {skuOptions.map((sku) => (\r\n                    <option key={sku} value={sku}>\r\n                      {sku}\r\n                    </option>\r\n                  ))}\r\n                </select>\r\n\r\n                {/* Quantity Input */}\r\n                <input\r\n                  type=\"number\"\r\n                  min=\"0\"\r\n                  value={line.quantity}\r\n                  onChange={(e) =>\r\n                    updateLine(line.id, \"quantity\", parseInt(e.target.value) || 0)\r\n                  }\r\n                  placeholder=\"Qty\"\r\n                  className=\"w-24 rounded-lg border border-zinc-300 bg-white px-3 py-2 text-sm text-zinc-900 shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 dark:border-zinc-700 dark:bg-zinc-800 dark:text-zinc-100\"\r\n                />\r\n\r\n                {/* Liters Calculation */}\r\n                <span className=\"text-sm text-zinc-500 dark:text-zinc-400\">\r\n                  = {(parseFloat(line.sku.split(\"L\")[0]) || 0) * line.quantity} L\r\n                </span>\r\n\r\n                {/* Remove Button */}\r\n                <button\r\n                  type=\"button\"\r\n                  onClick={() => removeLine(line.id)}\r\n                  disabled={lines.length === 1}\r\n                  className=\"rounded-lg p-2 text-zinc-500 hover:bg-zinc-200 hover:text-rose-600 disabled:opacity-30 disabled:hover:bg-transparent dark:hover:bg-zinc-800\"\r\n                >\r\n                  <Trash2 size={16} />\r\n                </button>\r\n              </div>\r\n            ))}\r\n          </div>\r\n\r\n          {/* Total Summary */}\r\n          <div className=\"rounded-lg border border-blue-200 bg-blue-50/70 p-4 dark:border-blue-900/40 dark:bg-blue-950/30\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <span className=\"text-sm font-medium text-blue-800 dark:text-blue-200\">\r\n                Total Bulk Oil Required\r\n              </span>\r\n              <span className=\"text-2xl font-semibold text-blue-700 dark:text-blue-100\">\r\n                {totalLiters.toFixed(1)} L\r\n              </span>\r\n            </div>\r\n            <p className=\"mt-1 text-xs text-blue-600/80 dark:text-blue-200/70\">\r\n              This amount will be deducted from your bulk oil inventory\r\n            </p>\r\n          </div>\r\n\r\n          {/* Submit Button */}\r\n          <div className=\"flex justify-end\">\r\n            <button\r\n              type=\"submit\"\r\n              disabled={loading || totalLiters === 0}\r\n              className=\"rounded-lg bg-emerald-600 px-6 py-2.5 text-sm font-semibold text-white shadow hover:bg-emerald-500 disabled:opacity-50\"\r\n            >\r\n              {loading ? \"Processing...\" : \"Start Bottling Run\"}\r\n            </button>\r\n          </div>\r\n        </form>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n"
        }
    ]
}